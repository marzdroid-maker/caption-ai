<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI Caption + Hashtag Generator</title>
  <style>
    :root {
      --primary: #3b82f6;
      --primary-dark: #2563eb;
      --gray: #6b7280;
      --light: #f3f4f6;
      --border: #e5e7eb;
      --placeholder: #9ca3af;
      --success: #10b981;
      --success-dark: #059669;
      --error: #ef4444;
      --warning: #f59e0b;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      color: #111;
      min-height: 100vh;
      padding: 2rem 1rem;
    }
    .container { max-width: 600px; margin: 0 auto; }
    h1 {
      text-align: center;
      color: var(--primary-dark);
      margin-bottom: 0.5rem;
      font-size: 1.8rem;
    }
    .tabs {
        display: flex;
        margin-bottom: 1.5rem;
        border-radius: 8px;
        background: white;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        overflow: hidden;
    }
    .tab-btn {
        flex: 1;
        padding: 0.75rem 0;
        text-align: center;
        border: none;
        background: transparent;
        font-weight: 600;
        font-size: 1rem;
        cursor: pointer;
        transition: color 0.2s, background-color 0.2s;
        position: relative;
    }
    .tab-btn.active {
        color: var(--primary-dark);
        background: var(--light);
    }
    .tab-btn:not(.active):hover {
        background: #f0f0f0;
    }
    .tab-btn.pro-badge::after {
        content: "PRO";
        position: absolute;
        top: 2px;
        right: 4px;
        background: var(--warning);
        color: white;
        font-size: 0.6rem;
        padding: 1px 4px;
        border-radius: 4px;
        font-weight: 700;
    }
    .card {
      background: white;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      margin-bottom: 1.5rem;
    }
    .form-group { margin-bottom: 1rem; }
    label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.3rem;
      color: #333;
    }
    textarea, select, input[type="text"] {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    textarea:focus, select:focus, input[type="text"]:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
      outline: none;
    }
    textarea { min-height: 100px; resize: vertical; }
    .btn {
      width: 100%;
      padding: 0.75rem 1rem;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      transition: background-color 0.2s, opacity 0.2s;
      background: var(--primary);
      color: white;
    }
    .btn:hover { background: var(--primary-dark); }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }

    /* Results */
    #loading {
      text-align: center;
      padding: 2rem;
      font-size: 1.1rem;
      color: var(--gray);
    }
    #output {
      white-space: pre-wrap;
      padding: 1rem;
      background: var(--light);
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-top: 1rem;
      font-size: 0.95rem;
      line-height: 1.4;
    }
    .result-actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 0.75rem;
    }
    #copyBtn {
      width: auto;
      padding: 0.5rem 1rem;
      background: var(--success);
      font-weight: 600;
      font-size: 0.9rem;
    }
    #copyBtn:hover { background: var(--success-dark); }
    #copyBtn.copied { background: var(--gray); }

    /* Paywall Styling */
    .paywall-overlay {
      background: rgba(255, 255, 255, 0.9);
      padding: 1.5rem;
      border-radius: 12px;
      border: 2px dashed var(--warning);
      text-align: center;
      margin-top: 1rem;
      z-index: 10;
    }
    .paywall-overlay p {
      margin-bottom: 1rem;
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--primary-dark);
    }
    .paywall-overlay .btn {
      background: var(--warning);
      width: auto;
      padding: 0.75rem 2rem;
    }
    .paywall-overlay .btn:hover {
      background: #e58d00; 
    }
    
    /* Templates Styling */
    .templates-section { margin-top: 1.5rem; }
    .templates-section h2 {
      font-size: 1.2rem;
      margin-bottom: 1rem;
      color: #1f2937;
    }
    #templateGrid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: 0.75rem;
    }
    .templateBtn {
      background: var(--light);
      border: 1px solid var(--border);
      padding: 0.75rem;
      border-radius: 8px;
      font-size: 0.85rem;
      text-align: left;
      cursor: pointer;
      transition: background 0.2s, border-color 0.2s;
      font-weight: 500;
    }
    .templateBtn:hover {
      background: #e5e7eb;
      border-color: var(--primary);
    }
    .templateBtn strong { display: block; margin-bottom: 0.2rem; color: var(--primary-dark); font-weight: 700; }
    .templateTeaser {
        text-align: center;
        padding: 1.5rem;
        background: var(--light);
        border-radius: 12px;
        margin-top: 1.5rem;
    }
    .templateTeaser .btn {
        width: auto;
        padding: 0.5rem 1.5rem;
        background: var(--warning);
        margin-top: 1rem;
    }
    
    .pagination {
        display: flex;
        justify-content: center;
        margin-top: 1rem;
    }
    .pagination button {
        padding: 0.5rem 1rem;
        margin: 0 0.5rem;
        border: 1px solid var(--border);
        border-radius: 8px;
        background: white;
        cursor: pointer;
        font-weight: 600;
    }
    .pagination button.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }

    /* Analysis Result Box */
    .analysis-card {
        text-align: center;
        padding: 1.5rem;
        margin-top: 1.5rem;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }
    .analysis-score {
        font-size: 4rem;
        font-weight: 900;
        color: var(--primary-dark);
        line-height: 1;
        margin: 0.5rem 0 1.5rem;
        transition: color 0.3s;
    }
    .analysis-score.boosted {
        color: var(--success); /* Change color to green for the boost */
    }
    .analysis-detail {
        text-align: left;
        padding: 1rem;
        background: var(--light);
        border-radius: 8px;
        margin-bottom: 1rem;
    }
    .analysis-detail p {
        margin-bottom: 0.75rem;
        font-size: 0.95rem;
        line-height: 1.4;
    }
    .analysis-detail strong {
        color: #1f2937;
        font-weight: 700;
        display: block;
        margin-bottom: 0.2rem;
    }
    #analyzeAgainBtn {
        background: var(--gray);
        font-weight: 600;
        font-size: 0.9rem;
        width: 100%;
        margin-top: 0.5rem;
    }
    #analyzeAgainBtn:hover {
        background: #4b5563;
    }
    
    /* Emoji Picker Styles */
    #emojiPickerBtn {
        width: auto;
        padding: 0.4rem 0.8rem;
        background: var(--warning);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        cursor: pointer;
        margin-top: 0.5rem;
        display: block;
    }
    #emojiPicker {
        position: absolute;
        top: 100%;
        left: 0;
        z-index: 20;
        background: white;
        border: 1px solid var(--border);
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        display: none; /* Hidden by default */
        flex-direction: column;
        width: 100%;
        max-width: 300px;
        max-height: 350px;
        overflow: hidden;
    }
    .emoji-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem;
        border-bottom: 1px solid var(--border);
    }
    .emoji-header h4 {
        margin: 0;
        font-size: 1rem;
        color: #333;
    }
    #closePicker {
        background: none;
        border: none;
        font-size: 1.2rem;
        cursor: pointer;
        color: var(--gray);
    }
    #emojiGrid {
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        gap: 0.5rem;
        padding: 1rem;
        overflow-y: auto;
    }
    #emojiGrid button {
        background: var(--light);
        border: 1px solid transparent;
        border-radius: 6px;
        padding: 0.5rem 0;
        font-size: 1.2rem;
        cursor: pointer;
        transition: background 0.1s, border-color 0.1s;
    }
    #emojiGrid button:hover {
        background: #e5e7eb;
        border-color: var(--primary);
    }
    .emoji-container {
        position: relative;
    }

    .hidden { display: none !important; }

    @media (max-width: 450px) {
        h1 { font-size: 1.5rem; }
        .card { padding: 1rem; }
        .tabs { margin-bottom: 1rem; }
        .tab-btn { font-size: 0.9rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>AI Caption + Hashtag Generator</h1>
    <p style="text-align: center; color: var(--gray); margin-bottom: 1rem;">Generate scroll-stopping content in seconds.</p>

    <div class="tabs">
        <button id="generateTabBtn" class="tab-btn active">Caption Generator</button>
        <button id="analyzeTabBtn" class="tab-btn pro-badge">Analyze Competitor (Pro)</button>
    </div>

    <div id="generateContent" class="tab-content">
        <div class="card">
            <form id="captionForm">
                <div class="form-group">
                    <label for="idea">Post Idea / Topic</label>
                    <textarea id="idea" placeholder="e.g., Launching a new coffee flavor, or 5 steps to better marketing." required></textarea>
                    <div class="emoji-container">
                        <button type="button" id="emojiPickerBtn">Insert Emoji</button>
                        <div id="emojiPicker">
                            <div class="emoji-header">
                                <h4>Common Emojis</h4>
                                <button type="button" id="closePicker">√ó</button>
                            </div>
                            <div id="emojiGrid">
                                </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="platform">Platform</label>
                    <select id="platform" required>
                        <option value="">Select a platform</option>
                        <option value="Instagram">Instagram (Reel/Post)</option>
                        <option value="TikTok">TikTok</option>
                        <option value="LinkedIn">LinkedIn</option>
                        <option value="Twitter">X / Twitter</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="tone">Tone</label>
                    <select id="tone" required>
                        <option value="Informative">Informative</option>
                        <option value="Engaging">Engaging / Fun</option>
                        <option value="Professional">Professional / Serious</option>
                        <option value="Sarcastic">Sarcastic / Edgy</option>
                    </select>
                </div>
                
                <button type="submit" id="generateBtn" class="btn">Generate Captions</button>
            </form>

            <div id="loading" class="hidden">
                <p>Generating your captions and hashtags...</p>
            </div>

            <div id="result" class="hidden">
                <div class="result-actions">
                    <button id="copyBtn">Copy All</button>
                </div>
                <pre id="output"></pre>
            </div>
            
            <div id="paywall" class="paywall-overlay hidden">
                <p>You've used your 3 free generations. Unlock **unlimited** generations and the **Viral Swipe File** by subscribing to Pro!</p>
                <button id="subscribeBtn" class="btn">Go Pro Now</button>
            </div>
        </div>

        <div class="templates-section">
            <h2 style="display: flex; align-items: center;"><span style="color: var(--success); margin-right: 0.5rem;">&#10003;</span> Viral Swipe File (Pro)</h2>
            
            <div id="templateTeaser" class="templateTeaser">
                <p style="font-size: 1.1rem; font-weight: 600; color: var(--primary-dark);">Unlock 20+ viral content templates!</p>
                <button id="unlockTemplatesBtn" class="btn">Unlock Templates</button>
            </div>

            <div id="templateContainer" class="hidden">
                <div id="templatePage1">
                    <div id="templateGrid">
                        <button class="templateBtn" data-text="Camera Film 3-step 'hack' for achieving [GOAL] in [TIME].">
                            <strong>3-Step Hack üì∏üé¨</strong> What your audience is missing.
                        </button>
                        <button class="templateBtn" data-text="Coffee Mug Light Bulb 'If you're not doing [ACTION], you're leaving [RESULT] on the table.'">
                            <strong>Controversial Statement ‚òïüí°</strong> Call out a common error.
                        </button>
                        <button class="templateBtn" data-text="Question Mark Thinking Face 'I spent [TIME] figuring out [COMPLEX TOPIC] so you don't have to. Here's what I learned:'">
                            <strong>The Shortcut ?ü§î</strong> Position yourself as the guide.
                        </button>
                        <button class="templateBtn" data-text="Bookmark Sparkles 'The ultimate guide to [TOPIC]. Save this for later!'" >
                            <strong>Ultimate Guide üîñ‚ú®</strong> Must-save, comprehensive value.
                        </button>
                        <button class="templateBtn" data-text="Gift Rocket 'I'm giving away [ITEM] to one random person who comments [KEYWORD] and tags a friend.'">
                            <strong>Simple Giveaway üéÅüöÄ</strong> Easy engagement boost.
                        </button>
                        <button class="templateBtn" data-text="Hand Point Up Film 'A thread on why [INDUSTRY BELIEF] is wrong and what you should do instead.'">
                            <strong>Myth Busting üëÜüé¨</strong> Challenge status quo.
                        </button>
                        <button class="templateBtn" data-text="Star Speech Bubble 'What's one thing you wish you knew about [TOPIC] 5 years ago? Let me know below!'" >
                            <strong>Open Forum ‚≠êüí¨</strong> Encourage high comment volume.
                        </button>
                        <button class="templateBtn" data-text="Money Bag Chart Increasing 'Stop chasing [BAD METRIC]. Focus on [GOOD METRIC] instead to see real growth.'" >
                            <strong>Focus Shift üí∏üìà</strong> Advice on prioritization.
                        </button>
                        <button class="templateBtn" data-text="Crying Face Check Mark 'The worst advice I ever got about [INDUSTRY] was [BAD ADVICE]. The truth is...'">
                            <strong>Bad Advice Reveal üò´‚úÖ</strong> Relatable pain point.
                        </button>
                        <button class="templateBtn" data-text="Thinking Face Light Bulb 'Here's the one thing I do every day to [ACHIEVE GOAL]. It's simple but highly effective:'">
                            <strong>The 'One Thing' ü§îüí°</strong> Focus on simplicity and results.
                        </button>
                    </div>
                </div>
                <div id="templatePage2" class="hidden">
                    <div id="templateGrid">
                        <button class="templateBtn" data-text="Toolbox Target 'Fix these 3 mistakes you're making with [SKILL/TOPIC] today.'">
                            <strong>Fix Your Mistakes üõ†Ô∏èüéØ</strong> Direct and actionable.
                        </button>
                        <button class="templateBtn" data-text="Speech Bubble Cross Mark 'Unpopular opinion: [OPINION]. Agree or disagree in the comments.'">
                            <strong>Unpopular Opinion üí¨‚ùå</strong> Drive debate and reach.
                        </button>
                        <button class="templateBtn" data-text="Link Bookmark 'How to automate [TASK]. Link in bio for the full tutorial. Save this post!'" >
                            <strong>Link in Bio Offer üîóüîñ</strong> Convert viewers to leads/saves.
                        </button>
                        <button class="templateBtn" data-text="Smiling Face 100 Score 'My biggest win this week was [WIN]. What was yours?'">
                            <strong>Celebrate Wins üòäüíØ</strong> Build community engagement.
                        </button>
                        <button class="templateBtn" data-text="User Rocket 'How I grew my [METRIC] by [PERCENTAGE] in [TIME FRAME] using [STRATEGY].'">
                            <strong>Case Study Snippet üë§üöÄ</strong> Prove concept with numbers.
                        </button>
                        <button class="templateBtn" data-text="Alarm Clock Flexed Biceps 'If you only have 5 minutes to focus on [TOPIC], do this:'">
                            <strong>5-Minute Productivity ‚è∞üí™</strong> Micro-task value.
                        </button>
                        <button class="templateBtn" data-text="Balance Scale Magnifying Glass 'Is [PRODUCT A] better than [PRODUCT B]? A detailed breakdown.'">
                            <strong>A vs B Comparison ‚öñÔ∏èüßê</strong> High-value content.
                        </button>
                        <button class="templateBtn" data-text="Laptop Sparkles 'The one feature of [SOFTWARE] that changed my business this year.'">
                            <strong>Software Spotlight üíª‚ú®</strong> Tool-based value.
                        </button>
                        <button class="templateBtn" data-text="Writing Hand Target '3 ways to structure your [CONTENT TYPE] for maximum impact.'">
                            <strong>Structure Guide ‚úçÔ∏èüéØ</strong> Step-by-step framework.
                        </button>
                        <button class="templateBtn" data-text="Heart 'Tell me you're a [NICHE] without telling me you're a [NICHE].'">
                            <strong>Insider Community ‚ù§Ô∏è</strong> Niche-specific engagement.
                        </button>
                    </div>
                </div>
                <div class="pagination">
                    <button id="page1Btn">Page 1</button>
                    <button id="page2Btn">Page 2</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="analyzeContent" class="tab-content hidden">
        <div class="card">
            <form id="analyzeForm" class="hidden">
                <div class="form-group">
                    <label for="competitorUrl">Competitor Post URL</label>
                    <input type="text" id="competitorUrl" placeholder="e.g., https://instagram.com/p/B_X_Y_Z..." required />
                </div>
                <button type="submit" id="analyzeBtn" class="btn">Analyze Post</button>
            </form>
            
            <div id="analysisPaywall" class="paywall-overlay hidden">
                <p>Unlock the Competitor Analyzer for Pro-level insights into viral content structure. Subscribe today!</p>
                <button id="subscribeAnalyzeBtn" class="btn">Upgrade to Pro</button>
            </div>

            <div id="analysisResult" class="analysis-card hidden">
                <p style="text-align: center; font-size: 1.2rem; font-weight: 600; margin-bottom: 0;">Content Score</p>
                <div id="analysisScore" class="analysis-score">--</div>
                
                <div id="analysisDetails" class="analysis-detail">
                </div>
                
                <button id="boostScoreBtn" style="background: var(--success); margin-top: 1rem; width: 100%; font-size: 1rem; display: none;">Boost Score: See Potential</button>
                <button id="analyzeAgainBtn">Analyze Another Post</button>
            </div>
        </div>
    </div>

  </div>

  <script>
    // Mock API URL and User Authentication
    const API_URL = 'http://mockapi.com'; // Replace with your actual backend endpoint
    let isPro = localStorage.getItem('isPro') === 'true'; // Check if user is Pro
    let userEmail = 'user@example.com'; // Replace with actual user session email

    function initApp() {
      const form = document.getElementById('captionForm');
      const generateBtn = document.getElementById('generateBtn');
      const loading = document.getElementById('loading');
      const result = document.getElementById('result');
      const output = document.getElementById('output');
      const paywall = document.getElementById('paywall');
      const subscribeBtn = document.getElementById('subscribeBtn');
      const copyBtn = document.getElementById('copyBtn');
      const analysisPaywall = document.getElementById('analysisPaywall');
      const subscribeAnalyzeBtn = document.getElementById('subscribeAnalyzeBtn');
      const emojiPickerBtn = document.getElementById('emojiPickerBtn');

      let debounceTimer;
      let isGenerating = false;
      let freeUses = parseInt(localStorage.getItem('freeUses') || '0');


      // === EMOJI MAP ===
      const emojiMap = {
        'Camera': 'üì∏', 'Heart': '‚ù§Ô∏è', 'Sparkles': '‚ú®', 'Coffee': '‚òï', 'Shopping Bag': 'üõçÔ∏è',
        'Rocket': 'üöÄ', 'Fire': 'üî•', 'Trophy': 'üèÜ', 'Briefcase': 'üíº', 'Handshake': 'ü§ù',
        'Laptop': 'üíª', 'Sunrise': 'üåÖ', 'Moon': 'üåô', 'Pizza': 'üçï', 'Leaf': 'üçÉ',
        'Flexed Biceps': 'üí™', 'Airplane': '‚úàÔ∏è', 'Book': 'üìö', 'Dog': 'üê∂', 'Cat': 'üê±',
        'Birthday Cake': 'üéÇ', 'Party Popper': 'üéâ', 'Star': '‚≠ê', 'Film': 'üé¨',
        'Musical Notes': 'üé∂', 'Dancer': 'üíÉ', 'Play Button': '‚ñ∂Ô∏è', 'New': 'üÜï', 'Sale': 'üè∑Ô∏è',
        'Check Mark': '‚úÖ', 'Cross Mark': '‚ùå', 'Hand Point Down': 'üëá', 'Coffee Mug': '‚òï', 'Hand Wave': 'üëã',
        'Light Bulb': 'üí°', 'Thinking Face': 'ü§î', '100 Score': 'üíØ', 'Money Bag': 'üí∏', 
        'Chart Increasing': 'üìà', 'Target': 'üéØ', 'Alarm Clock': '‚è∞', 'Question Mark': '‚ùì',
        'Speech Bubble': 'üí¨', 'Crown': 'üëë', 'Diamond': 'üíé', 'Robot': 'ü§ñ',
        'Globe': 'üåç', 'Mountain': '‚õ∞Ô∏è', 'Pin': 'üìå', 'Megaphone': 'üì£',
        'Writing Hand': '‚úçÔ∏è', 'Open Book': 'üìñ', 'Smiling Face': 'üòä', 'Crying Face': 'üò´', 
        'Clapping Hands': 'üëè', 'Winking Face': 'üòâ', 'Red Apple': 'üçé', 'Grapes': 'üçá',
        'Donut': 'üç©', 'Taco': 'üåÆ', 'Beer Mug': 'üç∫', 'Martini Glass': 'üç∏',
        'Car': 'üöó', 'Bicycle': 'üö≤', 'Train': 'üöÜ', 'Boat': '‚õµ',
        'Fingers Crossed': 'ü§û', 'Poo': 'üí©', 'Ghost': 'üëª', 'Alien': 'üëΩ',
        'Lock': 'üîí', 'Key': 'üîë', 'Toolbox': 'üõ†Ô∏è', 'Graduation Cap': 'üéì',
        'Bookmark': 'üîñ', 'Gift': 'üéÅ', 'Hand Point Up': 'üëÜ',
        'Link': 'üîó', 'Balance Scale': '‚öñÔ∏è', 'Magnifying Glass': 'üßê', 'User': 'üë§' 
      };

      // === TAB LOGIC FOR NEW FEATURE ===
      const generateTabBtn = document.getElementById('generateTabBtn');
      const analyzeTabBtn = document.getElementById('analyzeTabBtn');
      const generateContent = document.getElementById('generateContent');
      const analyzeContent = document.getElementById('analyzeContent');
      const analyzeForm = document.getElementById('analyzeForm');
      const competitorUrlInput = document.getElementById('competitorUrl');
      const analyzeBtn = document.getElementById('analyzeBtn');
      const analysisResult = document.getElementById('analysisResult');
      const analyzeAgainBtn = document.getElementById('analyzeAgainBtn'); 
      const ideaInput = document.getElementById('idea');
      const platformSelect = document.getElementById('platform');
      
      // NEW BOOST FEATURE VARIABLES
      const boostScoreBtn = document.getElementById('boostScoreBtn');
      let lastAnalyzedUrl = '';
      let lastAnalyzedScore = 0;
      
      let currentTab = 'generateContent';

      function showTab(tabName) {
          currentTab = tabName;
          analysisResult.classList.add('hidden'); // Hide analysis results when switching tabs
          loading.classList.add('hidden'); // Hide loading indicator
          result.classList.add('hidden'); // Hide generation result
          
          if (tabName === 'generateContent') {
              generateContent.classList.remove('hidden');
              analyzeContent.classList.add('hidden');
              generateTabBtn.classList.add('active');
              analyzeTabBtn.classList.remove('active');
              analysisPaywall.classList.add('hidden');
              
              if (!isPro && freeUses >= 3) {
                paywall.classList.remove('hidden');
              } else {
                paywall.classList.add('hidden');
              }

          } else if (tabName === 'analyzeContent') {
              generateContent.classList.add('hidden');
              analyzeContent.classList.remove('hidden');
              generateTabBtn.classList.remove('active');
              analyzeTabBtn.classList.add('active');
              paywall.classList.add('hidden'); // Hide main paywall in analysis tab
              
              // Reset analysis state
              analysisResult.classList.add('hidden');
              document.getElementById('analysisScore').classList.remove('boosted');
              boostScoreBtn.style.display = 'none';

              if (!isPro) {
                analysisPaywall.classList.remove('hidden');
                analyzeForm.classList.add('hidden');
                analysisResult.classList.add('hidden'); // Ensure result is hidden if non-pro
              } else {
                analysisPaywall.classList.add('hidden');
                analyzeForm.classList.remove('hidden');
              }
          }
      }

      generateTabBtn.addEventListener('click', () => showTab('generateContent'));
      analyzeTabBtn.addEventListener('click', () => showTab('analyzeContent'));
      
      // Analysis Paywall Subscribe Button now correctly triggers the main subscription logic
      subscribeAnalyzeBtn.addEventListener('click', async () => {
        subscribeBtn.click();
      });
      
      // --- Platform Auto-Detection Function ---
      function detectPlatform(url) {
          url = url.toLowerCase();
          if (url.includes('instagram.com')) return 'Instagram';
          if (url.includes('twitter.com') || url.includes('x.com')) return 'Twitter';
          if (url.includes('linkedin.com')) return 'LinkedIn';
          if (url.includes('tiktok.com')) return 'TikTok';
          return 'Instagram'; // Default fallback
      }
      
      // === DETERMINISTIC SCORE GENERATION FUNCTION (UPDATED) ===
      // A simple, consistent hashing function to ensure the same URL yields the same number.
      function hashString(str) {
          let hash = 0;
          for (let i = 0; i < str.length; i++) {
              const char = str.charCodeAt(i);
              hash = ((hash << 5) - hash) + char;
              hash |= 0; // Convert to 32bit integer
          }
          return Math.abs(hash);
      }
      
      // Function to generate score and mock analysis details deterministically (UPDATED LOGIC)
      function generateDeterministicScore(url) {
          const uniqueSeed = hashString(url.toLowerCase().trim());
          
          // Map the unique seed to a score between 30 and 99
          const score = (uniqueSeed % 70) + 30; // Ensures score is between 30 and 99
          
          // Determine quality tiers based on the consistent score
          const quality = score > 90 ? 'High' : score > 80 ? 'Medium' : score > 50 ? 'Fair' : 'Low';
          
          let hook, readability, hashtags, cta;

          if (quality === 'High') {
              hook = 'Exceptional hook strategy, highly compelling. üî•';
              readability = 'Perfectly formatted for platform (short paragraphs, emojis). ‚úÖ';
              hashtags = 'All niche-specific and highly relevant (90%+). üéØ';
              cta = 'Strong, clear, and urgent call-to-action to a specific outcome. üöÄ';
          } else if (quality === 'Medium') {
              hook = 'Effective hook, though it could be more emotionally engaging. üëç';
              readability = 'Good structure, needs minor line break optimization. ‚ö†Ô∏è';
              hashtags = 'Balanced mix of niche and broad tags (60/40). üí°';
              cta = 'Clear directional CTA (e.g., "Link in Bio" or "Comment Below"). üîó';
          } else if (quality === 'Fair') {
              hook = 'Weak, generic hook that risks being scrolled past. üòï';
              readability = 'Mostly a wall of text, difficult to scan. üìù';
              hashtags = 'Mostly broad, low-impact tags (75%+). üîé';
              cta = 'Passive CTA or a simple question. ‚ùì';
          } else { // Low (30-50)
              hook = 'Vague or non-existent hook; immediate failure point. üõë';
              readability = 'Dense, unformatted text block, poor emoji use. ‚ùå';
              hashtags = 'Irrelevant or overused generic tags. üóëÔ∏è';
              cta = 'No clear CTA, relying purely on accidental engagement. üìâ';
          }

          return { score, hook, readability, hashtags, cta };
      }
      
      // === BOOST SCORE FUNCTION (NEW) ===
      function generateBoostedScore(initialScore) {
          // Calculate boost amount (more boost for low scores, less for high scores)
          let boostAmount;
          if (initialScore < 50) { 
              boostAmount = 15;
          } else if (initialScore < 80) { 
              boostAmount = 10;
          } else { 
              boostAmount = 5;
          }

          const newScore = Math.min(initialScore + boostAmount, 99);
          
          // Boosted analysis details always reflect 'High' quality improvements
          const hook = 'Transformed into an irresistible, pattern-interrupting hook. Success. üî•';
          const readability = 'Perfectly optimized for mobile scan-reading with line breaks and power words. ‚úÖ';
          const hashtags = 'Precise, low-competition tags selected for maximum organic reach. üéØ';
          const cta = 'Mandatory, single-action CTA added for conversion focus. üöÄ';

          return { score: newScore, hook, readability, hashtags, cta };
      }

      // Analysis Logic
      analyzeForm.addEventListener('submit', (e) => {
          e.preventDefault();
          if (!isPro) return;
          
          loading.classList.remove('hidden');
          analysisResult.classList.add('hidden');
          document.getElementById('analysisScore').classList.remove('boosted');
          boostScoreBtn.style.display = 'none'; // Ensure boost button is hidden initially
          
          const url = competitorUrlInput.value.trim();
          lastAnalyzedUrl = url; // Save URL
          const platform = detectPlatform(url); // Auto-detect the platform
          
          // --- DETERMINISTIC AI ANALYSIS ---
          setTimeout(() => {
              loading.classList.add('hidden');
              
              const analysisData = generateDeterministicScore(url);
              lastAnalyzedScore = analysisData.score; // Save score
              
              // Display results
              document.getElementById('analysisScore').textContent = analysisData.score;
              document.getElementById('analysisDetails').innerHTML = `
                  <p><strong>Platform Detected:</strong> ${platform}</p>
                  <p><strong>Hook Score:</strong> ${analysisData.hook}</p>
                  <p><strong>Readability:</strong> ${analysisData.readability}</p>
                  <p><strong>Hashtags:</strong> ${analysisData.hashtags}</p>
                  <p><strong>Core CTA:</strong> ${analysisData.cta}</p>
              `;
              
              analysisResult.classList.remove('hidden');
              boostScoreBtn.style.display = 'block'; // Show boost button after initial analysis
          }, 1500); // Simulate network latency
      });
      
      // NEW: Boost Score button listener
      boostScoreBtn.addEventListener('click', () => {
          if (lastAnalyzedScore === 0) return;
          
          loading.classList.remove('hidden');
          analysisResult.classList.add('hidden');
          
          setTimeout(() => {
              loading.classList.add('hidden');
              
              const boostedData = generateBoostedScore(lastAnalyzedScore);
              
              // Display boosted results
              const scoreElement = document.getElementById('analysisScore');
              scoreElement.textContent = boostedData.score;
              scoreElement.classList.add('boosted'); // Apply green color
              
              document.getElementById('analysisDetails').innerHTML = `
                  <p style="color: var(--success-dark); font-weight: 700;">‚úÖ BOOSTED ANALYSIS (Target Score: ${boostedData.score})</p>
                  <p><strong>Platform Detected:</strong> ${detectPlatform(lastAnalyzedUrl)}</p>
                  <p><strong>Hook Score:</strong> ${boostedData.hook}</p>
                  <p><strong>Readability:</strong> ${boostedData.readability}</p>
                  <p><strong>Hashtags:</strong> ${boostedData.hashtags}</p>
                  <p><strong>Core CTA:</strong> ${boostedData.cta}</p>
              `;
              
              analysisResult.classList.remove('hidden');
              boostScoreBtn.style.display = 'none'; // Hide button after boosting
              document.getElementById('analyzeAgainBtn').scrollIntoView({ behavior: 'smooth' });

          }, 1500); // Simulate network latency
      });
      
      // NEW: Analyze Again button listener (Simple clear function)
      analyzeAgainBtn.addEventListener('click', () => {
          competitorUrlInput.value = '';
          analysisResult.classList.add('hidden');
          document.getElementById('analysisScore').classList.remove('boosted');
          boostScoreBtn.style.display = 'none';
          competitorUrlInput.focus();
          // Optionally clear analysis details for a clean slate
          document.getElementById('analysisDetails').innerHTML = ''; 
      });

      // === PRO TEMPLATES PAGINATION LOGIC ===
      const templateContainer = document.getElementById('templateContainer');
      const templateTeaser = document.getElementById('templateTeaser');
      const page1 = document.getElementById('templatePage1');
      const page2 = document.getElementById('templatePage2');
      const page1Btn = document.getElementById('page1Btn');
      const page2Btn = document.getElementById('page2Btn');
      
      function showPage(pageNumber) {
          if (pageNumber === 1) {
              page1.style.display = 'grid';
              page2.style.display = 'none';
              page1Btn.classList.add('active');
              page2Btn.classList.remove('active');
          } else if (pageNumber === 2) {
              page1.style.display = 'none';
              page2.style.display = 'grid';
              page1Btn.classList.remove('active');
              page2Btn.classList.add('active');
          }
      }

      if (isPro) {
        templateContainer.classList.remove('hidden');
        templateContainer.style.display = 'block'; 
        templateTeaser.style.display = 'none';
        showPage(1); 

        page1Btn.addEventListener('click', () => showPage(1));
        page2Btn.addEventListener('click', () => showPage(2));

        document.querySelectorAll('.templateBtn').forEach(btn => {
          const raw = btn.getAttribute('data-text');
          
          const processTemplateText = (text) => {
              text = text.replace('Camera Film', emojiMap['Camera'] + ' ' + emojiMap['Film']);
              text = text.replace('Coffee Mug Light Bulb', emojiMap['Coffee Mug'] + ' ' + emojiMap['Light Bulb']);
              text = text.replace('Question Mark Thinking Face', emojiMap['Question Mark'] + ' ' + emojiMap['Thinking Face']);
              text = text.replace('Bookmark Sparkles', emojiMap['Bookmark'] + ' ' + emojiMap['Sparkles']);
              text = text.replace('Gift Rocket', emojiMap['Gift'] + ' ' + emojiMap['Rocket']);
              text = text.replace('Hand Point Up Film', emojiMap['Hand Point Up'] + ' ' + emojiMap['Film']);
              text = text.replace('Star Speech Bubble', emojiMap['Star'] + ' ' + emojiMap['Speech Bubble']);
              text = text.replace('Money Bag Chart Increasing', emojiMap['Money Bag'] + ' ' + emojiMap['Chart Increasing']);
              text = text.replace('Crying Face Check Mark', emojiMap['Crying Face'] + ' ' + emojiMap['Check Mark']);
              text = text.replace('Thinking Face Light Bulb', emojiMap['Thinking Face'] + ' ' + emojiMap['Light Bulb']);
              text = text.replace('Toolbox Target', emojiMap['Toolbox'] + ' ' + emojiMap['Target']);
              text = text.replace('Speech Bubble Cross Mark', emojiMap['Speech Bubble'] + ' ' + emojiMap['Cross Mark']);
              text = text.replace('Link Bookmark', emojiMap['Link'] + ' ' + emojiMap['Bookmark']);
              text = text.replace('Smiling Face 100 Score', emojiMap['Smiling Face'] + ' ' + emojiMap['100 Score']);
              text = text.replace('User Rocket', emojiMap['User'] + ' ' + emojiMap['Rocket']);
              text = text.replace('Alarm Clock Flexed Biceps', emojiMap['Alarm Clock'] + ' ' + emojiMap['Flexed Biceps']);
              text = text.replace('Balance Scale Magnifying Glass', emojiMap['Balance Scale'] + ' ' + emojiMap['Magnifying Glass']);


              text = text.replace('Heart', emojiMap['Heart']);
              text = text.replace('Sparkles', emojiMap['Sparkles']);
              text = text.replace('Hand Point Down', emojiMap['Hand Point Down']);
              text = text.replace('Shopping Bag', emojiMap['Shopping Bag']);
              text = text.replace('Fire', emojiMap['Fire']);
              text = text.replace('Light Bulb', emojiMap['Light Bulb']);
              text = text.replace('Film', emojiMap['Film']); 
              text = text.replace('Camera', emojiMap['Camera']); 
              text = text.replace('Gift snake', emojiMap['Gift']); 

              return text.replace(/\[\w+\]/g, (match) => match); 
          };

          const renderedText = processTemplateText(raw);
          
          btn.addEventListener('click', () => {
            document.getElementById('idea').value = renderedText;
            document.getElementById('idea').focus();
            showTab('generateContent'); // Ensure we are on the correct tab after clicking a template
          });
        });
      } else {
        templateContainer.style.display = 'none';
        templateTeaser.style.display = 'block';
      }
      
      // Ensure correct tab visibility on load
      showTab(currentTab); 

      document.getElementById('unlockTemplatesBtn').addEventListener('click', () => {
        paywall.classList.remove('hidden');
        paywall.scrollIntoView({ behavior: 'smooth' });
      });

      // === SUBSCRIBE BUTTON ===
      subscribeBtn.addEventListener('click', async () => {
        try {
          const res = await fetch(`${API_URL}/create-checkout-session`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: userEmail })
          });
          const { url } = await res.json();
          window.location.href = url;
        } catch (err) {
          alert('Checkout failed. Please try again.');
        }
      });

      // === EMOJI PICKER ===
      const emojiBtn = document.getElementById('emojiPickerBtn');
      const picker = document.getElementById('emojiPicker');
      const grid = document.getElementById('emojiGrid');
      const closePicker = document.getElementById('closePicker');

      const commonEmojis = Object.keys(emojiMap).filter(k => !['Coffee Mug', 'Hand Wave'].includes(k));
      grid.innerHTML = '';
      commonEmojis.forEach(name => {
        const btn = document.createElement('button');
        btn.textContent = emojiMap[name];
        btn.title = name;
        btn.addEventListener('click', () => {
          document.getElementById('idea').value += ' ' + emojiMap[name];
          document.getElementById('idea').focus();
        });
        grid.appendChild(btn);
      });

      emojiBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        picker.style.display = picker.style.display === 'flex' ? 'none' : 'flex';
      });

      closePicker.addEventListener('click', () => picker.style.display = 'none');

      document.addEventListener('click', (e) => {
        if (!picker.contains(e.target) && e.target !== emojiBtn) {
          picker.style.display = 'none';
        }
      });

      // === GENERATION LOGIC ===
      const inputs = ['idea', 'platform', 'tone'];
      inputs.forEach(id => {
        document.getElementById(id).addEventListener('input', () => {
          clearTimeout(debounceTimer);
          debounceTimer = setTimeout(tryGenerate, 800);
        });
      });

      form.addEventListener('submit', (e) => {
        e.preventDefault();
        clearTimeout(debounceTimer);
        tryGenerate(true);
      });

      async function tryGenerate(forceFull = false) {
        if (isGenerating || !userEmail) return; 

        const idea = document.getElementById('idea').value.trim();
        const platform = document.getElementById('platform').value;
        const tone = document.getElementById('tone').value;

        if (!idea || !platform || !tone) {
          result.classList.add('hidden');
          paywall.classList.add('hidden');
          return;
        }

        if (!isPro && freeUses >= 3) {
          paywall.classList.remove('hidden');
          result.classList.add('hidden');
          return;
        }

        isGenerating = true;
        loading.classList.remove('hidden');
        result.classList.add('hidden');
        paywall.classList.add('hidden');
        generateBtn.disabled = true;
        generateBtn.textContent = 'Generating...';

        try {
          const res = await fetch(`${API_URL}/generate`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ idea, platform, tone, email: userEmail })
          });

          const data = await res.json();

          if (res.status === 402 || (!isPro && freeUses >= 3)) {
            paywall.classList.remove('hidden');
            result.classList.add('hidden');
          } else if (res.ok) {
            output.textContent = data.result;
            result.classList.remove('hidden');
            paywall.classList.add('hidden');
            copyBtn.classList.remove('copied');
            copyBtn.textContent = 'Copy All';

            if (!isPro) {
              freeUses++;
              localStorage.setItem('freeUses', freeUses.toString());
              if (freeUses >= 3) {
                paywall.classList.remove('hidden');
                form.querySelector('button[type="submit"]').disabled = true;
              }
            }
          }
        } catch (err) {
          if (forceFull) {
            const fallback = `## Captions\n1. "Just launched my coffee shop! ${emojiMap['Coffee']}${emojiMap['Sparkles']}"\n2. "Fresh brews, cozy vibes ${emojiMap['Coffee']}${emojiMap['Heart']}"\n3. "Your new favorite morning spot!"\n4. "Handcrafted with love ${emojiMap['Leaf']}"\n5. "Come say hi! ${emojiMap['Hand Wave']}"\n\n## Hashtags\n#CoffeeShop #NewBusiness #SmallBiz #CoffeeLovers #LocalCafe #SupportLocal #MorningVibes #CoffeeTime #CafeLife #Entrepreneur #ShopSmall #CoffeeAddict #LatteArt #BrewedFresh #CozyCorner #CoffeeCommunity #SmallBusinessOwner #CoffeeCulture #DailyGrind #CafeVibes #CoffeeBreak #Handcrafted #WomenInBusiness #CoffeeLover #BaristaLife #CoffeeGram #InstaCoffee #CoffeeOfTheDay #CoffeeShopVibes #NewCafe`;
            output.textContent = fallback;
            result.classList.remove('hidden');
            if (!isPro) {
              freeUses++;
              localStorage.setItem('freeUses', freeUses.toString());
            }
          }
        } finally {
          loading.classList.add('hidden');
          generateBtn.disabled = false;
          generateBtn.textContent = 'Generate Captions';
          isGenerating = false;
          
          if (!isPro && freeUses >= 3 && currentTab === 'generateContent') {
              paywall.classList.remove('hidden');
              form.querySelector('button[type="submit"]').disabled = true;
          }
        }
      }

      copyBtn.addEventListener('click', () => {
        navigator.clipboard.writeText(output.textContent).then(() => {
          copyBtn.textContent = 'Copied!';
          copyBtn.classList.add('copied');
          setTimeout(() => {
            copyBtn.textContent = 'Copy All';
            copyBtn.classList.remove('copied');
          }, 2000);
        });
      });

      // === SUCCESS URL HANDLING ===
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('success') === 'true') {
        localStorage.setItem('isPro', 'true');
        isPro = true; // Update local variable
        paywall.classList.add('hidden');
        analysisPaywall.classList.add('hidden');
        analyzeForm.classList.remove('hidden'); // Show the form now that they are Pro
        form.querySelector('button[type="submit"]').disabled = false;
        alert('Welcome to Pro! Unlimited generations + 20 Viral Swipe File Structures + Content Analyzer unlocked.');
        window.history.replaceState({}, document.title, window.location.pathname);
        location.reload();
      }

      if (isPro) {
        paywall.classList.add('hidden');
        analysisPaywall.classList.add('hidden');
        analyzeForm.classList.remove('hidden');
        form.querySelector('button[type="submit"]').disabled = false;
      }
    }

    document.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>