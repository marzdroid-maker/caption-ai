<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI Caption + Hashtag Generator</title>
  <style>
    :root {
      --primary: #3b82f6;
      --primary-dark: #2563eb;
      --gray: #6b7280;
      --light: #f3f4f6;
      --border: #e5e7eb;
      --placeholder: #9ca3af;
      --success: #10b981;
      --success-dark: #059669;
      --error: #ef4444;
      --warning: #f59e0b;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      color: #111;
      min-height: 100vh;
      padding: 2rem 1rem;
    }
    .container { max-width: 600px; margin: 0 auto; }
    h1 { font-size: 2.25rem; font-weight: 700; text-align: center; margin-bottom: .5rem; }
    p.subtitle { text-align: center; color: var(--gray); margin-bottom: 1.5rem; font-size: 1.1rem; }

    .proof {
      background: #ecfdf5;
      border: 1px solid #a7f3d0;
      padding: 1rem;
      border-radius: .75rem;
      text-align: center;
      margin-bottom: 1.5rem;
      font-size: .95rem;
      color: #065f46;
    }
    .proof strong { font-weight: 600; }

    #dailyTipBox {
      background: #fff;
      border: 1px solid #d1d5db;
      padding: 1rem;
      border-radius: .75rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 5px rgba(0,0,0,0.02);
      font-size: .95rem;
      line-height: 1.4;
    }
    #dailyTipBox strong {
      color: var(--warning);
      margin-right: .5rem;
    }

    #emailModal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.7); display: flex; align-items: center;
      justify-content: center; z-index: 9999;
    }
    .modal-content {
      background: white; padding: 2rem; border-radius: 1rem;
      width: 90%; max-width: 400px; text-align: center;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }
    .modal-content h2 { margin-bottom: 1rem; font-size: 1.5rem; }
    .modal-content p { margin-bottom: 1.5rem; color: #555; }
    .modal-content input {
      width: 100%; padding: .75rem; border: 2px solid #e5e7eb;
      border-radius: .5rem; font-size: 1rem; margin-bottom: 1rem;
    }
    .modal-content button {
      background: var(--primary); color: white; border: none;
      padding: .75rem 1.5rem; border-radius: .5rem; font-weight: 600;
      cursor: pointer; width: 100%;
    }

    label { display: block; margin-bottom: .5rem; font-weight: 600; color: #111; }
    input, select {
      width: 100%; padding: .75rem 1rem; border: 2px solid var(--border);
      border-radius: .5rem; font-size: 1rem; margin-bottom: 1rem;
      transition: border .2s;
    }
    input:focus, select:focus { outline: none; border-color: var(--primary); }
    input::placeholder { color: var(--placeholder); font-style: italic; }

    select option[disabled] { display: none; }
    select option[data-placeholder] { color: var(--placeholder); font-style: italic; }
    select:invalid { color: var(--placeholder); }
    select:valid { color: #111; }

    button {
      width: 100%; background: var(--primary); color: white; border: none;
      padding: 1rem; font-size: 1.1rem; font-weight: 600; border-radius: .5rem;
      cursor: pointer; transition: background .2s;
    }
    button:hover { background: var(--primary-dark); }
    button:disabled { background: #93c5fd; cursor: not-allowed; }

    /* Tabs */
    #tabHeader {
      display: flex;
      margin-bottom: 1.5rem;
      border-bottom: 2px solid var(--border);
    }
    .tab-btn {
      flex: 1;
      padding: 0.75rem 0;
      background: none;
      border: none;
      font-weight: 600;
      cursor: pointer;
      color: var(--gray);
      font-size: 1.1rem;
      border-bottom: 3px solid transparent;
      transition: color 0.2s, border-bottom 0.2s;
      border-radius: 0;
      width: auto;
    }
    .tab-btn.active {
      color: var(--primary);
      border-bottom: 3px solid var(--primary);
    }
    .tab-content { padding: 0; }

    /* Result card */
    .result {
      margin-top: 2rem; padding: 1.5rem; background: white; border-radius: .75rem;
      box-shadow: 0 4px 12px rgba(0,0,0,.05); position: relative;
    }
    .result h3 { margin-bottom: .75rem; color: var(--primary); }
    .result pre {
      white-space: pre-wrap; font-family: inherit; line-height: 1.6; margin-bottom: 1rem;
    }

    /* Engagement header */
    #engagementHeader {
      margin-bottom: 1rem;
      padding: .75rem 1rem;
      border-radius: .75rem;
      background: #eff6ff;
      border: 1px solid #bfdbfe;
    }
    #engagementTopRow {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      font-size: .95rem;
      margin-bottom: .25rem;
    }
    #engagementLabel {
      font-weight: 700;
      letter-spacing: .03em;
      color: #1d4ed8;
    }
    #engagementScoreText {
      font-weight: 700;
      color: #111827;
    }
    #engagementDelta {
      margin-left: .35rem;
      font-size: .85rem;
    }
    #engagementNote {
      font-size: .8rem;
      color: #4b5563;
    }

    #copyBtn {
      position: absolute; top: 1rem; right: 1rem; background: var(--success);
      color: white; padding: .5rem 1rem; border-radius: .5rem;
      font-size: .9rem; cursor: pointer; border: none;
    }
    #copyBtn.copied { background: var(--success-dark); }

    #boostBtn {
      margin-top: .5rem;
      width: 100%;
      background: #16a34a;
    }
    #boostBtn.disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }

    /* Emoji picker */
    #emojiPickerBtn {
      background: var(--warning); margin: 1rem 0; width: auto; padding: .5rem 1rem; font-size: .9rem;
    }
    .emoji-picker-container {
      position: relative;
      text-align: left;
      display: flex;
      justify-content: center;
    }
    #emojiPicker {
      display: none;
      position: absolute;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: .75rem;
      padding: 1rem;
      max-width: 300px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.15);
      z-index: 100;
      text-align: center;
      max-height: 350px;
      flex-direction: column;
      right: 0;
      top: 100%;
      transform: translateY(5px);
    }
    #emojiGrid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: .5rem;
      font-size: 1.5rem;
      margin: .75rem 0;
      overflow-y: auto;
      padding-right: 5px;
    }
    #emojiGrid button {
      background: none; border: none; font-size: 1.5rem; cursor: pointer; padding: 0;
    }
    #closePicker {
      margin-top: .5rem; background: #6b7280; color: white; padding: .5rem 1rem;
      border-radius: .5rem; font-size: .8rem; width: auto;
    }

    /* Templates / paywall / misc */
    #proTemplates {
      margin-top: 2rem; padding: 1.5rem; background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: .75rem;
    }
    .templateBtn {
      text-align: left;
      padding: .75rem;
      background: white;
      border: 1px solid #d1d5db;
      border-radius: .5rem;
      font-size: .9rem;
      margin-bottom: .5rem;
      cursor: pointer;
      color: #111 !important;
      line-height: 1.4;
      display: block;
    }
    #templateContainer {
      display: grid;
      gap: .5rem;
      font-size: .9rem;
      margin-top: 1rem;
    }
    #templatePage2 { display: none; }

    #templatePaging {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-top: 1rem;
    }
    #templatePaging button {
      width: auto;
      padding: .5rem 1.2rem;
      background: #9ca3af;
      font-weight: 500;
      font-size: .9rem;
    }
    #templatePaging button.active {
      background: var(--primary);
      font-weight: 700;
    }

    .paywall {
      margin-top: 2rem; padding: 2rem; background: #fefce8; border-radius: .75rem;
      text-align: center; border: 2px solid #fde68a;
    }
    .paywall h3 { margin-bottom: .5rem; font-size: 1.5rem; }
    .paywall p { color: #92400e; margin-bottom: 1rem; }
    .paywall button {
      background: #16a34a; padding: .75rem 1.5rem; font-size: 1rem;
      width: auto; display: inline-block;
    }
    .paywall button:hover { background: #15803d; }

    .hidden { display: none; }
    .loading { text-align: center; margin: 1rem 0; color: var(--gray); font-style: italic; }

    footer {
      margin-top: 3rem; text-align: center; color: #6b7280; font-size: 0.875rem;
    }
    footer a { color: inherit; margin: 0 1rem; text-decoration: underline; }

    @media (max-width: 480px) {
      h1 { font-size: 1.75rem; }
      .container { padding: 0 1rem; }
      #copyBtn { position: static; margin-top: 1rem; width: 100%; }
      #emojiGrid { grid-template-columns: repeat(5, 1fr); }
      #emojiPicker {
        right: auto;
        left: 50%;
        transform: translateX(-50%) translateY(5px);
      }
    }
  </style>
</head>
<body>

  <!-- Email gate -->
  <div id="emailModal">
    <div class="modal-content">
      <h2>Welcome!</h2>
      <p>Enter your email to get <strong>10 free generations</strong>.</p>
      <input type="email" id="emailInput" placeholder="you@example.com" required />
      <button id="emailSubmit">Start Generating</button>
    </div>
  </div>

  <!-- Main App -->
  <div class="container" id="mainApp" style="display:none;">
    <h1>AI Caption + Hashtag Generator</h1>
    <p class="subtitle">Get 5 viral captions + 30 hashtags in 3 seconds.</p>

    <div class="proof">
      <strong>Stop guessing and start optimizing. The only AI Caption Generator with a built-in Engagement Score.</strong>
    </div>

    <div id="dailyTipBox">
      <strong>üí° Today's Tip:</strong>
      <span id="dailyTipText">Loading a viral content tip...</span>
    </div>

    <div id="tabContainer">
      <div id="tabHeader">
        <button id="generateTabBtn" class="tab-btn active" data-target="generateContent">Generate Content</button>
        <button id="analyzeTabBtn" class="tab-btn" data-target="analyzeContent">Analyze Competitor (Pro)</button>
      </div>

      <!-- Generate tab -->
      <div id="generateContent" class="tab-content">
        <form id="captionForm">
          <label for="idea">Post Idea</label>
          <input type="text" id="idea" placeholder="e.g. Just launched my coffee shop" required />

          <label for="platform">Platform</label>
          <select id="platform" required>
            <option value="" disabled selected data-placeholder>Choose platform</option>
            <option value="Instagram">Instagram</option>
            <option value="Twitter">Twitter</option>
            <option value="LinkedIn">LinkedIn</option>
            <option value="TikTok">TikTok</option>
          </select>

          <label for="tone">Tone</label>
          <select id="tone" required>
            <option value="" disabled selected data-placeholder>Choose tone</option>
            <option value="Professional">Professional</option>
            <option value="Fun & Playful">Fun & Playful</option>
            <option value="Inspirational">Inspirational</option>
            <option value="Bold & Confident">Bold & Confident</option>
            <option value="Casual & Friendly">Casual & Friendly</option>
          </select>

          <button type="submit" id="generateBtn">Generate Captions</button>
        </form>

        <div class="emoji-picker-container">
          <button type="button" id="emojiPickerBtn">Add Emojis</button>
          <div id="emojiPicker">
            <p style="margin-bottom: .75rem; font-weight: 600;">Pick Emojis</p>
            <div id="emojiGrid"></div>
            <button id="closePicker">Close</button>
          </div>
        </div>

        <div id="loading" class="loading hidden">Generating magic...</div>

        <div id="result" class="result hidden">
          <button type="button" id="copyBtn">Copy All</button>

          <div id="engagementHeader" class="hidden">
            <div id="engagementTopRow">
              <span id="engagementLabel">ENGAGEMENT SCORE</span>
              <span id="engagementScoreText">--/100</span>
            </div>
            <p id="engagementNote">
              Higher scores usually mean more saves, comments, and shares.
              <span id="engagementDelta"></span>
            </p>
          </div>

          <h3>Your AI Captions</h3>
          <pre id="output"></pre>

          <button type="button" id="boostBtn" class="hidden">Boost My Score</button>
        </div>

        <!-- PRO Templates -->
        <div id="proTemplates">
          <h3>The Viral Swipe File: Proven 6-Figure Post Structures</h3>
          <p style="margin: 1rem 0 .75rem; font-size: .95rem; color: #065f46; line-height: 1.5;">
            <strong>Steal the exact captions used by 6-figure creators.</strong>
            These aren‚Äôt random ‚Äî they‚Äôre <em>proven</em> to get 3x more likes, comments, and saves.
            Just click, edit, generate. <strong>Instant viral edge.</strong>
          </p>

          <div id="templateContainer" class="hidden">
            <div id="templatePage1">
              <button class="templateBtn" data-text="Just hit [X] followers! Grateful for every one of you ‚ù§Ô∏è ‚ú®">
                Just hit [X] followers! Grateful for every one of you ‚ù§Ô∏è ‚ú®
              </button>
              <button class="templateBtn" data-text="Behind the scenes of [your idea] üì∏ üé¨">
                Behind the scenes of [your idea] üì∏ üé¨
              </button>
              <button class="templateBtn" data-text="Tag a friend who needs this! üëá">
                Tag a friend who needs this! üëá
              </button>
              <button class="templateBtn" data-text="New drop alert! Link in bio üõçÔ∏è üî•">
                New drop alert! Link in bio üõçÔ∏è üî•
              </button>
              <button class="templateBtn" data-text="Your daily dose of [topic] ‚òï üí°">
                Your daily dose of [topic] ‚òï üí°
              </button>
              <button class="templateBtn" data-text="Reply with YES or NO: [question]? ‚ùì ü§î">
                Reply with YES or NO: [question]? ‚ùì ü§î
              </button>
              <button class="templateBtn" data-text="Save this for later ‚Äî you‚Äôll thank me! üîñ ‚ú®">
                Save this for later ‚Äî you‚Äôll thank me! üîñ ‚ú®
              </button>
              <button class="templateBtn" data-text="Free [resource] in bio! Don‚Äôt miss it üéÅ üöÄ">
                Free [resource] in bio! Don‚Äôt miss it üéÅ üöÄ
              </button>
              <button class="templateBtn" data-text="Swipe up to see the full story! üëÜ üé¨">
                Swipe up to see the full story! üëÜ üé¨
              </button>
              <button class="templateBtn" data-text="&quot;Changed my [niche] game!&quot; ‚Äì @username ‚≠ê üí¨">
                "Changed my [niche] game!" ‚Äì @username ‚≠ê üí¨
              </button>
            </div>

            <div id="templatePage2">
              <button class="templateBtn" data-text="You think [Product] is too expensive? Here's the ROI breakdown. üí∏ üìà">
                You think [Product] is too expensive? Here's the ROI breakdown. üí∏ üìà
              </button>
              <button class="templateBtn" data-text="Stop wasting time on [Frustrating Task]. Our 3-step solution: [Solution]. üò´ ‚úÖ">
                Stop wasting time on [Frustrating Task]. Our 3-step solution: [Solution]. üò´ ‚úÖ
              </button>
              <button class="templateBtn" data-text="6 months ago I was [Stuck]... now I'm [Success]. The difference: [1 Thing]. ü§Ø üí°">
                6 months ago I was [Stuck]... now I'm [Success]. The difference: [1 Thing]. ü§Ø üí°
              </button>
              <button class="templateBtn" data-text="How I made [High Result] in [Short Time]: Step 1: [Action]. Save for steps 2 & 3. üõ†Ô∏è üéØ">
                How I made [High Result] in [Short Time]: Step 1: [Action]. Save for steps 2 & 3. üõ†Ô∏è üéØ
              </button>
              <button class="templateBtn" data-text="Unpopular opinion: [Common Belief] is completely wrong. Here's why. üó£Ô∏è ‚ùå">
                Unpopular opinion: [Common Belief] is completely wrong. Here's why. üó£Ô∏è ‚ùå
              </button>
              <button class="templateBtn" data-text="Get the exact checklist I use to [Goal]! Click the link that says &quot;Free Guide.&quot; üîó üîñ">
                Get the exact checklist I use to [Goal]! Click the link that says "Free Guide." üîó üîñ
              </button>
              <button class="templateBtn" data-text="Myth: You need [X] to succeed. Reality: You only need [Y]. Which shocked you? üòÆ üíØ">
                Myth: You need [X] to succeed. Reality: You only need [Y]. Which shocked you? üòÆ üíØ
              </button>
              <button class="templateBtn" data-text="Client Spotlight: [Client Name] went from [A] to [B] in 30 days. Their secret was [Tool]. üë§ üöÄ">
                Client Spotlight: [Client Name] went from [A] to [B] in 30 days. Their secret was [Tool]. üë§ üöÄ
              </button>
              <button class="templateBtn" data-text="My most impactful habit for [Goal]? Doing [Task] at [Time]. Steal it. ‚è∞ üí™">
                My most impactful habit for [Goal]? Doing [Task] at [Time]. Steal it. ‚è∞ üí™
              </button>
              <button class="templateBtn" data-text="[Option A] vs. [Option B]: Which is better for [Specific Use Case]? Swipe to see the pros/cons. ‚öñÔ∏è üßê">
                [Option A] vs. [Option B]: Which is better for [Specific Use Case]? Swipe to see the pros/cons. ‚öñÔ∏è üßê
              </button>
            </div>

            <div id="templatePaging">
              <button id="page1Btn" class="active">Page 1</button>
              <button id="page2Btn">Page 2</button>
            </div>
          </div>

          <div id="templateTeaser">
            <p style="font-size: .9rem; color: #92400e; font-style: italic; margin-top: 1rem;">
              <strong>Unlock 20 Viral Swipe File Structures</strong> ‚Äî only available in <strong>Pro</strong>.
            </p>
            <button id="unlockTemplatesBtn" style="
              background: #f59e0b; color: white; border: none; padding: .6rem 1.2rem;
              border-radius: .5rem; font-size: .9rem; font-weight: 600; cursor: pointer;
              margin-top: .5rem;
            ">Upgrade to Pro</button>
          </div>
        </div>

        <div id="paywall" class="paywall hidden">
          <h3>Upgrade to Pro!</h3>
          <p>
            You've used your 10 free generations.
            <strong>Unlimited + 20 Viral Swipe File Structures + Content Analyzer</strong> for <strong>$7/month</strong>.
          </p>
          <button id="subscribeBtn">Subscribe Now</button>
        </div>
      </div>

      <!-- Analyze tab -->
      <div id="analyzeContent" class="tab-content hidden">
        <div id="analysisDescription" style="
          background: #f0f9ff;
          border: 1px solid #bae6fd;
          padding: 1.2rem;
          border-radius: .75rem;
          margin-bottom: 1.5rem;
          font-size: .95rem;
          line-height: 1.5;
          color: #0369a1;">
          <h4 style="margin-bottom: .5rem; color: #075985; font-size: 1.1rem;">
            Reverse-Engineer Viral Success üî¨
          </h4>
          Paste any competitor's post URL (Instagram, Twitter, etc.) and our AI will deconstruct their strategy.
          Get an instant Content Score and a breakdown of their hook, CTA, and hashtag usage.
        </div>

        <div id="analysisPaywall" class="paywall hidden" style="margin-top: 1rem;">
          <h3>Unlock Analysis!</h3>
          <p>Content Scoring is an exclusive Pro feature. Unlimited access for $7/month.</p>
          <button id="subscribeAnalyzeBtn">Upgrade to Pro</button>
        </div>

        <form id="analyzeForm" class="hidden">
          <label for="competitorUrl">Competitor Post URL</label>
          <input type="url" id="competitorUrl" placeholder="e.g. https://instagram.com/p/B..." required />
          <button type="submit" id="analyzeBtn">Analyze Post Structure</button>
        </form>

        <div id="analysisResult" class="analysis-card hidden">
          <p style="text-align: center; font-size: 1.2rem; font-weight: 600; margin-bottom: 0;">Content Score</p>
          <div id="analysisScore" class="analysis-score">--</div>
          <div id="analysisDetails" class="analysis-detail"></div>
          <button id="analyzeAgainBtn">Analyze Another Post</button>
        </div>
      </div>
    </div>

    <footer>
      <a href="/terms.html">Terms</a>
      <a href="/privacy.html">Privacy</a>
      <span>¬© 2025 Caption AI</span>
    </footer>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const API_URL = 'https://caption-ai-ze13.onrender.com';
    const MAX_FREE_USES = 10;

    // State
    let userEmail = localStorage.getItem('userEmail');
    let isPro = localStorage.getItem('isPro') === 'true';
    let freeUses = parseInt(localStorage.getItem('freeUses') || '0', 10);
    let currentTab = localStorage.getItem('lastTab') || 'generateContent';
    let isGenerating = false;
    let lastScore = null;
    let boostedOnce = false;
    let lastRawText = '';

    // DOM
    const modal = document.getElementById('emailModal');
    const mainApp = document.getElementById('mainApp');
    const emailInput = document.getElementById('emailInput');
    const emailSubmit = document.getElementById('emailSubmit');

    const ideaInput = document.getElementById('idea');
    const platformSelect = document.getElementById('platform');
    const toneSelect = document.getElementById('tone');
    const captionForm = document.getElementById('captionForm');
    const generateBtn = document.getElementById('generateBtn');
    const loadingEl = document.getElementById('loading');
    const resultEl = document.getElementById('result');
    const outputEl = document.getElementById('output');
    const copyBtn = document.getElementById('copyBtn');
    const boostBtn = document.getElementById('boostBtn');

    const engagementHeader = document.getElementById('engagementHeader');
    const engagementScoreText = document.getElementById('engagementScoreText');
    const engagementDelta = document.getElementById('engagementDelta');

    const generateTabBtn = document.getElementById('generateTabBtn');
    const analyzeTabBtn = document.getElementById('analyzeTabBtn');
    const generateContent = document.getElementById('generateContent');
    const analyzeContent = document.getElementById('analyzeContent');

    const analysisPaywall = document.getElementById('analysisPaywall');
    const analyzeForm = document.getElementById('analyzeForm');
    const analysisResult = document.getElementById('analysisResult');

    const paywall = document.getElementById('paywall');
    const subscribeBtn = document.getElementById('subscribeBtn');
    const subscribeAnalyzeBtn = document.getElementById('subscribeAnalyzeBtn');

    const templateContainer = document.getElementById('templateContainer');
    const templateTeaser = document.getElementById('templateTeaser');
    const page1 = document.getElementById('templatePage1');
    const page2 = document.getElementById('templatePage2');
    const page1Btn = document.getElementById('page1Btn');
    const page2Btn = document.getElementById('page2Btn');

    const emojiPickerBtn = document.getElementById('emojiPickerBtn');
    const emojiPicker = document.getElementById('emojiPicker');
    const emojiGrid = document.getElementById('emojiGrid');
    const closePicker = document.getElementById('closePicker');

    const dailyTipText = document.getElementById('dailyTipText');

    // Tips of the day
    const dailyTips = [
      "Hook the reader in the first sentence. Your AI captions are useless if no one stops scrolling!",
      "Always include a clear CTA at the end: ask a question, tell them to save, or tag a friend.",
      "Use 2‚Äì3 broad hashtags and 10+ niche hashtags for maximum reach.",
      "Test different tones for the same idea. Bold vs Casual can change results by 50%.",
      "Engage in the first hour: reply to comments quickly to signal value to the algorithm.",
      "Use line breaks. 1‚Äì2 sentence paragraphs dramatically boost readability.",
      "For LinkedIn, stay professional, minimize emojis, and focus on business outcomes.",
      "Turn your idea into a benefit, not a feature: 'Save 2 hours' beats 'New tool launched'.",
      "Short hooks + curiosity gaps outperform long intros almost every time.",
      "Ask for a specific response: 'Reply YES if...' beats generic questions."
    ];

    function getTodayTip() {
      const today = new Date();
      const start = new Date(today.getFullYear(), 0, 0);
      const diff = today - start;
      const oneDay = 1000 * 60 * 60 * 24;
      const dayOfYear = Math.floor(diff / oneDay);
      const tipIndex = dayOfYear % dailyTips.length;
      return dailyTips[tipIndex];
    }

    if (dailyTipText) dailyTipText.textContent = getTodayTip();

    // === Engagement scoring (same logic as backend, used as fallback) ===
    function computeEngagementScoreLocal(text, idea, platform, tone) {
      if (!text || typeof text !== 'string') return 40;
      text = text.trim();
      idea = (idea || '').trim();
      platform = (platform || '').trim();
      tone = (tone || '').trim();

      const cleaned = text.replace(/^#+\s*captions?/i, '').trim();
      const totalChars = cleaned.length;
      const totalWords = cleaned.split(/\s+/).length;
      const lines = cleaned.split('\n').filter(l => l.trim().length > 0);
      const hashtagMatches = cleaned.match(/#[A-Za-z0-9_]+/g) || [];
      const uniqueHashtags = [...new Set(hashtagMatches.map(h => h.toLowerCase()))];
      const emojiMatches = cleaned.match(/[\u{1F300}-\u{1FAFF}\u{2600}-\u{26FF}]/gu) || [];
      const ctaRegex = /(comment|save (this|it)|share (this|it)|tag (a|your) friend|link in bio|dm me|reply|retweet|quote this|swipe (up|left|right))/i;
      const hasCTA = ctaRegex.test(cleaned);
      const questionHooks = (cleaned.match(/\?/g) || []).length;
      const numberedHooks = (cleaned.match(/^\s*\d+\./gm) || []).length;

      let base = 35;

      // Hook
      let hookScore = 0;
      const first160 = cleaned.slice(0, 160);
      if (first160.length > 0) {
        if (first160[0] === first160[0].toUpperCase()) hookScore += 4;
        if (first160.length >= 40 && first160.length <= 160) hookScore += 5;
      }
      if (questionHooks > 0) hookScore += 4;
      if (ctaRegex.test(first160)) hookScore += 4;
      if (emojiMatches.length >= 1 && emojiMatches.length <= 8) hookScore += 4;
      if (idea && first160.toLowerCase().includes(idea.split(/\s+/)[0].toLowerCase())) hookScore += 4;
      if (numberedHooks >= 2) hookScore += 4;
      hookScore = Math.max(0, Math.min(hookScore, 25));

      // Structure
      let structureScore = 0;
      if (lines.length >= 6 && lines.length <= 22) structureScore += 8;
      if (totalChars >= 350 && totalChars <= 1600) structureScore += 6;
      const longLines = lines.filter(l => l.length > 180).length;
      if (longLines <= 2) structureScore += 4;
      const capsRatio = (cleaned.match(/[A-Z]/g) || []).length / (cleaned.match(/[a-zA-Z]/g) || []).length || 0;
      if (capsRatio < 0.45) structureScore += 2;
      structureScore = Math.max(0, Math.min(structureScore, 20));

      // Hashtags
      let hashtagScore = 0;
      const nHash = uniqueHashtags.length;
      if (nHash >= 15 && nHash <= 32) hashtagScore += 10;
      else if (nHash >= 10 && nHash < 15) hashtagScore += 6;
      else if (nHash > 32 && nHash <= 45) hashtagScore += 4;
      const longTags = uniqueHashtags.filter(h => h.length >= 9).length;
      const shortTags = uniqueHashtags.filter(h => h.length <= 6).length;
      if (longTags >= 5 && longTags <= 20) hashtagScore += 5;
      if (shortTags >= 3 && shortTags <= 15) hashtagScore += 3;
      if (platform && uniqueHashtags.some(h => h.includes(platform.toLowerCase()))) {
        hashtagScore += 2;
      }
      hashtagScore = Math.max(0, Math.min(hashtagScore, 20));

      // Platform / tone fit
      let fitScore = 0;
      const lowerTone = tone.toLowerCase();
      const lowerPlatform = platform.toLowerCase();
      if (lowerPlatform === 'linkedin') {
        if (lowerTone.includes('professional')) fitScore += 8;
        if (emojiMatches.length <= 4) fitScore += 4;
        if (totalChars >= 400) fitScore += 3;
      } else if (lowerPlatform === 'twitter') {
        if (totalChars <= 800) fitScore += 5;
        if (emojiMatches.length >= 1 && emojiMatches.length <= 6) fitScore += 5;
        if (lowerTone.includes('bold') || lowerTone.includes('fun')) fitScore += 3;
        if (hasCTA) fitScore += 2;
      } else if (lowerPlatform === 'instagram' || lowerPlatform === 'tiktok') {
        if (emojiMatches.length >= 2) fitScore += 5;
        if (hasCTA) fitScore += 4;
        if (nHash >= 18) fitScore += 4;
        if (lowerTone.includes('fun') || lowerTone.includes('casual') || lowerTone.includes('inspirational')) {
          fitScore += 2;
        }
      } else {
        fitScore += 4;
      }
      fitScore = Math.max(0, Math.min(fitScore, 15));

      // Penalties
      let penalty = 0;
      if (totalChars < 200) penalty -= 10;
      if (totalChars > 2200) penalty -= 6;
      const hashToWord = nHash / (totalWords || 1);
      if (hashToWord > 0.45) penalty -= 6;
      if (emojiMatches.length > 18) penalty -= 4;
      if (/!!!|!!!+/g.test(cleaned)) penalty -= 4;

      // Randomness
      const seedStr = (idea + platform + tone + cleaned).toLowerCase();
      let hash = 0;
      for (let i = 0; i < seedStr.length; i++) {
        hash = (hash * 31 + seedStr.charCodeAt(i)) | 0;
      }
      const randomOffset = (hash % 11) - 5;

      let score = base + hookScore + structureScore + hashtagScore + fitScore + penalty + randomOffset;
      score = Math.round(Math.max(10, Math.min(score, 92)));
      return score;
    }

    function updateGenerateButtonState() {
      if (!generateBtn) return;
      if (isPro) {
        generateBtn.disabled = false;
        if (paywall) paywall.classList.add('hidden');
      } else if (freeUses >= MAX_FREE_USES) {
        generateBtn.disabled = true;
        if (paywall && currentTab === 'generateContent') {
          paywall.classList.remove('hidden');
        }
      } else {
        generateBtn.disabled = false;
        if (paywall) paywall.classList.add('hidden');
      }
    }

    function showTab(tab) {
      currentTab = tab;
      localStorage.setItem('lastTab', tab);

      if (tab === 'generateContent') {
        generateContent.classList.remove('hidden');
        analyzeContent.classList.add('hidden');
        generateTabBtn.classList.add('active');
        analyzeTabBtn.classList.remove('active');
        analysisPaywall.classList.add('hidden');
        analyzeForm.classList.add('hidden');
      } else {
        generateContent.classList.add('hidden');
        analyzeContent.classList.remove('hidden');
        generateTabBtn.classList.remove('active');
        analyzeTabBtn.classList.add('active');
        paywall.classList.add('hidden');
        if (isPro) {
          analysisPaywall.classList.add('hidden');
          analyzeForm.classList.remove('hidden');
        } else {
          analysisPaywall.classList.remove('hidden');
          analyzeForm.classList.add('hidden');
        }
      }
      updateGenerateButtonState();
    }

    function updateUIState() {
      // Templates visibility
      if (isPro) {
        templateContainer.classList.remove('hidden');
        templateContainer.style.display = 'grid';
        templateTeaser.style.display = 'none';
      } else {
        templateContainer.classList.add('hidden');
        templateContainer.style.display = 'none';
        templateTeaser.style.display = 'block';
      }
      showTab(currentTab);
    }

    // Template pagination
    function showPage(page) {
      if (page === 1) {
        page1.style.display = 'grid';
        page2.style.display = 'none';
        page1Btn.classList.add('active');
        page2Btn.classList.remove('active');
      } else {
        page1.style.display = 'none';
        page2.style.display = 'grid';
        page1Btn.classList.remove('active');
        page2Btn.classList.add('active');
      }
    }

    // Emoji picker
    const emojiMap = {
      'Heart': '‚ù§Ô∏è', 'Sparkles': '‚ú®', 'Coffee': '‚òï', 'Shopping Bag': 'üõçÔ∏è',
      'Rocket': 'üöÄ', 'Fire': 'üî•', 'Trophy': 'üèÜ', 'Briefcase': 'üíº',
      'Handshake': 'ü§ù', 'Laptop': 'üíª', 'Sunrise': 'üåÖ', 'Moon': 'üåô',
      'Pizza': 'üçï', 'Leaf': 'üçÉ', 'Flexed Biceps': 'üí™', 'Airplane': '‚úàÔ∏è',
      'Book': 'üìö', 'Dog': 'üê∂', 'Cat': 'üê±', 'Party Popper': 'üéâ',
      'Star': '‚≠ê', 'Film': 'üé¨', 'Question Mark': '‚ùì', 'Thinking Face': 'ü§î',
      'Bookmark': 'üîñ', 'Money Bag': 'üí∏', 'Chart Increasing': 'üìà'
    };
    if (emojiGrid && ideaInput) {
      emojiGrid.innerHTML = '';
      Object.keys(emojiMap).forEach(name => {
        const btn = document.createElement('button');
        btn.textContent = emojiMap[name];
        btn.title = name;
        btn.addEventListener('click', () => {
          ideaInput.value += ' ' + emojiMap[name];
          ideaInput.focus();
        });
        emojiGrid.appendChild(btn);
      });
    }
    if (emojiPickerBtn && emojiPicker) {
      emojiPickerBtn.addEventListener('click', e => {
        e.stopPropagation();
        emojiPicker.style.display = emojiPicker.style.display === 'flex' ? 'none' : 'flex';
      });
      closePicker.addEventListener('click', () => emojiPicker.style.display = 'none');
      document.addEventListener('click', e => {
        if (!emojiPicker.contains(e.target) && e.target !== emojiPickerBtn) {
          emojiPicker.style.display = 'none';
        }
      });
    }

    // Templates (click -> fill idea)
    document.querySelectorAll('.templateBtn').forEach(btn => {
      btn.addEventListener('click', () => {
        const text = btn.getAttribute('data-text') || btn.innerText;
        ideaInput.value = text;
        ideaInput.focus();
        showTab('generateContent');
      });
    });

    if (page1Btn && page2Btn) {
      page1Btn.addEventListener('click', () => showPage(1));
      page2Btn.addEventListener('click', () => showPage(2));
    }
    showPage(1);

    // Copy button
    if (copyBtn && outputEl) {
      copyBtn.addEventListener('click', () => {
        navigator.clipboard.writeText(outputEl.textContent || '').then(() => {
          copyBtn.textContent = 'Copied!';
          copyBtn.classList.add('copied');
          setTimeout(() => {
            copyBtn.textContent = 'Copy All';
            copyBtn.classList.remove('copied');
          }, 2000);
        });
      });
    }

    // Stripe checkout
    if (subscribeBtn) {
      subscribeBtn.addEventListener('click', async () => {
        try {
          const res = await fetch(`${API_URL}/create-checkout-session`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: userEmail })
          });
          const data = await res.json();
          if (data.url) window.location.href = data.url;
        } catch {
          alert('Checkout failed. Please try again.');
        }
      });
    }
    if (subscribeAnalyzeBtn && subscribeBtn) {
      subscribeAnalyzeBtn.addEventListener('click', () => subscribeBtn.click());
    }

    // Success URL flag => mark Pro
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('success') === 'true') {
      localStorage.setItem('isPro', 'true');
      isPro = true;
      window.history.replaceState({}, document.title, window.location.pathname);
      alert('Welcome to Pro! Unlimited generations, templates, and content analyzer unlocked.');
    }

    // Tabs
    generateTabBtn.addEventListener('click', () => showTab('generateContent'));
    analyzeTabBtn.addEventListener('click', () => showTab('analyzeContent'));

    // Engagement header renderer
    function renderEngagement(score, previousScore = null) {
      engagementHeader.classList.remove('hidden');
      engagementScoreText.textContent = `${score} /100`;

      if (previousScore == null) {
        engagementDelta.textContent = '';
      } else {
        const diff = score - previousScore;
        if (diff > 0) {
          engagementDelta.textContent = `(+${diff} after boost)`;
          engagementDelta.style.color = '#16a34a';
        } else if (diff < 0) {
          engagementDelta.textContent = `(${diff} after boost)`;
          engagementDelta.style.color = '#b91c1c';
        } else {
          engagementDelta.textContent = '(no change after boost)';
          engagementDelta.style.color = '#4b5563';
        }
      }
    }

    // Generate captions
    async function tryGenerate() {
      if (isGenerating) return;
      const idea = ideaInput.value.trim();
      const platform = platformSelect.value;
      const tone = toneSelect.value;

      if (!idea || !platform || !tone || !userEmail) return;

      if (!isPro && freeUses >= MAX_FREE_USES) {
        if (paywall) paywall.classList.remove('hidden');
        return;
      }

      isGenerating = true;
      boostedOnce = false;
      lastScore = null;
      lastRawText = '';

      loadingEl.classList.remove('hidden');
      resultEl.classList.add('hidden');
      engagementHeader.classList.add('hidden');
      boostBtn.classList.add('hidden');

      generateBtn.disabled = true;
      generateBtn.textContent = 'Generating...';

      try {
        const res = await fetch(`${API_URL}/generate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ idea, platform, tone, email: userEmail })
        });

        const data = await res.json();

        if (res.status === 402) {
          paywall.classList.remove('hidden');
          resultEl.classList.add('hidden');
          return;
        }

        const text = data.result || 'No result';
        lastRawText = text;
        outputEl.textContent = text;
        resultEl.classList.remove('hidden');

        // authoritative score from backend, fallback to local
        const backendScore = typeof data.score === 'number'
          ? data.score
          : computeEngagementScoreLocal(text, idea, platform, tone);

        lastScore = backendScore;
        renderEngagement(backendScore, null);

        if (!isPro) {
          freeUses += 1;
          localStorage.setItem('freeUses', String(freeUses));
        }

        // allow boost if under 88
        if (backendScore < 88) {
          boostBtn.classList.remove('hidden');
          boostBtn.disabled = false;
          boostBtn.classList.remove('disabled');
        } else {
          boostBtn.classList.add('hidden');
        }

      } catch (err) {
        console.error(err);
        outputEl.textContent = 'AI generation failed. Please try again.';
        resultEl.classList.remove('hidden');
      } finally {
        loadingEl.classList.add('hidden');
        generateBtn.disabled = false;
        generateBtn.textContent = 'Generate Captions';
        isGenerating = false;
        updateGenerateButtonState();
      }
    }

    // Boost
    if (boostBtn) {
      boostBtn.addEventListener('click', async () => {
        if (boostedOnce || !lastRawText || isGenerating) return;

        const idea = ideaInput.value.trim();
        const platform = platformSelect.value;
        const tone = toneSelect.value;

        if (!idea || !platform || !tone || !userEmail) return;
        if (!isPro && freeUses >= MAX_FREE_USES) {
          paywall.classList.remove('hidden');
          return;
        }

        boostedOnce = true;
        isGenerating = true;
        boostBtn.disabled = true;
        boostBtn.classList.add('disabled');
        boostBtn.textContent = 'Boosting...';

        try {
          const res = await fetch(`${API_URL}/boost`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              idea,
              platform,
              tone,
              email: userEmail,
              originalText: lastRawText
            })
          });

          const data = await res.json();

          if (res.status === 402) {
            paywall.classList.remove('hidden');
            return;
          }

          const boostedText = data.result || 'No result';
          const boostedScore = typeof data.score === 'number'
            ? data.score
            : computeEngagementScoreLocal(boostedText, idea, platform, tone);

          outputEl.textContent = boostedText;
          lastRawText = boostedText;

          const prev = lastScore || boostedScore;
          lastScore = boostedScore;
          renderEngagement(boostedScore, prev);

          if (!isPro) {
            freeUses += 1;
            localStorage.setItem('freeUses', String(freeUses));
          }

        } catch (err) {
          console.error(err);
          alert('Boost failed. Please try again.');
        } finally {
          boostBtn.textContent = 'Boost My Score';
          isGenerating = false;
          updateGenerateButtonState();
        }
      });
    }

    // Form submit
    captionForm.addEventListener('submit', e => {
      e.preventDefault();
      tryGenerate();
    });

    // Tabs for analysis (simple deterministic score as before)
    function detectPlatform(url) {
      const u = url.toLowerCase();
      if (u.includes('instagram.com')) return 'Instagram';
      if (u.includes('twitter.com') || u.includes('x.com')) return 'Twitter';
      if (u.includes('linkedin.com')) return 'LinkedIn';
      if (u.includes('tiktok.com')) return 'TikTok';
      return 'Instagram';
    }
    function hashString(str) {
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        hash = ((hash << 5) - hash) + str.charCodeAt(i);
        hash |= 0;
      }
      return Math.abs(hash);
    }
    function generateDeterministicScore(url) {
      const seed = hashString(url.toLowerCase().trim());
      const score = (seed % 35) + 60; // 60‚Äì94
      return score;
    }

    const analyzeFormEl = document.getElementById('analyzeForm');
    const analysisScoreEl = document.getElementById('analysisScore');
    const analysisDetailsEl = document.getElementById('analysisDetails');
    const competitorUrlInput = document.getElementById('competitorUrl');
    const analyzeAgainBtn = document.getElementById('analyzeAgainBtn');

    if (analyzeFormEl) {
      analyzeFormEl.addEventListener('submit', e => {
        e.preventDefault();
        if (!isPro) return;

        const url = competitorUrlInput.value.trim();
        if (!url) return;

        const platform = detectPlatform(url);
        const score = generateDeterministicScore(url);

        analysisScoreEl.textContent = score;
        analysisDetailsEl.innerHTML = `
          <p><strong>Platform Detected:</strong> ${platform}</p>
          <p><strong>Hook Score:</strong> ${score > 85 ? 'Strong, curiosity-driven hook.' : score > 75 ? 'Decent hook, but could be clearer.' : 'Weak hook, lacks a clear promise.'}</p>
          <p><strong>Readability:</strong> ${score > 85 ? 'Short lines, great spacing.' : score > 75 ? 'Readable but a bit dense.' : 'Feels like a wall of text.'}</p>
          <p><strong>Hashtags:</strong> ${score > 85 ? 'Relevant and mostly niche.' : score > 75 ? 'Mix of broad and niche tags.' : 'Too generic or mis-aligned.'}</p>
          <p><strong>CTA:</strong> ${score > 85 ? 'Clear, specific ask.' : score > 75 ? 'Present but generic.' : 'No real CTA present.'}</p>
        `;
        analysisResult.classList.remove('hidden');
      });
    }

    if (analyzeAgainBtn) {
      analyzeAgainBtn.addEventListener('click', () => {
        competitorUrlInput.value = '';
        analysisResult.classList.add('hidden');
        competitorUrlInput.focus();
      });
    }

    // Email modal
    function startAppAfterEmail() {
      modal.style.display = 'none';
      mainApp.style.display = 'block';
      updateUIState();
      updateGenerateButtonState();
    }

    if (!userEmail) {
      emailSubmit.addEventListener('click', () => {
        const email = emailInput.value.trim();
        if (email && /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
          userEmail = email;
          localStorage.setItem('userEmail', email);
          localStorage.setItem('freeUses', '0');
          freeUses = 0;
          startAppAfterEmail();
        } else {
          emailInput.style.borderColor = '#ef4444';
          emailInput.focus();
        }
      });
    } else {
      startAppAfterEmail();
    }
  });
  </script>
</body>
</html>
