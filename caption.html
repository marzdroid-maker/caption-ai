<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI Caption + Hashtag Generator</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ü§ñ</text></svg>">
  
  <meta property="og:title" content="AI Caption Generator">
  <meta property="og:description" content="Get viral captions in seconds.">
  <meta property="og:image" content="https://images.unsplash.com/photo-1611162617474-5b21e879e113?q=80&w=1200&auto=format&fit=crop">

  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f0f9ff; padding: 2rem 1rem; color: #111; }
    .container { max-width: 600px; margin: 0 auto; }
    .hidden { display: none !important; }
    
    /* UI Elements */
    button { width: 100%; padding: 1rem; background: #3b82f6; color: white; border: none; border-radius: 0.5rem; font-weight: 600; cursor: pointer; margin-top: 1rem; transition: background 0.2s; }
    button:hover { background: #2563eb; }
    button:disabled { background: #93c5fd; cursor: not-allowed; }
    
    input, select, textarea { width: 100%; padding: 0.75rem; margin-bottom: 1rem; border: 2px solid #e5e7eb; border-radius: 0.5rem; box-sizing: border-box; font-family: inherit; }
    input:focus, select:focus { border-color: #3b82f6; outline: none; }
    
    .result { background: white; padding: 1.5rem; border-radius: 0.5rem; margin-top: 2rem; white-space: pre-wrap; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    
    /* Image Upload */
    .upload-area { border: 2px dashed #cbd5e1; border-radius: 0.5rem; padding: 1.5rem; text-align: center; cursor: pointer; background: white; margin-bottom: 1rem; transition: border 0.2s; }
    .upload-area:hover { border-color: #3b82f6; background: #eff6ff; }
    .upload-preview { max-width: 100%; max-height: 200px; border-radius: 0.5rem; margin-top: 1rem; display: none; object-fit: contain; }
    
    /* Tabs */
    .tabs { display: flex; margin-bottom: 1.5rem; border-bottom: 2px solid #e5e7eb; }
    .tab-btn { flex: 1; padding: 0.75rem; background: none; border: none; font-weight: 600; color: #6b7280; border-bottom: 3px solid transparent; margin-top: 0; }
    .tab-btn.active { color: #3b82f6; border-bottom-color: #3b82f6; }
    
    /* Misc */
    #proBadge { display: inline-flex; align-items: center; background: linear-gradient(135deg, #4f46e5, #7c3aed); color: white; border-radius: 999px; padding: 0.2rem 0.6rem; font-size: 0.75rem; font-weight: 700; margin-left: 0.5rem; vertical-align: middle; }
    .paywall { background: #fffbeb; border: 1px solid #fcd34d; padding: 1.5rem; border-radius: 0.5rem; text-align: center; margin-top: 1rem; }
    .paywall button { background: #d97706; }
  </style>
</head>
<body>

  <div id="emailModal" style="position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 999;">
    <div style="background: white; padding: 2rem; border-radius: 1rem; text-align: center; width: 90%; max-width: 400px;">
        <h2>Welcome!</h2>
        <p>Enter email for 10 free generations.</p>
        <input type="email" id="emailInput" placeholder="you@email.com">
        <button id="emailSubmit">Start</button>
    </div>
  </div>

  <div class="container" id="mainApp" class="hidden">
      <h1 style="text-align: center;">Caption AI <span id="proBadge" class="hidden">PRO</span></h1>
      
      <div class="tabs">
          <button class="tab-btn active" id="tabGen">Generate</button>
          <button class="tab-btn" id="tabVoice">Voice (Pro)</button>
      </div>

      <div id="viewGen">
          <div class="upload-area" id="uploadArea">
              <p>üì∏ Upload Image (Optional)</p>
              <input type="file" id="fileInput" accept="image/*" class="hidden">
              <img id="imagePreview" class="upload-preview">
              <button id="removeImage" class="hidden" style="background: #ef4444; padding: 0.5rem; width: auto; font-size: 0.8rem;">Remove</button>
          </div>

          <label>Post Idea:</label>
          <input type="text" id="idea" placeholder="e.g. Just launched my coffee shop...">
          
          <label>Platform:</label>
          <select id="platform">
              <option>Instagram</option><option>LinkedIn</option><option>Twitter</option><option>TikTok</option>
          </select>
          
          <label>Tone:</label>
          <select id="tone">
              <option>Fun</option><option>Professional</option><option>Bold</option>
          </select>

          <div id="voiceOption" class="hidden" style="background: #eff6ff; padding: 0.5rem; border-radius: 0.5rem; margin-bottom: 1rem;">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; margin: 0;">
                  <input type="checkbox" id="useVoice" style="width: auto; margin: 0;"> Use My Brand Voice üé®
              </label>
          </div>

          <button id="generateBtn">Generate Captions</button>
          
          <div id="loading" class="hidden" style="text-align: center; margin-top: 1rem; color: #666;">Thinking...</div>
          <div id="result" class="result hidden"></div>
          
          <div id="paywall" class="paywall hidden">
              <h3>Limit Reached</h3>
              <p>Upgrade for unlimited captions + Brand Voice.</p>
              <button id="subscribeBtn">Upgrade ($7/mo)</button>
          </div>
      </div>

      <div id="viewVoice" class="hidden">
          <div style="background: #eff6ff; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
              <h4>Style Thief üïµÔ∏è‚Äç‚ôÇÔ∏è</h4>
              <p>Paste 3 posts to clone your writing style.</p>
          </div>
          
          <div id="voiceActive" class="hidden" style="text-align: center; padding: 2rem; background: #ecfdf5; border-radius: 0.5rem; color: #047857;">
              <h3>‚úÖ Voice Active</h3>
              <button id="deleteVoiceBtn" style="background: #ef4444; width: auto;">Delete & Reset</button>
          </div>

          <div id="voiceForm">
              <textarea id="v1" rows="3" placeholder="Paste post 1..."></textarea>
              <textarea id="v2" rows="3" placeholder="Paste post 2..."></textarea>
              <textarea id="v3" rows="3" placeholder="Paste post 3..."></textarea>
              <button id="saveVoiceBtn">Analyze & Save Voice</button>
          </div>
          
          <div id="voicePaywall" class="paywall hidden">
              <h3>Pro Feature</h3>
              <button id="subVoiceBtn">Upgrade to Unlock</button>
          </div>
      </div>

      <div style="margin-top: 4rem; text-align: center; border-top: 1px solid #eee; padding-top: 2rem;">
          <p style="font-size: 0.9rem; color: #666;">Love this tool? Earn 30% commission.</p>
          <button id="affiliateBtn" style="background:none; color:#2563eb; text-decoration:underline; width:auto; padding:0; margin:0;">Join Affiliate Program</button>
      </div>
  </div>

<script>
const API_URL = 'https://caption-ai-ze13.onrender.com';
let userEmail = localStorage.getItem('userEmail');
let uploadedImageBase64 = null;
let isPro = false;

// --- INIT ---
if (userEmail) {
    document.getElementById('emailModal').style.display = 'none';
    document.getElementById('mainApp').classList.remove('hidden');
    checkSub();
}

document.getElementById('emailSubmit').onclick = () => {
    const email = document.getElementById('emailInput').value;
    if(email && email.includes('@')) {
        localStorage.setItem('userEmail', email);
        userEmail = email;
        document.getElementById('emailModal').style.display = 'none';
        document.getElementById('mainApp').classList.remove('hidden');
        checkSub();
    }
};

async function checkSub() {
    try {
        const res = await fetch(`${API_URL}/check-subscription?email=${encodeURIComponent(userEmail)}`);
        const data = await res.json();
        isPro = data.isPro;
        
        if(isPro) {
            document.getElementById('proBadge').classList.remove('hidden');
            document.getElementById('voicePaywall').classList.add('hidden');
            document.getElementById('paywall').classList.add('hidden');
            if(data.hasVoice) {
                document.getElementById('voiceOption').classList.remove('hidden');
                document.getElementById('voiceActive').classList.remove('hidden');
                document.getElementById('voiceForm').classList.add('hidden');
            }
        }
    } catch(e) { console.error(e); }
}

// --- TABS ---
const tabGen = document.getElementById('tabGen');
const tabVoice = document.getElementById('tabVoice');
const viewGen = document.getElementById('viewGen');
const viewVoice = document.getElementById('viewVoice');

tabGen.onclick = () => {
    viewGen.classList.remove('hidden');
    viewVoice.classList.add('hidden');
    tabGen.classList.add('active');
    tabVoice.classList.remove('active');
};

tabVoice.onclick = () => {
    viewGen.classList.add('hidden');
    viewVoice.classList.remove('hidden');
    tabGen.classList.remove('active');
    tabVoice.classList.add('active');
};

// --- IMAGE UPLOAD ---
const fileInput = document.getElementById('fileInput');
const uploadArea = document.getElementById('uploadArea');

uploadArea.onclick = (e) => { if(e.target.id !== 'removeImage') fileInput.click(); };

fileInput.onchange = (e) => {
    const file = e.target.files[0];
    if (file) {
        if(file.size > 10*1024*1024) { alert("File too large (Max 10MB)"); return; }
        const reader = new FileReader();
        reader.onload = (ev) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const max = 1024; 
                let w = img.width, h = img.height;
                if (w > h) { if (w > max) { h *= max/w; w = max; } } 
                else { if (h > max) { w *= max/h; h = max; } }
                canvas.width = w; canvas.height = h;
                ctx.drawImage(img, 0, 0, w, h);
                uploadedImageBase64 = canvas.toDataURL('image/jpeg', 0.8);
                document.getElementById('imagePreview').src = uploadedImageBase64;
                document.getElementById('imagePreview').classList.remove('hidden');
                document.getElementById('removeImage').classList.remove('hidden');
            };
            img.src = ev.target.result;
        };
        reader.readAsDataURL(file);
    }
};

document.getElementById('removeImage').onclick = (e) => {
    e.stopPropagation();
    uploadedImageBase64 = null;
    fileInput.value = '';
    document.getElementById('imagePreview').classList.add('hidden');
    document.getElementById('removeImage').classList.add('hidden');
};

// --- GENERATE ---
document.getElementById('generateBtn').onclick = async () => {
    const idea = document.getElementById('idea').value;
    const platform = document.getElementById('platform').value;
    const tone = document.getElementById('tone').value;
    const useVoice = document.getElementById('useVoice').checked;
    const btn = document.getElementById('generateBtn');

    if ((!idea && !uploadedImageBase64)) { alert("Enter an idea or upload an image."); return; }

    btn.disabled = true;
    btn.innerText = "Thinking...";
    document.getElementById('loading').classList.remove('hidden');
    document.getElementById('result').classList.add('hidden');

    try {
        const res = await fetch(`${API_URL}/generate`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ idea, platform, tone, email: userEmail, image: uploadedImageBase64, useVoice })
        });
        const data = await res.json();
        
        if (res.ok) {
            document.getElementById('result').innerText = data.result;
            document.getElementById('result').classList.remove('hidden');
        } else if (res.status === 402) {
            document.getElementById('paywall').classList.remove('hidden');
        } else {
            alert("Error: " + (data.error || "Failed"));
        }
    } catch (e) { alert("Network error."); } 
    finally {
        btn.disabled = false;
        btn.innerText = "Generate Captions";
        document.getElementById('loading').classList.add('hidden');
    }
};

// --- VOICE ---
document.getElementById('saveVoiceBtn').onclick = async () => {
    const s1 = document.getElementById('v1').value;
    const s2 = document.getElementById('v2').value;
    const s3 = document.getElementById('v3').value;
    const samples = [s1, s2, s3].join("\n\n");
    const btn = document.getElementById('saveVoiceBtn');

    if(samples.length < 20) { alert("Paste some content first!"); return; }
    
    btn.disabled = true;
    btn.innerText = "Analyzing...";

    try {
        const res = await fetch(`${API_URL}/save-voice`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: userEmail, samples })
        });
        if(res.ok) {
            location.reload();
        } else {
            const d = await res.json();
            alert(d.error || "Failed. Are you Pro?");
        }
    } catch(e) { alert("Error"); }
    finally { btn.disabled = false; btn.innerText = "Analyze & Save Voice"; }
};

document.getElementById('deleteVoiceBtn').onclick = async () => {
    if(!confirm("Delete your voice profile?")) return;
    await fetch(`${API_URL}/delete-voice`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: userEmail })
    });
    location.reload();
};

// --- PAYMENTS & AFFILIATE ---
document.getElementById('subscribeBtn').onclick = () => startCheckout();
document.getElementById('subVoiceBtn').onclick = () => startCheckout();

async function startCheckout() {
    const res = await fetch(`${API_URL}/create-checkout-session`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: userEmail, referralCode: localStorage.getItem('referralCode') })
    });
    const d = await res.json();
    if(d.url) window.location.href = d.url;
}

document.getElementById('affiliateBtn').onclick = async () => {
    const btn = document.getElementById('affiliateBtn');
    btn.innerText = "Connecting...";
    try {
        // Check if existing affiliate
        const localId = localStorage.getItem('connectId');
        if(localId) {
             // Show link logic here (omitted for brevity, assuming new signup flow)
        }

        const res = await fetch(`${API_URL}/create-connect-account`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: userEmail })
        });
        const d = await res.json();
        if(d.onboardingUrl) {
            localStorage.setItem('connectId', d.connectAccountId);
            window.location.href = d.onboardingUrl;
        } else {
            alert(d.error || "Error");
        }
    } catch(e) { alert("Connection failed"); }
    finally { btn.innerText = "Join Affiliate Program"; }
};
</script>
</body>
</html>
