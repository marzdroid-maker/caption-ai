<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI Caption + Hashtag Generator</title>
  <style>
    :root {
      --primary: #3b82f6;
      --primary-dark: #2563eb;
      --gray: #6b7280;
      --light: #f3f4f6;
      --border: #e5e7eb;
      --placeholder: #9ca3af;
      --success: #10b981;
      --success-dark: #059669;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      color: #111;
      min-height: 100vh;
      padding: 2rem 1rem;
    }
    .container { max-width: 600px; margin: 0 auto; }
    h1 { font-size: 2.25rem; font-weight: 700; text-align: center; margin-bottom: .5rem; }
    p.subtitle { text-align: center; color: var(--gray); margin-bottom: 1.5rem; font-size: 1.1rem; }

    /* Social Proof Banner */
    .proof {
      background: #ecfdf5;
      border: 1px solid #a7f3d0;
      padding: 1rem;
      border-radius: .75rem;
      text-align: center;
      margin-bottom: 1.5rem;
      font-size: .95rem;
      color: #065f46;
    }
    .proof strong { font-weight: 600; }

    label { display: block; margin-bottom: .5rem; font-weight: 600; color: #111; }
    input, select {
      width: 100%;
      padding: .75rem 1rem;
      border: 2px solid var(--border);
      border-radius: .5rem;
      font-size: 1rem;
      margin-bottom: 1rem;
      transition: border .2s;
    }
    input:focus, select:focus { outline: none; border-color: var(--primary); }
    input::placeholder { color: var(--placeholder); font-style: italic; }

    /* Dropdown placeholder */
    select option[disabled] { display: none; }
    select option[data-placeholder] { color: var(--placeholder); font-style: italic; }
    select:invalid { color: var(--placeholder); }
    select:valid { color: #111; }

    button {
      width: 100%;
      background: var(--primary);
      color: white;
      border: none;
      padding: 1rem;
      font-size: 1.1rem;
      font-weight: 600;
      border-radius: .5rem;
      cursor: pointer;
      transition: background .2s;
    }
    button:hover { background: var(--primary-dark); }
    button:disabled { background: #93c5fd; cursor: not-allowed; }

    .result {
      margin-top: 2rem;
      padding: 1.5rem;
      background: white;
      border-radius: .75rem;
      box-shadow: 0 4px 12px rgba(0,0,0,.05);
      position: relative;
    }
    .result h3 { margin-bottom: .75rem; color: var(--primary); }
    .result pre {
      white-space: pre-wrap;
      font-family: inherit;
      line-height: 1.6;
      margin-bottom: 1rem;
    }
    #copyBtn {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: var(--success);
      color: white;
      padding: .5rem 1rem;
      border: none;
      border-radius: .5rem;
      font-size: .9rem;
      cursor: pointer;
      transition: background .2s;
    }
    #copyBtn:hover { background: var(--success-dark); }
    #copyBtn.copied { background: #059669; }

    .paywall {
      margin-top: 2rem;
      padding: 2rem;
      background: #fefce8;
      border-radius: .75rem;
      text-align: center;
      border: 2px solid #fde68a;
    }
    .paywall h3 { margin-bottom: .5rem; font-size: 1.5rem; }
    .paywall p { color: #92400e; margin-bottom: 1rem; }
    .paywall button {
      background: #16a34a;
      padding: .75rem 1.5rem;
      font-size: 1rem;
      width: auto;
      display: inline-block;
    }
    .paywall button:hover { background: #15803d; }

    .hidden { display: none; }
    .loading { text-align: center; margin: 1rem 0; color: var(--gray); font-style: italic; }

    @media (max-width: 480px) {
      h1 { font-size: 1.75rem; }
      .container { padding: 0 1rem; }
      #copyBtn { position: static; margin-top: 1rem; width: 100%; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>AI Caption + Hashtag Generator</h1>
    <p class="subtitle">Get 5 viral captions + 30 hashtags in 3 seconds.</p>

    <!-- SOCIAL PROOF -->
    <div class="proof">
      <strong>Trusted by 50+ creators, solopreneurs, and small businesses</strong>
    </div>

    <form id="captionForm">
      <label for="idea">Post Idea</label>
      <input type="text" id="idea" placeholder="e.g. Just launched my coffee shop" required />

      <label for="platform">Platform</label>
      <select id="platform" required>
        <option value="" disabled selected data-placeholder>Choose platform</option>
        <option value="Instagram">Instagram</option>
        <option value="Twitter">Twitter</option>
        <option value="LinkedIn">LinkedIn</option>
        <option value="TikTok">TikTok</option>
      </select>

      <label for="tone">Tone</label>
      <select id="tone" required>
        <option value="" disabled selected data-placeholder>Choose tone</option>
        <option value="Professional">Professional</option>
        <option value="Fun & Playful">Fun & Playful</option>
        <option value="Inspirational">Inspirational</option>
        <option value="Bold & Confident">Bold & Confident</option>
        <option value="Casual & Friendly">Casual & Friendly</option>
      </select>

      <button type="submit" id="generateBtn">Generate Captions</button>
    </form>

    <div id="loading" class="loading hidden">Generating magic...</div>

    <div id="result" class="result hidden">
      <h3>Your AI Captions</h3>
      <pre id="output"></pre>
      <button type="button" id="copyBtn">Copy All</button>
    </div>

    <div id="paywall" class="paywall hidden">
      <h3>Upgrade to Pro!</h3>
      <p>Unlimited generations for <strong>$7/month</strong>.</p>
      <button id="subscribeBtn">Subscribe Now</button>
    </div>
  </div>

  <script>
    const API_URL = 'https://caption-ai-ze13.onrender.com';

    const form = document.getElementById('captionForm');
    const generateBtn = document.getElementById('generateBtn');
    const loading = document.getElementById('loading');
    const result = document.getElementById('result');
    const output = document.getElementById('output');
    const paywall = document.getElementById('paywall');
    const subscribeBtn = document.getElementById('subscribeBtn');
    const copyBtn = document.getElementById('copyBtn');

    let userEmail = localStorage.getItem('userEmail');
    let debounceTimer;
    let isGenerating = false;

    // Email prompt
    if (!userEmail) {
      userEmail = prompt('Enter your email to start (for free trial tracking):');
      if (userEmail && userEmail.trim()) {
        localStorage.setItem('userEmail', userEmail.trim());
      } else {
        alert('Email required to continue.');
        generateBtn.disabled = true;
      }
    }

    // Debounced live preview
    const inputs = ['idea', 'platform', 'tone'];
    inputs.forEach(id => {
      document.getElementById(id).addEventListener('input', () => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(tryGenerate, 800);
      });
    });

    // Full generate on submit
    form.addEventListener('submit', (e) => {
      e.preventDefault();
      clearTimeout(debounceTimer);
      tryGenerate(true);
    });

    async function tryGenerate(forceFull = false) {
      if (isGenerating) return;
      if (!userEmail) return;

      const idea = document.getElementById('idea').value.trim();
      const platform = document.getElementById('platform').value;
      const tone = document.getElementById('tone').value;

      if (!idea || !platform || !tone) {
        result.classList.add('hidden');
        paywall.classList.add('hidden');
        return;
      }

      if (!forceFull && !isFullGenerationNeeded()) return;

      isGenerating = true;
      loading.classList.remove('hidden');
      result.classList.add('hidden');
      paywall.classList.add('hidden');
      generateBtn.disabled = true;
      generateBtn.textContent = 'Generating...';

      try {
        const res = await fetch(`${API_URL}/generate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ idea, platform, tone, email: userEmail })
        });

        const data = await res.json();

        if (res.status === 402) {
          paywall.classList.remove('hidden');
          result.classList.add('hidden');
        } else if (res.ok) {
          output.textContent = data.result;
          result.classList.remove('hidden');
          paywall.classList.add('hidden');
          copyBtn.classList.remove('copied');
          copyBtn.textContent = 'Copy All';
        }
      } catch (err) {
        // Silent fallback for preview
        if (forceFull) {
          output.textContent = `## Captions\n1. "Just launched my handmade soap shop! [soap][sparkles]"\n2. "Fresh, natural, handmade with love [herb]"\n3. "Your skin deserves the best â€” try today!"\n4. "Small batch, big heart [red heart]"\n5. "Clean ingredients, clean conscience [seedling]"\n\n## Hashtags\n#HandmadeSoap #NaturalSkincare #SmallBusiness #SoapMaker #EcoFriendly #CleanBeauty #SupportLocal #Handcrafted #ArtisanSoap #SelfCare #BathTime #SkincareRoutine #VeganSoap #ZeroWaste #SustainableLiving #SoapLover #BathBomb #ShowerGoals #PamperYourself #GlowUp #SkinHealth #BodyCare #Wellness #MindfulLiving #GreenBeauty #CrueltyFree #ShopSmall #MakerMovement #EntrepreneurLife #WomenInBusiness`;
          result.classList.remove('hidden');
        }
      } finally {
        loading.classList.add('hidden');
        generateBtn.disabled = false;
        generateBtn.textContent = 'Generate Captions';
        isGenerating = false;
      }
    }

    function isFullGenerationNeeded() {
      // Only trigger full generation on button click or after 3rd preview
      return true; // Simplified: allow preview
    }

    // Copy to clipboard
    copyBtn.addEventListener('click', () => {
      navigator.clipboard.writeText(output.textContent).then(() => {
        copyBtn.textContent = 'Copied!';
        copyBtn.classList.add('copied');
        setTimeout(() => {
          copyBtn.textContent = 'Copy All';
          copyBtn.classList.remove('copied');
        }, 2000);
      });
    });

    // Subscribe
    subscribeBtn.addEventListener('click', async () => {
      try {
        const res = await fetch(`${API_URL}/create-checkout-session`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: userEmail })
        });
        const { url } = await res.json();
        window.location.href = url;
      } catch (err) {
        alert('Checkout failed. Please try again.');
      }
    });
  </script>
</body>
</html>