<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI Caption + Hashtag Generator</title>
  <style>
    :root {
      --primary: #3b82f6;
      --primary-dark: #2563eb;
      --gray: #6b7280;
      --light: #f3f4f6;
      --border: #e5e7eb;
      --placeholder: #9ca3af;
      --success: #10b981;
      --success-dark: #059669;
      --error: #ef4444;
      --warning: #f59e0b;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      color: #111;
      min-height: 100vh;
      padding: 2rem 1rem;
    }
    .container { max-width: 600px; margin: 0 auto; }
    h1 { font-size: 2.25rem; font-weight: 700; text-align: center; margin-bottom: .5rem; }
    p.subtitle { text-align: center; color: var(--gray); margin-bottom: 1.5rem; font-size: 1.1rem; }

    .proof {
      background: #ecfdf5;
      border: 1px solid #a7f3d0;
      padding: 1rem;
      border-radius: .75rem;
      text-align: center;
      margin-bottom: 1.5rem;
      font-size: .95rem;
      color: #065f46;
    }
    .proof strong { font-weight: 600; }

    /* Daily tip */
    #dailyTipBox {
      background: #fff;
      border: 1px solid #d1d5db;
      padding: 1rem;
      border-radius: .75rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 5px rgba(0,0,0,0.02);
      font-size: .95rem;
      line-height: 1.4;
    }
    #dailyTipBox strong {
      color: var(--warning);
      margin-right: .5rem;
    }

    /* Email modal */
    #emailModal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.7); display: flex; align-items: center;
      justify-content: center; z-index: 9999;
    }
    .modal-content {
      background: white; padding: 2rem; border-radius: 1rem;
      width: 90%; max-width: 400px; text-align: center;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }
    .modal-content h2 { margin-bottom: 1rem; font-size: 1.5rem; }
    .modal-content p { margin-bottom: 1.5rem; color: #555; }
    .modal-content input {
      width: 100%; padding: .75rem; border: 2px solid #e5e7eb;
      border-radius: .5rem; font-size: 1rem; margin-bottom: 1rem;
    }
    .modal-content button {
      background: var(--primary); color: white; border: none;
      padding: .75rem 1.5rem; border-radius: .5rem; font-weight: 600;
      cursor: pointer; width: 100%;
    }

    label { display: block; margin-bottom: .5rem; font-weight: 600; color: #111; }
    input, select {
      width: 100%; padding: .75rem 1rem; border: 2px solid var(--border);
      border-radius: .5rem; font-size: 1rem; margin-bottom: 1rem;
      transition: border .2s;
    }
    input:focus, select:focus { outline: none; border-color: var(--primary); }
    input::placeholder { color: var(--placeholder); font-style: italic; }

    select option[disabled] { display: none; }
    select option[data-placeholder] { color: var(--placeholder); font-style: italic; }
    select:invalid { color: var(--placeholder); }
    select:valid { color: #111; }

    button {
      width: 100%; background: var(--primary); color: white; border: none;
      padding: 1rem; font-size: 1.1rem; font-weight: 600; border-radius: .5rem;
      cursor: pointer; transition: background .2s;
    }
    button:hover { background: var(--primary-dark); }
    button:disabled { background: #93c5fd; cursor: not-allowed; }

    /* Tabs */
    #tabHeader {
      display: flex;
      margin-bottom: 1.5rem;
      border-bottom: 2px solid var(--border);
    }
    .tab-btn {
      flex: 1;
      padding: 0.75rem 0;
      background: none;
      border: none;
      font-weight: 600;
      cursor: pointer;
      color: var(--gray);
      font-size: 1.1rem;
      border-bottom: 3px solid transparent;
      transition: color 0.2s, border-bottom 0.2s;
      border-radius: 0;
      width: auto;
    }
    .tab-btn.active {
      color: var(--primary);
      border-bottom: 3px solid var(--primary);
    }

    .tab-content { padding: 0; }

    /* Result card */
    .result {
      margin-top: 2rem; padding: 1.5rem; background: white; border-radius: .75rem;
      box-shadow: 0 4px 12px rgba(0,0,0,.05); position: relative;
    }
    .result h3 { margin-bottom: .75rem; color: var(--primary); }
    .result pre {
      white-space: pre-wrap; font-family: inherit; line-height: 1.6; margin-bottom: 1rem;
    }

    /* Engagement box */
    .engagement-box {
      display: none;
      margin-bottom: 1rem;
      padding: 0.85rem 0.9rem;
      border-radius: 0.75rem;
      background: #eff6ff;
      border: 1px solid #bfdbfe;
    }
    .engagement-main {
      display: flex;
      align-items: baseline;
      gap: 0.35rem;
      margin-bottom: 0.25rem;
    }
    .engagement-title {
      font-size: 0.9rem;
      font-weight: 600;
      color: #1d4ed8;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    .engagement-value {
      font-size: 1.5rem;
      font-weight: 700;
    }
    .engagement-max {
      font-size: 0.9rem;
      color: #4b5563;
    }
    .engagement-subtext {
      font-size: 0.8rem;
      color: #4b5563;
      margin-bottom: 0.5rem;
    }
    .boost-btn {
      width: 100%;
      background: #16a34a;
      font-size: 0.95rem;
      padding: 0.6rem 0.9rem;
      border-radius: 0.6rem;
      font-weight: 600;
    }
    .boost-btn.used {
      background: #9ca3af;
      cursor: default;
    }

    #copyBtn {
      position: absolute; top: 1rem; right: 1rem; background: var(--success);
      color: white; padding: .5rem 1rem; border: none; border-radius: .5rem;
      font-size: .9rem; cursor: pointer; transition: background .2s;
    }
    #copyBtn:hover { background: var(--success-dark); }
    #copyBtn.copied { background: #059669; }

    /* Emoji picker */
    #emojiPickerBtn {
      background: var(--warning); margin: 1rem 0; width: auto; padding: .5rem 1rem; font-size: .9rem;
    }
    .emoji-picker-container {
      position: relative;
      text-align: left;
      display: flex;
      justify-content: center;
    }
    #emojiPicker {
      display: none;
      position: absolute;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: .75rem;
      padding: .75rem;
      width: 300px;
      height: 250px;
      overflow-y: scroll;
      box-shadow: 0 4px 12px rgba(0,0,0,.1);
      z-index: 10;
      top: 100%; /* Position below the button */
      left: 50%;
      transform: translateX(-50%);
    }
    .emoji-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: .25rem;
    }
    .emoji-item {
      font-size: 1.5rem;
      text-align: center;
      cursor: pointer;
      line-height: 1.5;
    }

    /* Footer */
    footer {
      text-align: center;
      margin-top: 3rem;
      font-size: .85rem;
      color: var(--gray);
    }
    footer a {
      color: var(--gray);
      text-decoration: none;
      margin: 0 .5rem;
    }

    /* Pro badge */
    #proBadge {
      display: none; /* controlled by JS */
      align-items: center;
      gap: 0.25rem;
      background: linear-gradient(135deg, #4f46e5, #7c3aed);
      color: white;
      border-radius: 999px;
      padding: 0.2rem 0.6rem;
      font-size: 0.75rem;
      font-weight: 600;
      margin-left: 0.5rem;
    }
    .pro-status {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 0.5rem;
    }
    
    /* Pro Templates */
    #proTemplates {
        margin-top: 2rem;
        padding: 1.5rem;
        background: #f0fdf4;
        border: 1px solid #bbf7d0;
        border-radius: .75rem;
        display: none; /* Default hidden, shown by JS */
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }
    .templateBtn { 
        text-align: left; 
        padding: .75rem; 
        background: white; 
        border: 1px solid #d1d5db; 
        border-radius: .5rem; 
        font-size: .9rem; 
        cursor: pointer; 
        color: #111 !important; 
        line-height: 1.4;
        box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        height: auto;
        width: 100%;
        margin-bottom: 0;
    }
    
    #templateTeaser {
        margin-top: 2rem;
        padding: 1.5rem;
        background: #fef2f2;
        border: 1px solid #fecaca;
        border-radius: .75rem;
        text-align: center;
    }
    #templateTeaser h3 { color: var(--error); margin-bottom: 0.75rem; }
    
    /* Paywall */
    #paywall {
        background: #fff;
        padding: 1.5rem;
        border-radius: 0.75rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        margin-top: 1.5rem;
        text-align: center;
    }
    #paywall h3 { color: var(--error); margin-bottom: 0.75rem; }

    /* Toast Notification */
    #toast {
      position: fixed; bottom: 1.5rem; left: 50%; transform: translateX(-50%);
      padding: 0.75rem 1.5rem; border-radius: 0.5rem; color: white;
      font-weight: 500; z-index: 10000;
      transition: opacity 0.3s, transform 0.3s;
      opacity: 0;
    }
    #toast.toast-success { background: #047857; }
    #toast.toast-error { background: #b91c1c; }
    #toast.toast-info { background: #111827; }
    #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
    #toast.hidden { display: none; }
  </style>
</head>
<body>

  <div id="emailModal">
    <div class="modal-content">
      <h2>Welcome to Caption AI</h2>
      <p>Enter your email to get 10 free generations. No credit card needed!</p>
      <input type="email" id="emailInput" placeholder="your@email.com" required>
      <button id="emailSubmit">Start Generating</button>
    </div>
  </div>

  <div id="mainApp" class="container" style="display: none;">
    <div class="pro-status">
        <h1 style="margin-bottom: 0;">Caption AI</h1>
        <span id="proBadge" class="hidden">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5" style="width: 1rem; height: 1rem;">
                <path fill-rule="evenodd" d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16ZM5.755 8.246A.75.75 0 0 1 6.82 7.23a1.5 1.5 0 0 0 2.227 0l2.352 1.411A.75.75 0 0 1 11 9.928a.75.75 0 0 1-.832.748L8.163 9.471a.75.75 0 0 1-.74-.038L5.755 8.246Z" clip-rule="evenodd" />
            </svg>
            PRO
        </span>
    </div>
    <p class="subtitle">Instantly generate viral captions, hooks, and hashtags using the fastest AI on earth.</p>

    <div id="tabHeader">
        <button class="tab-btn active" data-tab="1">Generator</button>
        <button class="tab-btn" data-tab="2">Analyze</button>
        <button class="tab-btn" data-tab="3">Affiliates</button>
    </div>

    <div id="generatorContent" class="tab-content" data-tab="1">
      
      <div id="dailyTipBox">
        <strong>üí° Daily Tip:</strong> <span id="dailyTip"></span>
      </div>

      <div class="proof">
          <span id="freeUsageBar"></span>
      </div>

      <form id="captionForm">
        <label for="idea">What is your content idea?</label>
        <input type="text" id="idea" placeholder="e.g., How to save $500/month by making your own coffee" required>

        <label for="platform">Platform</label>
        <select id="platform" required>
          <option value="" disabled selected data-placeholder>Select a platform</option>
          <option value="Instagram">Instagram</option>
          <option value="TikTok">TikTok / Reels</option>
          <option value="X (Twitter)">X (Twitter)</option>
          <option value="LinkedIn">LinkedIn</option>
          <option value="YouTube">YouTube Short/Description</option>
        </select>

        <label for="tone">Tone</label>
        <select id="tone" required>
          <option value="" disabled selected data-placeholder>Select a tone</option>
          <option value="Authoritative">Authoritative / Expert</option>
          <option value="Witty">Witty / Humorous</option>
          <option value="Empathetic">Empathetic / Relatable</option>
          <option value="Motivating">Motivating / Inspirational</option>
          <option value="Educational">Educational / Tutorial</option>
        </select>

        <div id="emojiPickerBtnWrapper" class="emoji-picker-container">
            <button type="button" id="emojiPickerBtn">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6" style="width: 1.25rem; height: 1.25rem; margin-right: 0.5rem; vertical-align: middle;">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.182 14.225-.972 5.06a.75.75 0 0 1 1.054-.913l3.057 1.223 1.908-1.526a.75.75 0 0 1 .792-.005l3.522 2.766 2.5-2.822a.75.75 0 0 1 1.252.012l.685 1.55l3.243-.997a.75.75 0 0 1 .913 1.054l-1.223 3.057 1.526 1.908a.75.75 0 0 1 .005.792l-2.766 3.522 2.822 2.5a.75.75 0 0 1-.012 1.252l-1.55.685-3.243-.997a.75.75 0 0 1-1.054-.913l1.223-3.057-1.908-1.526a.75.75 0 0 1-.792.005L7.904 15.34l-2.5 2.822a.75.75 0 0 1-1.252-.012l-.685-1.55L.972 15.137a.75.75 0 0 1-.913-1.054Z" />
                </svg>
                Add Emojis for Vibe
            </button>
            <div id="emojiPicker">
                <div class="emoji-grid">
                    </div>
            </div>
        </div>


        <button type="submit" id="generateBtn">Generate Caption</button>
      </form>
      
      <div id="loading" class="result hidden" style="text-align: center;">
        <h3>AI is Working...</h3>
        <p>Creating your captions at lightning speed...</p>
      </div>

      <div id="outputContainer" class="result hidden">
        <div class="engagement-box">
            <div class="engagement-main">
                <span class="engagement-title">Estimated Engagement Score</span>
                <span id="engagementScore" class="engagement-value">--</span>
                <span class="engagement-max">/100</span>
            </div>
            <p id="engagementSubtext" class="engagement-subtext"> Higher scores usually mean more saves, comments, and shares. </p>
            <button id="boostBtn" type="button" class="boost-btn">Boost My Score</button>
        </div>

        <pre id="output"></pre>
        <button type="button" id="copyBtn">Copy All</button>
      </div>

      <div id="proTemplates" class="hidden">
        <h3>The Viral Swipe File (PRO)</h3>
        <p style="margin-bottom: 1rem; color: var(--gray); font-size: 0.9rem;">Click to instantly load a proven caption structure.</p>
        <div id="templateContainer" style="display: none; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <button class="templateBtn" data-text="The biggest mistake I see beginners make in [Niche] is [Mistake]. Here‚Äôs the simple [Solution]. üò´ ‚úÖ"> The biggest mistake I see beginners make in [Niche] is [Mistake]. Here‚Äôs the simple [Solution]. üò´ ‚úÖ </button>
            <button class="templateBtn" data-text="6 months ago I was [Stuck]... now I'm [Success]. The difference: [1 Thing]. Thinking Face Light Bulb"> 6 months ago I was [Stuck]... now I'm [Success]. The difference: [1 Thing]. ü§Ø üí° </button>
            <button class="templateBtn" data-text="How I made [High Result] in [Short Time]: Step 1: [Action]. Save for steps 2 & 3. Toolbox Target"> How I made [High Result] in [Short Time]: Step 1: [Action]. Save for steps 2 & 3. üß∞ üéØ </button>
            <button class="templateBtn" data-text="3 things I wish I knew when starting [Skill]: 1. [Tip 1] 2. [Tip 2] 3. [Tip 3]. Bookmark this! üëá"> 3 things I wish I knew when starting [Skill]: 1. [Tip 1] 2. [Tip 2] 3. [Tip 3]. Bookmark this! üëá </button>
            <button class="templateBtn" data-text="If you struggle with [Problem], here is a 15-second fix: [Solution]. Stop struggling! üõë"> If you struggle with [Problem], here is a 15-second fix: [Solution]. Stop struggling! üõë </button>
            <button class="templateBtn" data-text="You only need 2 skills to make money online: [Skill 1] and [Skill 2]. Double check mark money bag"> You only need 2 skills to make money online: [Skill 1] and [Skill 2]. ‚úÖ ‚úÖ üí∞ </button>
        </div>
      </div>

      <div id="templateTeaser">
        <h3>Unlock The Viral Swipe File</h3>
        <p>Upgrade to Pro to get 20+ proven, fill-in-the-blank caption templates that guarantee high engagement.</p>
        <button id="subscribeBtnTeaser">Unlock Now</button>
      </div>

      <div id="paywall" class="hidden">
        <h3>Upgrade to Pro!</h3>
        <p>You've used your 10 free generations. <strong>Unlimited + 20 Viral Swipe File Structures</strong> for <strong>$7/month</strong>.</p>
        <button id="subscribeBtn">Subscribe Now</button>
      </div>
    </div>
    
    <div id="analyzeContent" class="tab-content hidden" data-tab="2">
        <div id="analysisDescription" style="
            background: #f0f9ff; border: 1px solid #bae6fd; padding: 1.2rem; border-radius: .75rem; 
            margin-bottom: 1.5rem; font-size: .95rem; line-height: 1.5; color: #0369a1;
        ">
            <h4 style="margin-bottom: 0.5rem; color: var(--primary);">Caption Analysis (PRO)</h4>
            Paste the URL of any social media post to get an instant breakdown of its virality score, hook quality, readability, and suggested improvements.
        </div>

        <form id="analyzeForm" class="hidden">
            <label for="competitorUrlInput">Competitor Post URL</label>
            <input type="url" id="competitorUrlInput" placeholder="e.g., https://tiktok.com/@user/video/..." required>
            <button type="submit" id="analyzeBtn">Analyze Post</button>
        </form>

        <div id="analysisLoading" class="result hidden" style="text-align: center;">
            <h3>Analyzing Content...</h3>
            <p>Evaluating virality factors and providing actionable feedback.</p>
        </div>

        <div id="analysisResult" class="result hidden">
            <div class="engagement-box" style="display: block; background: #fff; border-color: #d1d5db;">
                <div class="engagement-main">
                    <span class="engagement-title" style="color: var(--success-dark);">Virality Score</span>
                    <span id="analysisScore" class="engagement-value">--</span>
                    <span class="engagement-max">/100</span>
                </div>
                <p class="engagement-subtext"> Score based on hook, CTA, readability, and hashtag strategy. </p>
            </div>
            
            <pre id="analysisDetails"></pre>
        </div>

        <div id="analysisPaywall" class="hidden">
            <div id="paywall" style="margin-top: 0;">
                <h3>Upgrade to Pro!</h3>
                <p>Unlock **Caption Analysis** to instantly reverse-engineer any viral post and replicate its success factors.</p>
                <button id="subscribeBtnAnalyze">Subscribe Now</button>
            </div>
        </div>
    </div>

    <div id="affiliateContent" class="tab-content hidden" data-tab="3">
        <div id="affiliateInfo">
            <h2>Your Referral Link</h2>
            <p class="subtitle">Share this link to earn 30% commission on current and future subscription fees automatically via Stripe Connect.</p>

            <div id="referralLinkBox" style="
                background: #f0fdf4; border: 1px solid #bbf7d0; padding: 1rem; border-radius: .5rem;
                margin-bottom: 1rem; word-break: break-all; font-size: 1rem; color: #059669;
            ">
                Log in with your email to generate your link.
            </div>
            <button id="copyLinkBtn" type="button" style="margin-bottom: 2rem;" disabled>Copy Link</button>
            
            <div id="affiliateConnectBox">
                <h3>Connect Stripe for Payouts</h3>
                <p>We use Stripe Connect to automatically pay your 30% commission. You must connect your account to receive funds.</p>
                <input type="text" id="stripeAccountIdInput" placeholder="Enter Your Stripe Connect Account ID (acct_...)" required>
                <button id="saveStripeIdBtn">Save Stripe Account ID</button>
                <p style="margin-top: 1rem; font-size: 0.85rem; color: var(--gray);">
                    Need a Stripe Account ID? Go to your <a href="https://dashboard.stripe.com/settings/connect" target="_blank">Stripe Connect Settings</a> and grab the `acct_...` ID.
                </p>
            </div>

            <div id="affiliateConnected" class="hidden" style="
                background: #eef2ff; border: 1px solid #c7d2fe; padding: 1rem; border-radius: .5rem; text-align: center;
            ">
                <h3>üéâ You're Connected!</h3>
                <p>Your commissions will be paid automatically to your Stripe account.</p>
            </div>
        </div>
    </div>
  </div>

  <footer>
    <a href="./privacy.html">Privacy</a> |
    <a href="./terms.html">Terms</a>
  </footer>

  <div id="toast" class="toast hidden"></div>

  <script>
    // --- Configuration ---
    let userEmail = localStorage.getItem('userEmail');
    let isPro = localStorage.getItem('isPro') === 'true';
    let isVip = localStorage.getItem('isVip') === 'true';
    let currentGenerations = parseInt(localStorage.getItem('freeUses') || '0');
    const FREE_LIMIT = 10;
    const API_URL = window.location.origin;
    let affiliateStripeId = localStorage.getItem('affiliateStripeId'); // Cache the ID

    // --- Helper Functions ---
    
    function showToast(message, type = 'info') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast toast-${type} show`;
      toast.style.display = 'block';

      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.style.display = 'none', 300);
      }, 3000);
    }
    
    function isValidEmail(email) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    function refreshProUI() {
      const proBadge = document.getElementById('proBadge');
      const paywallEl = document.getElementById('paywall');
      const analysisPaywall = document.getElementById('analysisPaywall');
      const analyzeForm = document.getElementById('analyzeForm');
      const templateContainer = document.getElementById('templateContainer');
      const templateTeaser = document.getElementById('templateTeaser');
      const subscribeBtn = document.getElementById('subscribeBtn');

      if (isPro || isVip) {
        if (proBadge) proBadge.style.display = 'flex';
        if (paywallEl) paywallEl.classList.add('hidden');
        if (subscribeBtn) subscribeBtn.disabled = true; // User is already pro
      } else {
        if (proBadge) proBadge.style.display = 'none';
        // Free usage bar
        updateFreeUsageBar();
      }

      // Templates visibility
      if (templateContainer && templateTeaser) {
        if (isPro || isVip) {
          templateContainer.style.display = 'grid';
          templateTeaser.style.display = 'none';
        } else {
          templateContainer.style.display = 'none';
          templateTeaser.style.display = 'block';
        }
      }

      // Analyze paywall
      if (analysisPaywall && analyzeForm) {
        if (isPro || isVip) {
            analysisPaywall.classList.add('hidden');
            analyzeForm.classList.remove('hidden');
        } else {
            analysisPaywall.classList.remove('hidden');
            analyzeForm.classList.add('hidden');
        }
      }
    }

    function updateFreeUsageBar() {
      const freeUsageBar = document.getElementById('freeUsageBar');
      if (freeUsageBar) {
        if (isPro || isVip) {
          freeUsageBar.innerHTML = `üåü <strong>PRO Unlocked:</strong> Unlimited generations.`;
          if (document.getElementById('paywall')) document.getElementById('paywall').classList.add('hidden');
        } else if (currentGenerations >= FREE_LIMIT) {
          freeUsageBar.innerHTML = `‚ö†Ô∏è <strong>Free Limit Reached:</strong> ${currentGenerations} / ${FREE_LIMIT} generations used.`;
          if (document.getElementById('paywall')) document.getElementById('paywall').classList.remove('hidden');
        } else {
          freeUsageBar.innerHTML = `Free Trial: <strong>${FREE_LIMIT - currentGenerations}</strong> generations remaining.`;
          if (document.getElementById('paywall')) document.getElementById('paywall').classList.add('hidden');
        }
      }
    }

    function updateGenerateButtonState() {
      const generateBtn = document.getElementById('generateBtn');
      if (!generateBtn) return;
      
      const isReadyToGenerate = isPro || isVip || (currentGenerations < FREE_LIMIT);

      if (isReadyToGenerate) {
        generateBtn.disabled = false;
        generateBtn.textContent = 'Generate Caption';
      } else {
        generateBtn.disabled = true;
        generateBtn.textContent = 'Upgrade Required';
      }
    }

    async function hydrateProFromServer() {
      if (!userEmail) return;

      try {
        const resp = await fetch(`${API_URL}/check-subscription?email=${encodeURIComponent(userEmail)}`);
        const data = await resp.json();

        isPro = !!data.isPro;
        isVip = !!data.vip;
        localStorage.setItem('isPro', isPro ? 'true' : 'false');
        localStorage.setItem('isVip', isVip ? 'true' : 'false');
        
      } catch (e) {
        console.error('hydrateProFromServer error', e);
        isPro = false;
        isVip = false;
        localStorage.setItem('isPro', 'false');
        localStorage.setItem('isVip', 'false');
      }
      
      refreshProUI();
      updateGenerateButtonState();
    }

    function showTab(tabNumber) {
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.add('hidden');
      });
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });

      const activeContent = document.querySelector(`.tab-content[data-tab="${tabNumber}"]`);
      const activeBtn = document.querySelector(`.tab-btn[data-tab="${tabNumber}"]`);
      
      if (activeContent) activeContent.classList.remove('hidden');
      if (activeBtn) activeBtn.classList.add('active');
      
      localStorage.setItem('currentTab', tabNumber);

      // Special action for affiliate tab
      if (tabNumber == 3 && userEmail) {
          checkAffiliateStatus();
      }
    }
    
    // --- AFFILIATE FUNCTIONS ---

    /**
     * Checks if the current user is an affiliate and updates the UI
     */
    async function checkAffiliateStatus() {
        const userEmail = localStorage.getItem('userEmail');
        const affiliateConnectBox = document.getElementById('affiliateConnectBox');
        const affiliateConnected = document.getElementById('affiliateConnected');
        const referralLinkBox = document.getElementById('referralLinkBox');
        const copyLinkBtn = document.getElementById('copyLinkBtn');
        
        if (!userEmail) {
            if (referralLinkBox) referralLinkBox.innerHTML = 'Log in with your email to generate your link.';
            if (copyLinkBtn) copyLinkBtn.disabled = true;
            return;
        }
        
        // Set the referral link immediately
        const referralLink = `${window.location.origin}?ref=${encodeURIComponent(userEmail)}`;
        if (referralLinkBox) referralLinkBox.innerHTML = referralLink;
        if (copyLinkBtn) copyLinkBtn.disabled = false;

        // Check backend for stored Stripe Account ID
        try {
            const resp = await fetch(`${API_URL}/check-affiliate?email=${encodeURIComponent(userEmail)}`);
            const data = await resp.json();

            if (data.isAffiliate) {
                localStorage.setItem('affiliateStripeId', data.stripeAccountId);
                affiliateStripeId = data.stripeAccountId;
                if (affiliateConnectBox) affiliateConnectBox.classList.add('hidden');
                if (affiliateConnected) affiliateConnected.classList.remove('hidden');
            } else {
                if (affiliateConnectBox) affiliateConnectBox.classList.remove('hidden');
                if (affiliateConnected) affiliateConnected.classList.add('hidden');
            }
        } catch (e) {
            console.error('Affiliate check error:', e);
        }
    }

    /**
     * Saves the user's Stripe Connect Account ID
     */
    async function saveStripeAccountId() {
        const userEmail = localStorage.getItem('userEmail');
        const stripeAccountIdInput = document.getElementById('stripeAccountIdInput');
        const stripeAccountId = stripeAccountIdInput.value.trim();

        if (!stripeAccountId.startsWith('acct_')) {
            showToast('Please enter a valid Stripe Account ID (must start with acct_).', 'error');
            return;
        }
        
        const saveBtn = document.getElementById('saveStripeIdBtn');
        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving...';
        
        try {
            const resp = await fetch(`${API_URL}/affiliate-onboard`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: userEmail, stripeAccountId }),
            });
            
            const data = await resp.json();
            
            if (data.success) {
                showToast('Stripe Account ID saved! You are now an affiliate.', 'success');
                checkAffiliateStatus(); // Refresh UI
            } else {
                showToast(data.error || 'Failed to save Stripe Account ID.', 'error');
            }
        } catch (e) {
            console.error('Save Stripe ID error:', e);
            showToast('A network error occurred while saving.', 'error');
        } finally {
            saveBtn.disabled = false;
            saveBtn.textContent = 'Save Stripe Account ID';
        }
    }
    
    /**
     * Helper to run all post-login initialization
     */
    function onUserLoggedIn() {
        hydrateProFromServer();
        checkAffiliateStatus(); // New: Check affiliate status on login
        updateGenerateButtonState();
        showTab(currentTab);
    }


    // --- AI / Analysis Logic (Rest of your existing code) ---

    // ... (rest of the functions like generateDeterministicScore, detectPlatform, etc. go here if they were in the script block)

    // Placeholder for AI/Analysis helper functions
    const emojiMap = {
        'Coffee': '‚òï', 'Sparkles': '‚ú®', 'Heart': '‚ù§Ô∏è', 'Leaf': 'üçÉ', 'Hand Wave': 'üëã',
        'Fire': 'üî•', 'Target': 'üéØ', 'Light Bulb': 'üí°', 'Toolbox': 'üß∞', 'Bookmark': 'üîñ',
        'Check': '‚úÖ', 'Exclamation': '‚ùó', 'Arrow Down': 'üëá', 'Thinking Face': 'ü§î',
        'Tears of Joy': 'üòÇ', 'Double Check Mark': '‚úÖ‚úÖ', 'Money Bag': 'üí∞', 'Stop Sign': 'üõë',
        'Trophy': 'üèÜ', 'Warning': '‚ö†Ô∏è', 'Thick Check': '‚úîÔ∏è', 'Hourglass': '‚è≥', 'Party Popper': 'üéâ'
    };
    
    const emojiList = [
      'üî•', 'üéØ', 'üí°', 'üß∞', 'üîñ', '‚úÖ', '‚ùó', 'üëá', 'ü§î', 'üòÇ', 'üèÜ', '‚ö†Ô∏è', '‚úîÔ∏è', '‚è≥', 'üéâ', 
      '‚òï', '‚ú®', '‚ù§Ô∏è', 'üçÉ', 'üëã', 'üõë', 'üí∞', 'ü§Ø', 'üò´', 'üí¨', 'üöÄ', 'üìà', 'üîë', 'ü§´', 'üëÄ'
    ];
    
    function generateDeterministicScore(url) {
      // NOTE: This is a simulated function as AI is not available client-side
      const score = Math.floor(Math.random() * (95 - 60 + 1)) + 60; 
      let quality, readability, hashtags, cta;
      
      if (score > 85) {
        quality = 'High';
        readability = 'Excellent use of line breaks. ‚úÖ';
        hashtags = 'Highly relevant, 90% niche-specific. üéØ';
        cta = 'Clear call-to-action to save and comment. üí¨';
      } else if (score > 70) {
        quality = 'Medium';
        readability = 'Good structure, but a few dense blocks. ‚ö†Ô∏è';
        hashtags = 'Mix of niche and broad tags (50/50). üí°';
        cta = 'Implicit CTA, could be stronger. üëç';
      } else {
        quality = 'Low';
        readability = 'Long paragraphs hurt scanning. üò´';
        hashtags = 'Too many generic tags. üìâ';
        cta = 'No clear call-to-action. ‚ùå';
      }

      return {
        score: score,
        details: `## Breakdown\n- **Hook Quality:** ${quality} urgency, clear value proposition. üî•\n- **Readability:** ${readability}\n- **Hashtag Strategy:** ${hashtags}\n- **CTA Strength:** ${cta}`
      };
    }
    
    function detectPlatform(url) {
      if (url.includes('tiktok.com') || url.includes('instagram.com/reels')) return 'TikTok/Reels';
      if (url.includes('instagram.com')) return 'Instagram';
      if (url.includes('twitter.com') || url.includes('x.com')) return 'X (Twitter)';
      if (url.includes('linkedin.com')) return 'LinkedIn';
      if (url.includes('youtube.com')) return 'YouTube';
      return 'Generic Web Page';
    }

    // --- DOMContentLoaded ---
    document.addEventListener('DOMContentLoaded', () => {
      const modal = document.getElementById('emailModal');
      const mainApp = document.getElementById('mainApp');
      const emailInput = document.getElementById('emailInput');
      const emailSubmit = document.getElementById('emailSubmit');
      const captionForm = document.getElementById('captionForm');
      const ideaInput = document.getElementById('idea');
      const platformSelect = document.getElementById('platform');
      const toneSelect = document.getElementById('tone');
      const loadingEl = document.getElementById('loading');
      const outputContainer = document.getElementById('outputContainer');
      const outputEl = document.getElementById('output');
      const copyBtn = document.getElementById('copyBtn');
      const subscribeBtn = document.getElementById('subscribeBtn');
      const subscribeBtnTeaser = document.getElementById('subscribeBtnTeaser');
      const subscribeBtnAnalyze = document.getElementById('subscribeBtnAnalyze');
      const currentTab = localStorage.getItem('currentTab') || 1;
      const boostBtn = document.getElementById('boostBtn');
      const dailyTipEl = document.getElementById('dailyTip');
      const templateContainer = document.getElementById('templateContainer');
      const analyzeForm = document.getElementById('analyzeForm');
      const competitorUrlInput = document.getElementById('competitorUrlInput');
      const analysisResult = document.getElementById('analysisResult');
      const analysisLoading = document.getElementById('analysisLoading');
      
      
      // --- Referral Code Parsing ---
      const urlParams = new URLSearchParams(window.location.search);
      const refCode = urlParams.get('ref');

      if (refCode && userEmail !== decodeURIComponent(refCode)) {
          // Only store the code if it's not the user's own email
          localStorage.setItem('referralCode', decodeURIComponent(refCode));
          showToast(`Referred by ${decodeURIComponent(refCode)}.`, 'info');
      } else if (urlParams.get('success') || urlParams.get('canceled')) {
          // Clear referral code after checkout attempt
          localStorage.removeItem('referralCode'); 
      }
      
      // --- Initialization ---

      // Daily Tips
      const tips = [
        "A great hook is 5 words or less and signals value to the algorithm.",
        "Vertical video is king. Use captions to drive watch time and saves.",
        "Keep paragraphs to 1‚Äì2 lines for maximum readability.",
        "Make your idea benefit-focused: ‚ÄòSave 2 hours a week‚Äô beats ‚ÄòMy new software‚Äô.",
        "On LinkedIn, lean Professional tone + minimal emojis + clear business outcomes.",
        "Great captions = strong hook ‚Üí story/value ‚Üí clear CTA.",
        "Numbered lists (‚Äò3 ways to‚Ä¶‚Äô) are highly scannable and shareable.",
        "Emoji at the start of the first line can help stop the scroll.",
        "Always include a Call-To-Action (CTA) to maximize engagement."
      ];
      dailyTipEl.textContent = tips[Math.floor(Math.random() * tips.length)];


      // Show/Hide Email Modal
      if (!userEmail) {
        modal.style.display = 'flex';
        mainApp.style.display = 'none';
      } else {
        modal.style.display = 'none';
        mainApp.style.display = 'block';
        onUserLoggedIn(); // Use the new combined function
      }
      
      // Initial UI sync
      refreshProUI();
      updateGenerateButtonState();
      showTab(currentTab);


      // --- Event Listeners ---
      
      // Email Submit
      if (emailSubmit) {
        emailSubmit.addEventListener('click', () => {
          const email = emailInput.value.trim();
          if (isValidEmail(email)) {
            localStorage.setItem('userEmail', email);
            localStorage.setItem('freeUses', '0');
            modal.style.display = 'none';
            mainApp.style.display = 'block';
            userEmail = email;
            onUserLoggedIn(); // Use the new combined function
            updateGenerateButtonState();
            showTab(currentTab);
          } else {
            emailInput.style.borderColor = '#ef4444';
            emailInput.focus();
          }
        });
      }

      // Tab Buttons
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => showTab(btn.dataset.tab));
      });
      
      // Affiliate Tab Listeners
      const affiliateTabBtn = document.querySelector('.tab-btn[data-tab="3"]');
      if (affiliateTabBtn) {
          affiliateTabBtn.addEventListener('click', checkAffiliateStatus);
      }
      
      const saveStripeIdBtn = document.getElementById('saveStripeIdBtn');
      if (saveStripeIdBtn) {
          saveStripeIdBtn.addEventListener('click', saveStripeAccountId);
      }
      
      const copyLinkBtn = document.getElementById('copyLinkBtn');
      const referralLinkBox = document.getElementById('referralLinkBox');
      if (copyLinkBtn && referralLinkBox) {
          copyLinkBtn.addEventListener('click', () => {
              navigator.clipboard.writeText(referralLinkBox.textContent)
                  .then(() => showToast('Referral link copied!', 'success'))
                  .catch(() => showToast('Failed to copy link.', 'error'));
          });
      }

      // Generator Form Submit
      if (captionForm) {
        captionForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          if (!userEmail) return showToast('Error: Please log in with your email first.', 'error');
          if (loadingEl) loadingEl.classList.remove('hidden');
          if (outputContainer) outputContainer.classList.add('hidden');

          const idea = ideaInput.value.trim();
          const platform = platformSelect.value;
          const tone = toneSelect.value;
          const currentGenerations = localStorage.getItem('freeUses') || '0';

          try {
            const resp = await fetch(`${API_URL}/generate`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ idea, platform, tone, email: userEmail, currentGenerations }),
            });

            if (resp.status === 402) {
              if (loadingEl) loadingEl.classList.add('hidden');
              return; // Paywall is already visible/handled by refreshProUI
            }

            const data = await resp.json();

            if (data.error) {
              showToast(data.error, 'error');
            } else {
              outputEl.textContent = data.result;
              const { score, details } = generateDeterministicScore(data.result);
              document.getElementById('engagementScore').textContent = score;
              document.getElementById('engagementSubtext').textContent = score >= 80 ? 'Excellent score! Ready to post.' : 'Score could be higher. Use Boost.';
              
              if (outputContainer) outputContainer.classList.remove('hidden');
              currentGenerations = FREE_LIMIT - parseInt(data.generationsLeft || 0);
              localStorage.setItem('freeUses', currentGenerations.toString());
              updateFreeUsageBar();
              updateGenerateButtonState();
            }

          } catch (e) {
            console.error('Generation error:', e);
            showToast('A network error occurred. Please try again.', 'error');
          } finally {
            if (loadingEl) loadingEl.classList.add('hidden');
          }
        });
      }

      // Copy Button
      if (copyBtn) {
        copyBtn.addEventListener('click', () => {
          const textToCopy = outputEl.textContent;
          if (navigator.clipboard) {
            navigator.clipboard.writeText(textToCopy).then(() => {
              showToast('Caption copied to clipboard!', 'success');
            }).catch(() => {
              showToast('Failed to copy. Please select and copy manually.', 'error');
            });
          }
        });
      }

      // Subscribe buttons
      const subscribeBtns = [subscribeBtn, subscribeBtnTeaser, subscribeBtnAnalyze];
      subscribeBtns.forEach(btn => {
        if (btn) {
          btn.addEventListener('click', async () => {
            const userEmail = localStorage.getItem('userEmail');
            if (!userEmail) return showToast('Error: Please enter your email first.', 'error');

            const referralCode = localStorage.getItem('referralCode'); // GET REFERRAL CODE

            try {
              const resp = await fetch(`${API_URL}/create-checkout-session`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    email: userEmail,
                    referralCode: referralCode || '' // PASS REFERRAL CODE
                }),
              });

              const data = await resp.json();
              if (data.url) {
                window.location.href = data.url;
              } else {
                showToast(data.error || 'Failed to start checkout.', 'error');
              }
            } catch (e) {
              console.error('Checkout error:', e);
              showToast('A network error occurred during checkout.', 'error');
            }
          });
        }
      });

      // Template Buttons
      if (templateContainer) {
          templateContainer.querySelectorAll('.templateBtn').forEach(btn => {
              btn.addEventListener('click', () => {
                  ideaInput.value = btn.dataset.text;
                  showTab(1); // switch back to generator tab
              });
          });
      }
      
      // Boost Button (Simulated)
      if (boostBtn) {
          boostBtn.addEventListener('click', () => {
              if (boostBtn.classList.contains('used')) return;
              
              const currentScore = parseInt(document.getElementById('engagementScore').textContent);
              const newScore = Math.min(100, currentScore + Math.floor(Math.random() * (15 - 5 + 1)) + 5);
              
              document.getElementById('engagementScore').textContent = newScore;
              document.getElementById('engagementSubtext').textContent = newScore >= 80 ? 'Excellent score! Ready to post.' : 'Score improved! Ready to post.';
              
              boostBtn.classList.add('used');
              boostBtn.textContent = "Boost Applied";
              showToast("Caption Score Boosted!", 'success');
          });
      }
      
      // Emoji Picker
      const emojiPickerBtn = document.getElementById('emojiPickerBtn');
      const emojiPicker = document.getElementById('emojiPicker');
      const emojiGrid = emojiPicker ? emojiPicker.querySelector('.emoji-grid') : null;
      
      if (emojiGrid) {
        emojiList.forEach(emoji => {
          const item = document.createElement('span');
          item.className = 'emoji-item';
          item.textContent = emoji;
          item.addEventListener('click', () => {
            ideaInput.value += ' ' + emoji;
            ideaInput.focus();
            emojiPicker.style.display = 'none';
          });
          emojiGrid.appendChild(item);
        });
        
        emojiPickerBtn.addEventListener('click', () => {
          emojiPicker.style.display = emojiPicker.style.display === 'block' ? 'none' : 'block';
        });
        
        // Close picker if clicked outside
        document.addEventListener('click', (e) => {
            if (emojiPicker.style.display === 'block' && !emojiPickerBtn.contains(e.target) && !emojiPicker.contains(e.target)) {
                emojiPicker.style.display = 'none';
            }
        });
      }
      
      // Analyze Form Submit
      if (analyzeForm && competitorUrlInput) {
          analyzeForm.addEventListener('submit', (e) => {
              e.preventDefault();
              
              if (!isPro && !isVip) return; // Should be handled by paywall, but as a safeguard
              
              if (analysisLoading) analysisLoading.classList.remove('hidden');
              if (analysisResult) analysisResult.classList.add('hidden');
              
              const url = competitorUrlInput.value.trim();
              
              setTimeout(() => {
                  if (analysisLoading) analysisLoading.classList.add('hidden');
                  const analysisData = generateDeterministicScore(url);
                  
                  const scoreEl = document.getElementById('analysisScore');
                  const detailEl = document.getElementById('analysisDetails');
                  
                  if (scoreEl && detailEl) {
                      scoreEl.textContent = analysisData.score;
                      detailEl.textContent = analysisData.details;
                  }
                  
                  if (analysisResult) analysisResult.classList.remove('hidden');
                  
              }, 2000); // Simulate network/AI call
          });
      }

    });
    
  </script>
</body>
</html>