<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI Caption + Hashtag Generator</title>
  <style>
    :root {
      --primary: #3b82f6;
      --primary-dark: #2563eb;
      --gray: #6b7280;
      --light: #f3f4f6;
      --border: #e5e7eb;
      --placeholder: #9ca3af;
      --success: #10b981;
      --success-dark: #059669;
      --error: #ef4444;
      --warning: #f59e0b;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      color: #111;
      min-height: 100vh;
      padding: 2rem 1rem;
    }
    .container { max-width: 600px; margin: 0 auto; }
    h1 { font-size: 2.25rem; font-weight: 700; text-align: center; margin-bottom: .5rem; }
    p.subtitle { text-align: center; color: var(--gray); margin-bottom: 1.5rem; font-size: 1.1rem; }

    .proof {
      background: #ecfdf5;
      border: 1px solid #a7f3d0;
      padding: 1rem;
      border-radius: .75rem;
      text-align: center;
      margin-bottom: 1.5rem;
      font-size: .95rem;
      color: #065f46;
    }
    .proof strong { font-weight: 600; }

    /* DAILY TIP BOX */
    #dailyTipBox {
      background: #fff;
      border: 1px solid #d1d5db;
      padding: 1rem;
      border-radius: .75rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 5px rgba(0,0,0,0.02);
      font-size: .95rem;
      line-height: 1.4;
    }
    #dailyTipBox strong {
      color: var(--warning);
      margin-right: .5rem;
    }

    /* EMAIL MODAL */
    #emailModal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.7); display: flex; align-items: center;
      justify-content: center; z-index: 9999;
    }
    .modal-content {
      background: white; padding: 2rem; border-radius: 1rem;
      width: 90%; max-width: 400px; text-align: center;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }
    .modal-content h2 { margin-bottom: 1rem; font-size: 1.5rem; }
    .modal-content p { margin-bottom: 1.5rem; color: #555; }
    .modal-content input {
      width: 100%; padding: .75rem; border: 2px solid #e5e7eb;
      border-radius: .5rem; font-size: 1rem; margin-bottom: 1rem;
    }
    .modal-content button {
      background: var(--primary); color: white; border: none;
      padding: .75rem 1.5rem; border-radius: .5rem; font-weight: 600;
      cursor: pointer; width: 100%;
    }

    /* FORMS */
    label { display: block; margin-bottom: .5rem; font-weight: 600; color: #111; }
    input, select {
      width: 100%; padding: .75rem 1rem; border: 2px solid var(--border);
      border-radius: .5rem; font-size: 1rem; margin-bottom: 1rem;
      transition: border .2s;
    }
    input:focus, select:focus { outline: none; border-color: var(--primary); }
    input::placeholder { color: var(--placeholder); font-style: italic; }

    select option[disabled] { display: none; }
    select option[data-placeholder] { color: var(--placeholder); font-style: italic; }
    select:invalid { color: var(--placeholder); }
    select:valid { color: #111; }

    button {
      width: 100%; background: var(--primary); color: white; border: none;
      padding: 1rem; font-size: 1.1rem; font-weight: 600; border-radius: .5rem;
      cursor: pointer; transition: background .2s;
    }
    button:hover { background: var(--primary-dark); }
    button:disabled { background: #93c5fd; cursor: not-allowed; }

    /* TABS */
    #tabHeader {
      display: flex;
      margin-bottom: 1.5rem;
      border-bottom: 2px solid var(--border);
    }
    .tab-btn {
      flex: 1;
      padding: 0.75rem 0;
      background: none;
      border: none;
      font-weight: 600;
      cursor: pointer;
      color: var(--gray);
      font-size: 1.1rem;
      border-bottom: 3px solid transparent;
      transition: color 0.2s, border-bottom 0.2s;
      border-radius: 0;
    }
    .tab-btn.active {
      color: var(--primary);
      border-bottom: 3px solid var(--primary);
    }
    .tab-content { padding: 0; }

    /* RESULT CARD */
    .result {
      margin-top: 2rem; padding: 1.5rem; background: white; border-radius: .75rem;
      box-shadow: 0 4px 12px rgba(0,0,0,.05); position: relative;
    }
    .result h3 { margin-bottom: .75rem; color: var(--primary); }
    .result pre {
      white-space: pre-wrap; font-family: inherit; line-height: 1.6; margin-bottom: 1rem;
    }

    /* ENGAGEMENT SCORE BOX */
    .engagement-box {
      margin-bottom: 1rem;
      padding: 0.75rem 1rem;
      border-radius: 0.75rem;
      background: #eff6ff;
      border: 1px solid #bfdbfe;
    }
    .engagement-box-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
      color: #1d4ed8;
      font-size: 0.95rem;
    }
    .engagement-box-note {
      margin-top: 0.4rem;
      font-size: 0.8rem;
      color: #6b7280;
    }
    #boostBtn {
      width: auto;
      padding: 0.35rem 0.9rem;
      font-size: 0.85rem;
      border-radius: 999px;
      border: none;
      background: #1d4ed8;
      color: white;
      cursor: pointer;
    }
    #boostBtn:disabled {
      opacity: 0.6;
      cursor: default;
    }

    #copyBtn {
      position: absolute; top: 1rem; right: 1rem; background: var(--success);
      color: white; padding: .5rem 1rem; border: none; border-radius: .5rem;
      font-size: .9rem; cursor: pointer; transition: background .2s;
    }
    #copyBtn:hover { background: var(--success-dark); }
    #copyBtn.copied { background: #059669; }

    /* EMOJI PICKER */
    #emojiPickerBtn {
      background: var(--warning); margin: 1rem 0; width: auto;
      padding: .5rem 1rem; font-size: .9rem;
    }
    .emoji-picker-container {
      position: relative;
      text-align: left;
      display: flex;
      justify-content: center;
    }
    #emojiPicker {
      display: none;
      position: absolute;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: .75rem;
      padding: 1rem;
      max-width: 300px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.15);
      z-index: 100;
      text-align: center;
      max-height: 350px;
      flex-direction: column;
      right: 0;
      top: 100%;
      transform: translateY(5px);
    }
    #emojiGrid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: .5rem;
      font-size: 1.5rem;
      margin: .75rem 0;
      overflow-y: auto;
      padding-right: 5px;
    }
    #emojiGrid button {
      background: none; border: none; font-size: 1.5rem; cursor: pointer; padding: 0;
    }
    #closePicker {
      margin-top: .5rem; background: #6b7280; color: white; padding: .5rem 1rem;
      border-radius: .5rem; font-size: .8rem; width: auto;
    }

    /* PRO TEMPLATES */
    #proTemplates {
      margin-top: 2rem; padding: 1.5rem; background: #f0fdf4;
      border: 1px solid #bbf7d0; border-radius: .75rem;
    }
    .templateBtn {
      text-align: left;
      padding: .75rem;
      background: white;
      border: 1px solid #d1d5db;
      border-radius: .5rem;
      font-size: .9rem;
      margin-bottom: .5rem;
      cursor: pointer;
      color: #111 !important;
      line-height: 1.4;
      display: block;
    }
    .templateBtn:hover {
      background: #f9fafb;
      color: #111 !important;
    }
    #templateContainer {
      display: grid;
      gap: .5rem;
      font-size: .9rem;
      margin-top: 1rem;
    }
    #templatePage2 { display: none; }
    #templatePaging {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-top: 1rem;
    }
    #templatePaging button {
      width: auto;
      padding: .5rem 1.2rem;
      background: #9ca3af;
      font-weight: 500;
      font-size: .9rem;
    }
    #templatePaging button.active {
      background: var(--primary);
      font-weight: 700;
    }

    /* PAYWALLS */
    .paywall {
      margin-top: 2rem; padding: 2rem; background: #fefce8; border-radius: .75rem;
      text-align: center; border: 2px solid #fde68a;
    }
    .paywall h3 { margin-bottom: .5rem; font-size: 1.5rem; }
    .paywall p { color: #92400e; margin-bottom: 1rem; }
    .paywall button {
      background: #16a34a; padding: .75rem 1.5rem; font-size: 1rem;
      width: auto; display: inline-block;
    }
    .paywall button:hover { background: #15803d; }

    /* ANALYSIS CARD */
    .analysis-card {
      background: white;
      border: 1px solid var(--border);
      border-radius: .75rem;
      padding: 1.5rem;
      margin-top: 1.5rem;
      box-shadow: 0 4px 12px rgba(0,0,0,.05);
    }
    .analysis-score {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--primary);
      text-align: center;
      margin-bottom: .5rem;
    }
    .analysis-detail {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px dashed var(--border);
    }

    .hidden { display: none; }
    .loading {
      text-align: center;
      margin: 1rem 0;
      color: var(--gray);
      font-style: italic;
    }

    footer {
      margin-top: 3rem; text-align: center; color: #6b7280; font-size: 0.875rem;
    }
    footer a { color: inherit; margin: 0 1rem; text-decoration: underline; }

    @media (max-width: 480px) {
      h1 { font-size: 1.75rem; }
      .container { padding: 0 1rem; }
      #copyBtn { position: static; margin-top: 1rem; width: 100%; }
      #emojiGrid { grid-template-columns: repeat(5, 1fr); }
      #emojiPicker {
        right: auto;
        left: 50%;
        transform: translateX(-50%) translateY(5px);
      }
    }
  </style>
</head>
<body>

  <!-- EMAIL MODAL -->
  <div id="emailModal">
    <div class="modal-content">
      <h2>Welcome!</h2>
      <p>Enter your email to get <strong>10 free generations</strong>.</p>
      <input type="email" id="emailInput" placeholder="you@example.com" required />
      <button id="emailSubmit">Start Generating</button>
    </div>
  </div>

  <!-- MAIN APP -->
  <div class="container" id="mainApp" style="display:none;">
    <h1>AI Caption + Hashtag Generator</h1>
    <p class="subtitle">Get 5 viral captions + 30 hashtags in 3 seconds.</p>

    <div class="proof">
      <strong>Stop guessing and start optimizing. The only AI Caption Generator with a built-in Engagement Score.</strong>
    </div>

    <div id="dailyTipBox">
      <strong>ğŸ’¡ Today's Tip:</strong>
      <span id="dailyTipText">Loading...</span>
    </div>

    <div id="tabContainer">
      <div id="tabHeader">
        <button id="generateTabBtn" class="tab-btn active" data-target="generateContent">Generate Content</button>
        <button id="analyzeTabBtn" class="tab-btn" data-target="analyzeContent">Analyze Competitor (Pro)</button>
      </div>

      <!-- GENERATE TAB -->
      <div id="generateContent" class="tab-content">
        <form id="captionForm">
          <label for="idea">Post Idea</label>
          <input type="text" id="idea" placeholder="e.g. Just launched my coffee shop" required />

          <label for="platform">Platform</label>
          <select id="platform" required>
            <option value="" disabled selected data-placeholder>Choose platform</option>
            <option value="Instagram">Instagram</option>
            <option value="Twitter">Twitter</option>
            <option value="LinkedIn">LinkedIn</option>
            <option value="TikTok">TikTok</option>
          </select>

          <label for="tone">Tone</label>
          <select id="tone" required>
            <option value="" disabled selected data-placeholder>Choose tone</option>
            <option value="Professional">Professional</option>
            <option value="Fun & Playful">Fun & Playful</option>
            <option value="Inspirational">Inspirational</option>
            <option value="Bold & Confident">Bold & Confident</option>
            <option value="Casual & Friendly">Casual & Friendly</option>
          </select>

          <button type="submit" id="generateBtn">Generate Captions</button>
        </form>

        <!-- Emoji Picker -->
        <div class="emoji-picker-container">
          <button type="button" id="emojiPickerBtn">Add Emojis</button>
          <div id="emojiPicker">
            <p style="margin-bottom: .75rem; font-weight: 600;">Pick Emojis</p>
            <div id="emojiGrid"></div>
            <button id="closePicker">Close</button>
          </div>
        </div>

        <div id="loading" class="loading hidden">Generating magic...</div>

        <div id="result" class="result hidden">
          <h3>Your AI Captions</h3>

          <!-- â­ Engagement Score + Boost â­ -->
          <div id="engagementScoreBox" class="engagement-box hidden">
            <div class="engagement-box-header">
              <span>Engagement Score: <span id="engagementScoreValue">--</span>/100</span>
              <button type="button" id="boostBtn">Boost My Score</button>
            </div>
            <p class="engagement-box-note">
              One-click rewrite to push this postâ€™s score higher. Boost available once per generation.
            </p>
          </div>

          <pre id="output"></pre>
          <button type="button" id="copyBtn">Copy All</button>
        </div>

        <!-- PRO Templates -->
        <div id="proTemplates">
          <h3>The Viral Swipe File: Proven 6-Figure Post Structures</h3>
          <p style="margin: 1rem 0 .75rem; font-size: .95rem; color: #065f46; line-height: 1.5;">
            <strong>Steal the exact captions used by 6-figure creators.</strong>
            These arenâ€™t random â€” theyâ€™re <em>proven</em> to get 3x more likes, comments, and saves.
            Just click, edit, generate. <strong>Instant viral edge.</strong>
          </p>

          <div id="templateContainer" class="hidden">
            <div id="templatePage1">
              <button class="templateBtn" data-text="Just hit [X] followers! Grateful for every one of you Heart Sparkles">
                Just hit [X] followers! Grateful for every one of you â¤ï¸ âœ¨
              </button>
              <button class="templateBtn" data-text="Behind the scenes of [your idea] Camera Film">
                Behind the scenes of [your idea] ğŸ“¸ ğŸ¬
              </button>
              <button class="templateBtn" data-text="Tag a friend who needs this! Hand Point Down">
                Tag a friend who needs this! ğŸ‘‡
              </button>
              <button class="templateBtn" data-text="New drop alert! Link in bio Shopping Bag Fire">
                New drop alert! Link in bio ğŸ›ï¸ ğŸ”¥
              </button>
              <button class="templateBtn" data-text="Your daily dose of [topic] Coffee Mug Light Bulb">
                Your daily dose of [topic] â˜• ğŸ’¡
              </button>
              <button class="templateBtn" data-text="Reply with YES or NO: [question]? Question Mark Thinking Face">
                Reply with YES or NO: [question]? â“ ğŸ¤”
              </button>
              <button class="templateBtn" data-text="Save this for later â€” youâ€™ll thank me! Bookmark Sparkles">
                Save this for later â€” youâ€™ll thank me! ğŸ”– âœ¨
              </button>
              <button class="templateBtn" data-text="Free [resource] in bio! Donâ€™t miss it Gift Rocket">
                Free [resource] in bio! Donâ€™t miss it ğŸ ğŸš€
              </button>
              <button class="templateBtn" data-text="Swipe up to see the full story! Hand Point Up Film">
                Swipe up to see the full story! ğŸ‘† ğŸ¬
              </button>
              <button class="templateBtn" data-text="'Changed my [niche] game!' â€“ @username Star Speech Bubble">
                "Changed my [niche] game!" â€“ @username â­ ğŸ’¬
              </button>
            </div>

            <div id="templatePage2">
              <button class="templateBtn" data-text="You think [Product] is too expensive? Here's the ROI breakdown. Money Bag Chart Increasing">
                You think [Product] is too expensive? Here's the ROI breakdown. ğŸ’¸ ğŸ“ˆ
              </button>
              <button class="templateBtn" data-text="Stop wasting time on [Frustrating Task]. Our 3-step solution: [Solution]. Crying Face Check Mark">
                Stop wasting time on [Frustrating Task]. Our 3-step solution: [Solution]. ğŸ˜« âœ…
              </button>
              <button class="templateBtn" data-text="6 months ago I was [Stuck]... now I'm [Success]. The difference: [1 Thing]. Thinking Face Light Bulb">
                6 months ago I was [Stuck]... now I'm [Success]. The difference: [1 Thing]. ğŸ¤¯ ğŸ’¡
              </button>
              <button class="templateBtn" data-text="How I made [High Result] in [Short Time]: Step 1: [Action]. Save for steps 2 & 3. Toolbox Target">
                How I made [High Result] in [Short Time]: Step 1: [Action]. Save for steps 2 & 3. ğŸ› ï¸ ğŸ¯
              </button>
              <button class="templateBtn" data-text="Unpopular opinion: [Common Belief] is completely wrong. Here's why. Speech Bubble Cross Mark">
                Unpopular opinion: [Common Belief] is completely wrong. Here's why. ğŸ—£ï¸ âŒ
              </button>
              <button class="templateBtn" data-text="Get the exact checklist I use to [Goal]! Click the link that says Link Bookmark">
                Get the exact checklist I use to [Goal]! Click the link that says "Free Guide." ğŸ”— ğŸ”–
              </button>
              <button class="templateBtn" data-text="Myth: You need [X] to succeed. Reality: You only need [Y]. Which shocked you? Smiling Face 100 Score">
                Myth: You need [X] to succeed. Reality: You only need [Y]. Which shocked you? ğŸ˜® ğŸ’¯
              </button>
              <button class="templateBtn" data-text="Client Spotlight: [Client Name] went from [A] to [B] in 30 days. Their secret was [Tool]. User Rocket">
                Client Spotlight: [Client Name] went from [A] to [B] in 30 days. Their secret was [Tool]. ğŸ‘¤ ğŸš€
              </button>
              <button class="templateBtn" data-text="My most impactful habit for [Goal]? Doing [Task] at [Time]. Steal it. Alarm Clock Flexed Biceps">
                My most impactful habit for [Goal]? Doing [Task] at [Time]. Steal it. â° ğŸ’ª
              </button>
              <button class="templateBtn" data-text="[Option A] vs. [Option B]: Which is better for [Specific Use Case]? Swipe to see the pros/cons. Balance Scale Magnifying Glass">
                [Option A] vs. [Option B]: Which is better for [Specific Use Case]? Swipe to see the pros/cons. âš–ï¸ ğŸ§
              </button>
            </div>

            <div id="templatePaging">
              <button id="page1Btn" class="active">Page 1</button>
              <button id="page2Btn">Page 2</button>
            </div>
          </div>

          <div id="templateTeaser">
            <p style="font-size: .9rem; color: #92400e; font-style: italic; margin-top: 1rem;">
              <strong>Unlock 20 Viral Swipe File Structures</strong> â€” only available in <strong>Pro</strong>.
            </p>
            <button id="unlockTemplatesBtn" style="
              background: #f59e0b; color: white; border: none; padding: .6rem 1.2rem;
              border-radius: .5rem; font-size: .9rem; font-weight: 600; cursor: pointer;
              margin-top: .5rem;
            ">Upgrade to Pro</button>
          </div>
        </div>

        <!-- GENERATE PAYWALL -->
        <div id="paywall" class="paywall hidden">
          <h3>Upgrade to Pro!</h3>
          <p>You've used your 10 free generations. <strong>Unlimited + 20 Viral Swipe File Structures</strong> for <strong>$7/month</strong>.</p>
          <button id="subscribeBtn">Subscribe Now</button>
        </div>
      </div>

      <!-- ANALYZE TAB -->
      <div id="analyzeContent" class="tab-content hidden">
        <div id="analysisDescription" style="
          background: #f0f9ff;
          border: 1px solid #bae6fd;
          padding: 1.2rem;
          border-radius: .75rem;
          margin-bottom: 1.5rem;
          font-size: .95rem;
          line-height: 1.5;
          color: #0369a1;
        ">
          <h4 style="margin-bottom: .5rem; color: #075985; font-size: 1.1rem;">
            Reverse-Engineer Viral Success ğŸ”¬
          </h4>
          Paste <em>any</em> competitor's post URL (Instagram, Twitter, etc.) and our AI will deconstruct their strategy.
          Get an instant <strong>Content Score</strong> and a breakdown of their hook, CTA, and hashtag usage.
        </div>

        <div id="analysisPaywall" class="paywall hidden" style="margin-top: 1rem;">
          <h3>Unlock Analysis!</h3>
          <p>Content Scoring is an exclusive <strong>Pro</strong> feature. Unlimited access for <strong>$7/month</strong>.</p>
          <button id="subscribeAnalyzeBtn">Upgrade to Pro</button>
        </div>

        <form id="analyzeForm" class="hidden">
          <label for="competitorUrl">Competitor Post URL</label>
          <input type="url" id="competitorUrl" placeholder="e.g. https://instagram.com/p/B..." required />
          <button type="submit" id="analyzeBtn">Analyze Post Structure</button>
        </form>

        <div id="analysisResult" class="analysis-card hidden">
          <p style="text-align: center; font-size: 1.2rem; font-weight: 600; margin-bottom: 0;">Content Score</p>
          <div id="analysisScore" class="analysis-score">--</div>
          <div id="analysisDetails" class="analysis-detail"></div>
          <button id="analyzeAgainBtn">Analyze Another Post</button>
        </div>
      </div>
    </div>

    <footer>
      <a href="/terms.html">Terms</a>
      <a href="/privacy.html">Privacy</a>
      <span>Â© 2025 Caption AI</span>
    </footer>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const API_URL = 'https://caption-ai-ze13.onrender.com';
      const MAX_FREE_USES = 10;

      // --- STATE ---
      let userEmail = localStorage.getItem('userEmail');
      let isPro = localStorage.getItem('isPro') === 'true';
      let freeUses = parseInt(localStorage.getItem('freeUses') || '0', 10);
      let currentTab = localStorage.getItem('lastTab') || 'generateContent';
      let debounceTimer;
      let isGenerating = false;
      let lastScore = null;
      let hasBoosted = false;

      // --- DOM ELEMENTS ---
      const modal = document.getElementById('emailModal');
      const mainApp = document.getElementById('mainApp');
      const emailInput = document.getElementById('emailInput');
      const emailSubmit = document.getElementById('emailSubmit');

      const generateTabBtn = document.getElementById('generateTabBtn');
      const analyzeTabBtn = document.getElementById('analyzeTabBtn');
      const generateContent = document.getElementById('generateContent');
      const analyzeContent = document.getElementById('analyzeContent');

      const ideaInput = document.getElementById('idea');
      const platformSelect = document.getElementById('platform');
      const toneEl = document.getElementById('tone');
      const generateBtn = document.getElementById('generateBtn');
      const captionForm = document.getElementById('captionForm');

      const loadingEl = document.getElementById('loading');
      const resultBox = document.getElementById('result');
      const outputEl = document.getElementById('output');
      const copyBtn = document.getElementById('copyBtn');

      const engagementBox = document.getElementById('engagementScoreBox');
      const engagementScoreValue = document.getElementById('engagementScoreValue');
      const boostBtn = document.getElementById('boostBtn');

      const proTemplates = document.getElementById('proTemplates');
      const templateContainer = document.getElementById('templateContainer');
      const templateTeaser = document.getElementById('templateTeaser');
      const page1 = document.getElementById('templatePage1');
      const page2 = document.getElementById('templatePage2');
      const page1Btn = document.getElementById('page1Btn');
      const page2Btn = document.getElementById('page2Btn');
      const unlockTemplatesBtn = document.getElementById('unlockTemplatesBtn');

      const paywall = document.getElementById('paywall');
      const subscribeBtn = document.getElementById('subscribeBtn');

      const analysisPaywall = document.getElementById('analysisPaywall');
      const subscribeAnalyzeBtn = document.getElementById('subscribeAnalyzeBtn');
      const analyzeForm = document.getElementById('analyzeForm');
      const competitorUrlInput = document.getElementById('competitorUrl');
      const analysisResult = document.getElementById('analysisResult');
      const analysisScore = document.getElementById('analysisScore');
      const analysisDetails = document.getElementById('analysisDetails');
      const analyzeAgainBtn = document.getElementById('analyzeAgainBtn');

      const emojiPickerBtn = document.getElementById('emojiPickerBtn');
      const emojiPicker = document.getElementById('emojiPicker');
      const emojiGrid = document.getElementById('emojiGrid');
      const closePicker = document.getElementById('closePicker');

      const dailyTipText = document.getElementById('dailyTipText');

      // --- EMOJI MAP ---
      const emojiMap = {
        'Camera': 'ğŸ“¸', 'Heart': 'â¤ï¸', 'Sparkles': 'âœ¨', 'Coffee': 'â˜•', 'Shopping Bag': 'ğŸ›ï¸',
        'Rocket': 'ğŸš€', 'Fire': 'ğŸ”¥', 'Trophy': 'ğŸ†', 'Briefcase': 'ğŸ’¼', 'Handshake': 'ğŸ¤',
        'Laptop': 'ğŸ’»', 'Sunrise': 'ğŸŒ…', 'Moon': 'ğŸŒ™', 'Pizza': 'ğŸ•', 'Leaf': 'ğŸƒ',
        'Flexed Biceps': 'ğŸ’ª', 'Airplane': 'âœˆï¸', 'Book': 'ğŸ“š', 'Dog': 'ğŸ¶', 'Cat': 'ğŸ±',
        'Birthday Cake': 'ğŸ‚', 'Party Popper': 'ğŸ‰', 'Star': 'â­', 'Film': 'ğŸ¬',
        'Musical Notes': 'ğŸ¶', 'Dancer': 'ğŸ’ƒ', 'Play Button': 'â–¶ï¸', 'New': 'ğŸ†•', 'Sale': 'ğŸ·ï¸',
        'Check Mark': 'âœ…', 'Cross Mark': 'âŒ', 'Hand Point Down': 'ğŸ‘‡', 'Coffee Mug': 'â˜•', 'Hand Wave': 'ğŸ‘‹',
        'Light Bulb': 'ğŸ’¡', 'Thinking Face': 'ğŸ¤”', '100 Score': 'ğŸ’¯', 'Money Bag': 'ğŸ’¸',
        'Chart Increasing': 'ğŸ“ˆ', 'Target': 'ğŸ¯', 'Alarm Clock': 'â°', 'Question Mark': 'â“',
        'Speech Bubble': 'ğŸ’¬', 'Crown': 'ğŸ‘‘', 'Diamond': 'ğŸ’', 'Robot': 'ğŸ¤–',
        'Globe': 'ğŸŒ', 'Mountain': 'â›°ï¸', 'Pin': 'ğŸ“Œ', 'Megaphone': 'ğŸ“£',
        'Writing Hand': 'âœï¸', 'Open Book': 'ğŸ“–', 'Smiling Face': 'ğŸ˜Š', 'Crying Face': 'ğŸ˜«',
        'Clapping Hands': 'ğŸ‘', 'Winking Face': 'ğŸ˜‰', 'Red Apple': 'ğŸ', 'Grapes': 'ğŸ‡',
        'Donut': 'ğŸ©', 'Taco': 'ğŸŒ®', 'Beer Mug': 'ğŸº', 'Martini Glass': 'ğŸ¸',
        'Car': 'ğŸš—', 'Bicycle': 'ğŸš²', 'Train': 'ğŸš†', 'Boat': 'â›µ',
        'Fingers Crossed': 'ğŸ¤', 'Poo': 'ğŸ’©', 'Ghost': 'ğŸ‘»', 'Alien': 'ğŸ‘½',
        'Lock': 'ğŸ”’', 'Key': 'ğŸ”‘', 'Toolbox': 'ğŸ› ï¸', 'Graduation Cap': 'ğŸ“',
        'Bookmark': 'ğŸ”–', 'Gift': 'ğŸ', 'Hand Point Up': 'ğŸ‘†',
        'Link': 'ğŸ”—', 'Balance Scale': 'âš–ï¸', 'Magnifying Glass': 'ğŸ§', 'User': 'ğŸ‘¤'
      };

      // --- DAILY TIPS ---
      const dailyTips = [
        "Hook the reader in the first sentence. Your AI captions are useless if no one stops scrolling!",
        "Always include a clear Call-to-Action at the end: ask a question, tell them to save the post, or tag a friend.",
        "Use 2â€“3 broad hashtags and 10+ niche hashtags for maximum reach.",
        "Test different tones for the same idea. A 'Bold' caption might outperform 'Casual' by 50%.",
        "Reply to every comment in the first hour to signal value to the algorithm.",
        "Use line breaks. 1â€“2 sentence paragraphs keep people reading.",
        "Your 'Post Idea' should be benefit-focused, not feature-focused.",
        "For LinkedIn, keep emojis minimal and focus on lessons and value.",
        "A strong caption has a hook, value/story, and a CTA.",
        "Don't use the first AI caption blindly. Mix hooks, middles, and CTAs from several runs."
      ];
      function getTodayTip() {
        const today = new Date();
        const start = new Date(today.getFullYear(), 0, 0);
        const diff = today - start;
        const oneDay = 1000 * 60 * 60 * 24;
        const dayOfYear = Math.floor(diff / oneDay);
        const idx = dayOfYear % dailyTips.length;
        return dailyTips[idx];
      }

      // --- UTILS ---
      function textHash(str) {
        let h = 0;
        for (let i = 0; i < str.length; i++) {
          h = (h << 5) - h + str.charCodeAt(i);
          h |= 0;
        }
        return Math.abs(h);
      }

      // Balanced, content-driven Engagement Score
      function computeEngagementScore(text, idea, platform, tone) {
        if (!text) return 0;
        const raw = text.toString();
        const lower = raw.toLowerCase();
        let score = 45; // base for balanced feel

        // Parse captions section
        let captionsPart = raw;
        const capsIdx = raw.toLowerCase().indexOf('## captions');
        if (capsIdx !== -1) captionsPart = raw.slice(capsIdx);
        const hashIdx = captionsPart.toLowerCase().indexOf('## hashtags');
        if (hashIdx !== -1) captionsPart = captionsPart.slice(0, hashIdx);

        const captionLines = captionsPart.split('\n').filter(l => l.trim().match(/^\d+\./));
        const captions = captionLines.map(l => l.replace(/^\d+\.\s*/, '').trim());

        // Hashtags
        let hashtagsPart = raw;
        const hashHeaderIdx = raw.toLowerCase().indexOf('## hashtags');
        if (hashHeaderIdx !== -1) {
          hashtagsPart = raw.slice(hashHeaderIdx);
        }
        const hashtags = hashtagsPart.match(/#[a-z0-9_]+/gi) || [];

        // Emojis
        const emojiMatches = raw.match(/[\u{1F300}-\u{1FAFF}]/gu) || [];
        const emojiCount = emojiMatches.length;

        // 1) Hook quality (0â€“20) from first caption
        let hookScore = 0;
        const firstCap = (captions[0] || raw).slice(0, 200);
        const firstLower = firstCap.toLowerCase();
        if (/[0-9]/.test(firstCap)) hookScore += 5;
        if (/[?!]/.test(firstCap)) hookScore += 4;
        if (emojiCount > 0) hookScore += 4;
        const hookWords = ['secret', 'mistake', 'mistakes', 'hack', 'hacks', 'myth', 'myths', 'stop', 'never', 'steal', 'viral', 'explode', 'boost', 'skyrocket'];
        if (hookWords.some(w => firstLower.includes(w))) hookScore += 4;
        if (idea && idea.split(/\s+/)[0] && firstLower.includes(idea.split(/\s+/)[0].toLowerCase())) {
          hookScore += 3;
        }
        hookScore = Math.min(hookScore, 20);
        score += hookScore;

        // 2) Structure and readability (0â€“15)
        let struct = 0;
        if (captions.length === 5) struct += 5;
        if (captions.length >= 3 && captions.length <= 6) struct += 3;
        const totalLen = captions.reduce((acc, c) => acc + c.length, 0);
        if (totalLen > 300 && totalLen < 1400) struct += 5;
        const avgLen = captions.length ? totalLen / captions.length : 0;
        if (avgLen >= 80 && avgLen <= 260) struct += 5;
        struct = Math.min(struct, 15);
        score += struct;

        // 3) Hashtag quality (0â€“15)
        let hashScore = 0;
        const hashCount = hashtags.length;
        if (hashCount >= 15 && hashCount <= 40) hashScore += 7;
        const uniqueHashtags = Array.from(new Set(hashtags.map(h => h.toLowerCase())));
        if (uniqueHashtags.length >= 12) hashScore += 4;
        const niche = uniqueHashtags.filter(h => h.length > 9);
        if (niche.length >= 8) hashScore += 4;
        hashScore = Math.min(hashScore, 15);
        score += hashScore;

        // 4) CTA presence (0â€“10)
        const ctaPhrases = ['comment', 'tag a friend', 'save this', 'share this', 'dm me', 'link in bio', 'drop a', 'reply with', 'double tap', 'follow for more'];
        let ctaScore = 0;
        if (ctaPhrases.some(p => lower.includes(p))) ctaScore += 7;
        if (/(\?|!|:)\s*$/m.test(firstCap)) ctaScore += 3;
        ctaScore = Math.min(ctaScore, 10);
        score += ctaScore;

        // 5) Emoji usage (0â€“8)
        let emoScore = 0;
        if (emojiCount >= 3 && emojiCount <= 20) emoScore += 6;
        if (emojiCount > 0 && emojiCount <= 30) emoScore += 2;
        emoScore = Math.min(emoScore, 8);
        score += emoScore;

        // 6) Diversity penalty (up to -8)
        const words = lower.replace(/#[a-z0-9_]+/gi, '').split(/\s+/).filter(Boolean);
        if (words.length > 20) {
          const uniqueWords = new Set(words);
          const ratio = uniqueWords.size / words.length; // 0â€“1
          if (ratio < 0.4) score -= 8;
          else if (ratio < 0.55) score -= 4;
        }

        // 7) Light platform/tone adjustments (-5 to +5)
        const plat = platform || '';
        const toneStr = tone || '';
        if (plat === 'LinkedIn' && toneStr.includes('Professional')) {
          if (emojiCount <= 4) score += 4;
          else score -= 3;
        } else if (plat === 'TikTok' && toneStr.includes('Fun')) {
          if (emojiCount >= 5) score += 3;
        } else if (plat === 'Twitter') {
          if (raw.length <= 900) score += 2;
        }

        // 8) Small deterministic noise so similar posts don't always tie
        const h = textHash(raw + (platform || '') + (tone || ''));
        const noise = (h % 7) - 3; // -3..+3
        score += noise;

        // Clamp
        score = Math.max(10, Math.min(100, Math.round(score)));
        return score;
      }

      function detectPlatform(url) {
        url = url.toLowerCase();
        if (url.includes('instagram.com')) return 'Instagram';
        if (url.includes('twitter.com') || url.includes('x.com')) return 'Twitter';
        if (url.includes('linkedin.com')) return 'LinkedIn';
        if (url.includes('tiktok.com')) return 'TikTok';
        return 'Instagram';
      }

      function hashString(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
          const char = str.charCodeAt(i);
          hash = ((hash << 5) - hash) + char;
          hash |= 0;
        }
        return Math.abs(hash);
      }
      function generateDeterministicScore(url) {
        const uniqueSeed = hashString(url.toLowerCase().trim());
        const score = (uniqueSeed % 35) + 65;
        const quality = score > 90 ? 'High' : score > 80 ? 'Medium' : 'Low';
        let hook, readability, hashtags, cta;
        if (quality === 'High') {
          hook = 'High urgency, clear value proposition. ğŸ”¥';
          readability = 'Excellent use of line breaks and short paragraphs. âœ…';
          hashtags = 'Highly relevant, mostly niche-specific. ğŸ¯';
          cta = 'Clear CTA encouraging saves and comments. ğŸ’¬';
        } else if (quality === 'Medium') {
          hook = 'Decent hook, could be more specific or curiosity-driven. ğŸ‘';
          readability = 'Good structure, a few dense sections. âš ï¸';
          hashtags = 'Mix of niche and broad tags. ğŸ’¡';
          cta = 'CTA present but not very strong. â“';
        } else {
          hook = 'Vague hook, unclear value for the reader. ğŸ‘';
          readability = 'Text is dense, needs more line breaks. âŒ';
          hashtags = 'Too generic, many broad tags. ğŸ’¡';
          cta = 'Weak or missing CTA. â“';
        }
        return { score, hook, readability, hashtags, cta };
      }

      function updateGenerateButtonState() {
        if (!generateBtn) return;
        if (isPro) {
          generateBtn.disabled = false;
          if (paywall) paywall.classList.add('hidden');
          return;
        }
        if (freeUses >= MAX_FREE_USES) {
          generateBtn.disabled = true;
          if (paywall && currentTab === 'generateContent') {
            paywall.classList.remove('hidden');
          }
        } else {
          generateBtn.disabled = false;
          if (paywall) paywall.classList.add('hidden');
        }
      }

      function showTab(tabName) {
        currentTab = tabName;
        localStorage.setItem('lastTab', tabName);

        // Hide shared UI on tab switch
        if (loadingEl) loadingEl.classList.add('hidden');
        if (resultBox) resultBox.classList.add('hidden');
        if (engagementBox) engagementBox.classList.add('hidden');
        if (analysisResult) analysisResult.classList.add('hidden');

        if (tabName === 'generateContent') {
          generateContent.classList.remove('hidden');
          analyzeContent.classList.add('hidden');
          generateTabBtn.classList.add('active');
          analyzeTabBtn.classList.remove('active');
          if (analysisPaywall) analysisPaywall.classList.add('hidden');
          updateGenerateButtonState();
        } else {
          generateContent.classList.add('hidden');
          analyzeContent.classList.remove('hidden');
          generateTabBtn.classList.remove('active');
          analyzeTabBtn.classList.add('active');
          if (!isPro) {
            analysisPaywall.classList.remove('hidden');
            analyzeForm.classList.add('hidden');
          } else {
            analysisPaywall.classList.add('hidden');
            analyzeForm.classList.remove('hidden');
          }
          if (paywall) paywall.classList.add('hidden');
        }
      }

      function showPage(pageNumber) {
        if (!page1 || !page2 || !page1Btn || !page2Btn) return;
        if (pageNumber === 1) {
          page1.style.display = 'grid';
          page2.style.display = 'none';
          page1Btn.classList.add('active');
          page2Btn.classList.remove('active');
        } else {
          page1.style.display = 'none';
          page2.style.display = 'grid';
          page1Btn.classList.remove('active');
          page2Btn.classList.add('active');
        }
      }

      function processTemplateText(text) {
        const replacements = {
          'Camera Film': emojiMap['Camera'] + ' ' + emojiMap['Film'],
          'Coffee Mug Light Bulb': emojiMap['Coffee Mug'] + ' ' + emojiMap['Light Bulb'],
          'Question Mark Thinking Face': emojiMap['Question Mark'] + ' ' + emojiMap['Thinking Face'],
          'Bookmark Sparkles': emojiMap['Bookmark'] + ' ' + emojiMap['Sparkles'],
          'Gift Rocket': emojiMap['Gift'] + ' ' + emojiMap['Rocket'],
          'Hand Point Up Film': emojiMap['Hand Point Up'] + ' ' + emojiMap['Film'],
          'Star Speech Bubble': emojiMap['Star'] + ' ' + emojiMap['Speech Bubble'],
          'Money Bag Chart Increasing': emojiMap['Money Bag'] + ' ' + emojiMap['Chart Increasing'],
          'Crying Face Check Mark': emojiMap['Crying Face'] + ' ' + emojiMap['Check Mark'],
          'Thinking Face Light Bulb': emojiMap['Thinking Face'] + ' ' + emojiMap['Light Bulb'],
          'Toolbox Target': emojiMap['Toolbox'] + ' ' + emojiMap['Target'],
          'Speech Bubble Cross Mark': emojiMap['Speech Bubble'] + ' ' + emojiMap['Cross Mark'],
          'Link Bookmark': emojiMap['Link'] + ' ' + emojiMap['Bookmark'],
          'Smiling Face 100 Score': emojiMap['Smiling Face'] + ' ' + emojiMap['100 Score'],
          'User Rocket': emojiMap['User'] + ' ' + emojiMap['Rocket'],
          'Alarm Clock Flexed Biceps': emojiMap['Alarm Clock'] + ' ' + emojiMap['Flexed Biceps'],
          'Balance Scale Magnifying Glass': emojiMap['Balance Scale'] + ' ' + emojiMap['Magnifying Glass'],
          'Heart': emojiMap['Heart'],
          'Sparkles': emojiMap['Sparkles'],
          'Hand Point Down': emojiMap['Hand Point Down'],
          'Shopping Bag': emojiMap['Shopping Bag'],
          'Fire': emojiMap['Fire'],
          'Light Bulb': emojiMap['Light Bulb'],
          'Film': emojiMap['Film'],
          'Camera': emojiMap['Camera'],
          'Gift snake': emojiMap['Gift']
        };
        for (const key in replacements) {
          text = text.replace(new RegExp(key, 'g'), replacements[key]);
        }
        return text.replace(/\[\w+\]/g, m => m);
      }

      function updateUIState() {
        // Tip
        if (dailyTipText) dailyTipText.textContent = getTodayTip();

        // Templates
        if (isPro) {
          if (templateContainer) {
            templateContainer.classList.remove('hidden');
            templateContainer.style.display = 'grid';
          }
          if (templateTeaser) templateTeaser.style.display = 'none';
          showPage(1);
        } else {
          if (templateContainer) {
            templateContainer.classList.add('hidden');
            templateContainer.style.display = 'none';
          }
          if (templateTeaser) templateTeaser.style.display = 'block';
        }

        // Analysis access
        if (isPro) {
          if (analysisPaywall) analysisPaywall.classList.add('hidden');
          if (analyzeForm) analyzeForm.classList.remove('hidden');
        }

        updateGenerateButtonState();
        showTab(currentTab);
      }

      // --- MAIN GENERATION LOGIC ---
      async function tryGenerate(forceFull = false) {
        if (isGenerating || !userEmail || !ideaInput || !platformSelect || !toneEl) return;

        const idea = ideaInput.value.trim();
        const platform = platformSelect.value;
        const tone = toneEl.value;

        if (!idea || !platform || !tone) {
          if (resultBox) resultBox.classList.add('hidden');
          if (engagementBox) engagementBox.classList.add('hidden');
          if (paywall) paywall.classList.add('hidden');
          return;
        }

        if (!isPro && freeUses >= MAX_FREE_USES) {
          if (paywall) paywall.classList.remove('hidden');
          if (resultBox) resultBox.classList.add('hidden');
          if (engagementBox) engagementBox.classList.add('hidden');
          return;
        }

        isGenerating = true;
        hasBoosted = false;
        lastScore = null;

        if (loadingEl) loadingEl.classList.remove('hidden');
        if (resultBox) resultBox.classList.add('hidden');
        if (engagementBox) engagementBox.classList.add('hidden');
        if (paywall) paywall.classList.add('hidden');

        if (generateBtn) {
          generateBtn.disabled = true;
          generateBtn.textContent = 'Generating...';
        }

        try {
          const res = await fetch(`${API_URL}/generate`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ idea, platform, tone, email: userEmail })
          });
          const data = await res.json();

          if (res.status === 402 || (!isPro && freeUses >= MAX_FREE_USES)) {
            if (paywall) paywall.classList.remove('hidden');
            if (resultBox) resultBox.classList.add('hidden');
          } else if (res.ok) {
            if (outputEl) outputEl.textContent = data.result || '';
            if (resultBox) resultBox.classList.remove('hidden');

            // Compute and show Engagement Score
            const score = computeEngagementScore(data.result || '', idea, platform, tone);
            lastScore = score;
            if (engagementBox && engagementScoreValue && boostBtn) {
              engagementScoreValue.textContent = score;
              engagementBox.classList.remove('hidden');
              boostBtn.disabled = false;
              boostBtn.textContent = 'Boost My Score';
            }

            if (!isPro) {
              freeUses++;
              localStorage.setItem('freeUses', String(freeUses));
              updateGenerateButtonState();
            }

            if (copyBtn) {
              copyBtn.classList.remove('copied');
              copyBtn.textContent = 'Copy All';
            }
          } else if (forceFull) {
            // fallback text
            const fallback = `## Captions
1. "Just launched my coffee shop! ${emojiMap['Coffee']}${emojiMap['Sparkles']}"
2. "Fresh brews, cozy vibes ${emojiMap['Coffee']}${emojiMap['Heart']}"
3. "Your new favorite morning spot!"
4. "Handcrafted with love ${emojiMap['Leaf']}"
5. "Come say hi! ${emojiMap['Hand Wave']}"

## Hashtags
#CoffeeShop #NewBusiness #SmallBiz #CoffeeLovers #LocalCafe #SupportLocal #MorningVibes #CoffeeTime #CafeLife #Entrepreneur #ShopSmall #CoffeeAddict #LatteArt #BrewedFresh #CozyCorner #CoffeeCommunity #SmallBusinessOwner #CoffeeCulture #DailyGrind #CafeVibes #CoffeeBreak #Handcrafted #WomenInBusiness #CoffeeLover #BaristaLife #CoffeeGram #InstaCoffee #CoffeeOfTheDay #CoffeeShopVibes #NewCafe`;
            if (outputEl) outputEl.textContent = fallback;
            if (resultBox) resultBox.classList.remove('hidden');

            const score = computeEngagementScore(fallback, idea, platform, tone);
            lastScore = score;
            if (engagementBox && engagementScoreValue && boostBtn) {
              engagementScoreValue.textContent = score;
              engagementBox.classList.remove('hidden');
              boostBtn.disabled = false;
              boostBtn.textContent = 'Boost My Score';
            }

            if (!isPro) {
              freeUses++;
              localStorage.setItem('freeUses', String(freeUses));
              updateGenerateButtonState();
            }
          }
        } catch (err) {
          console.error(err);
          if (forceFull) {
            if (outputEl) outputEl.textContent = 'AI failed. Please try again.';
            if (resultBox) resultBox.classList.remove('hidden');
            if (engagementBox) engagementBox.classList.add('hidden');
          }
        } finally {
          if (loadingEl) loadingEl.classList.add('hidden');
          if (generateBtn) {
            generateBtn.disabled = false;
            generateBtn.textContent = 'Generate Captions';
          }
          isGenerating = false;
        }
      }

      // --- BOOST BUTTON: calls /optimize and ALWAYS increases score visually ---
      if (boostBtn) {
        boostBtn.addEventListener('click', async () => {
          if (hasBoosted || !outputEl || !outputEl.textContent.trim()) return;
          const idea = ideaInput.value.trim();
          const platform = platformSelect.value;
          const tone = toneEl.value;
          if (!idea || !platform || !tone) return;

          hasBoosted = true;
          const originalLabel = boostBtn.textContent;
          boostBtn.disabled = true;
          boostBtn.textContent = 'Boosting...';

          try {
            const currentText = outputEl.textContent;
            const res = await fetch(`${API_URL}/optimize`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ idea, platform, tone, email: userEmail, currentText })
            });
            if (!res.ok) throw new Error('Optimize failed');
            const data = await res.json();
            const newText = data.result || currentText;
            outputEl.textContent = newText;

            // Re-score
            let newScore = computeEngagementScore(newText, idea, platform, tone);
            if (lastScore != null && newScore <= lastScore) {
              // Always bump up for UX: Balanced but monotonic
              const base = Math.min(lastScore, 97);
              const bump = Math.max(3, Math.round((100 - base) / 6));
              newScore = Math.min(100, base + bump);
            }
            lastScore = newScore;

            if (engagementBox && engagementScoreValue) {
              engagementScoreValue.textContent = newScore;
              engagementBox.classList.remove('hidden');
            }
            boostBtn.textContent = 'Score Boosted';
          } catch (err) {
            console.error(err);
            hasBoosted = false;
            boostBtn.disabled = false;
            boostBtn.textContent = originalLabel;
            alert('Boost failed. Please try again.');
          }
        });
      }

      // --- EVENT WIRING / INITIALIZATION ---
      if (generateTabBtn) generateTabBtn.addEventListener('click', () => showTab('generateContent'));
      if (analyzeTabBtn) analyzeTabBtn.addEventListener('click', () => showTab('analyzeContent'));

      if (subscribeAnalyzeBtn && subscribeBtn) {
        subscribeAnalyzeBtn.addEventListener('click', () => subscribeBtn.click());
      }

      if (page1Btn) page1Btn.addEventListener('click', () => showPage(1));
      if (page2Btn) page2Btn.addEventListener('click', () => showPage(2));

      if (templateContainer) {
        document.querySelectorAll('.templateBtn').forEach(btn => {
          const raw = btn.getAttribute('data-text') || '';
          const renderedText = processTemplateText(raw);
          btn.addEventListener('click', () => {
            ideaInput.value = renderedText;
            ideaInput.focus();
            showTab('generateContent');
          });
        });
      }

      if (unlockTemplatesBtn && paywall) {
        unlockTemplatesBtn.addEventListener('click', () => {
          paywall.classList.remove('hidden');
          paywall.scrollIntoView({ behavior: 'smooth' });
        });
      }

      if (subscribeBtn) {
        subscribeBtn.addEventListener('click', async () => {
          try {
            const res = await fetch(`${API_URL}/create-checkout-session`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ email: userEmail })
            });
            const { url } = await res.json();
            window.location.href = url;
          } catch (err) {
            alert('Checkout failed. Please try again.');
          }
        });
      }

      // Emoji picker
      if (emojiGrid && ideaInput) {
        const commonEmojis = Object.keys(emojiMap);
        emojiGrid.innerHTML = '';
        commonEmojis.forEach(name => {
          const btn = document.createElement('button');
          btn.textContent = emojiMap[name];
          btn.title = name;
          btn.addEventListener('click', () => {
            ideaInput.value += ' ' + emojiMap[name];
            ideaInput.focus();
          });
          emojiGrid.appendChild(btn);
        });
      }
      if (emojiPickerBtn && emojiPicker) {
        emojiPickerBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          emojiPicker.style.display = emojiPicker.style.display === 'flex' ? 'none' : 'flex';
        });
      }
      if (closePicker && emojiPicker) {
        closePicker.addEventListener('click', () => emojiPicker.style.display = 'none');
      }
      document.addEventListener('click', (e) => {
        if (emojiPicker && emojiPickerBtn && !emojiPicker.contains(e.target) && e.target !== emojiPickerBtn) {
          emojiPicker.style.display = 'none';
        }
      });

      // Caption form
      if (captionForm) {
        captionForm.addEventListener('submit', (e) => {
          e.preventDefault();
          clearTimeout(debounceTimer);
          tryGenerate(true);
        });
      }
      ['idea', 'platform', 'tone'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.addEventListener('input', () => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => tryGenerate(false), 900);
          });
        }
      });

      // Copy button
      if (copyBtn && outputEl) {
        copyBtn.addEventListener('click', () => {
          navigator.clipboard.writeText(outputEl.textContent || '').then(() => {
            copyBtn.textContent = 'Copied!';
            copyBtn.classList.add('copied');
            setTimeout(() => {
              copyBtn.textContent = 'Copy All';
              copyBtn.classList.remove('copied');
            }, 2000);
          });
        });
      }

      // Analyze form
      if (analyzeForm && competitorUrlInput) {
        analyzeForm.addEventListener('submit', (e) => {
          e.preventDefault();
          if (!isPro) return;

          if (loadingEl) loadingEl.classList.remove('hidden');
          if (analysisResult) analysisResult.classList.add('hidden');

          const url = competitorUrlInput.value.trim();
          const platform = detectPlatform(url);

          setTimeout(() => {
            if (loadingEl) loadingEl.classList.add('hidden');
            const data = generateDeterministicScore(url);
            if (analysisScore && analysisDetails) {
              analysisScore.textContent = data.score;
              analysisDetails.innerHTML = `
                <p><strong>Platform Detected:</strong> ${platform}</p>
                <p><strong>Hook:</strong> ${data.hook}</p>
                <p><strong>Readability:</strong> ${data.readability}</p>
                <p><strong>Hashtags:</strong> ${data.hashtags}</p>
                <p><strong>Core CTA:</strong> ${data.cta}</p>
              `;
            }
            if (analysisResult) analysisResult.classList.remove('hidden');
          }, 1500);
        });
      }
      if (analyzeAgainBtn && competitorUrlInput && analysisResult) {
        analyzeAgainBtn.addEventListener('click', () => {
          competitorUrlInput.value = '';
          analysisResult.classList.add('hidden');
          competitorUrlInput.focus();
          if (analysisDetails) analysisDetails.innerHTML = '';
        });
      }

      // Handle success URL param for Stripe (mark Pro)
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('success') === 'true') {
        isPro = true;
        localStorage.setItem('isPro', 'true');
        window.history.replaceState({}, document.title, window.location.pathname);
        alert('Welcome to Pro! Unlimited generations + Viral Swipe File + Analyzer unlocked.');
      }

      // EMAIL GATE
      if (!userEmail) {
        if (emailSubmit) {
          emailSubmit.addEventListener('click', () => {
            const email = (emailInput.value || '').trim();
            if (email && /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
              userEmail = email;
              localStorage.setItem('userEmail', email);
              localStorage.setItem('freeUses', '0');
              freeUses = 0;
              modal.style.display = 'none';
              mainApp.style.display = 'block';
              updateUIState();
            } else {
              emailInput.style.borderColor = '#ef4444';
              emailInput.focus();
            }
          });
        }
      } else {
        modal.style.display = 'none';
        mainApp.style.display = 'block';
        updateUIState();
      }
    });
  </script>
</body>
</html>
