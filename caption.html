<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI Caption + Hashtag Generator</title>
  <style>
    :root {
      --primary: #3b82f6;
      --primary-dark: #2563eb;
      --gray: #6b7280;
      --light: #f3f4f6;
      --border: #e5e7eb;
      --placeholder: #9ca3af;
      --success: #10b981;
      --success-dark: #059669;
      --error: #ef4444;
      --warning: #f59e0b;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      color: #111;
      min-height: 100vh;
      padding: 2rem 1rem;
    }
    .container { max-width: 600px; margin: 0 auto; }
    h1 { font-size: 2.25rem; font-weight: 700; text-align: center; margin-bottom: .5rem; }
    p.subtitle { text-align: center; color: var(--gray); margin-bottom: 1.5rem; font-size: 1.1rem; }

    .proof {
      background: #ecfdf5;
      border: 1px solid #a7f3d0;
      padding: 1rem;
      border-radius: .75rem;
      text-align: center;
      margin-bottom: 1.5rem;
      font-size: .95rem;
      color: #065f46;
    }
    .proof strong { font-weight: 600; }

    /* Daily tip */
    #dailyTipBox {
      background: #fff;
      border: 1px solid #d1d5db;
      padding: 1rem;
      border-radius: .75rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 5px rgba(0,0,0,0.02);
      font-size: .95rem;
      line-height: 1.4;
    }
    #dailyTipBox strong {
      color: var(--warning);
      margin-right: .5rem;
    }

    /* Email modal */
    #emailModal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.7); display: flex; align-items: center;
      justify-content: center; z-index: 9999;
    }
    .modal-content {
      background: white; padding: 2rem; border-radius: 1rem;
      width: 90%; max-width: 400px; text-align: center;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }
    .modal-content h2 { margin-bottom: 1rem; font-size: 1.5rem; }
    .modal-content p { margin-bottom: 1.5rem; color: #555; }
    .modal-content input {
      width: 100%; padding: .75rem; border: 2px solid #e5e7eb;
      border-radius: .5rem; font-size: 1rem; margin-bottom: 1rem;
    }
    .modal-content button {
      background: var(--primary); color: white; border: none;
      padding: .75rem 1.5rem; border-radius: .5rem; font-weight: 600;
      cursor: pointer; width: 100%;
    }

    label { display: block; margin-bottom: .5rem; font-weight: 600; color: #111; }
    input, select {
      width: 100%; padding: .75rem 1rem; border: 2px solid var(--border);
      border-radius: .5rem; font-size: 1rem; margin-bottom: 1rem;
      transition: border .2s;
    }
    input:focus, select:focus { outline: none; border-color: var(--primary); }
    input::placeholder { color: var(--placeholder); font-style: italic; }

    select option[disabled] { display: none; }
    select option[data-placeholder] { color: var(--placeholder); font-style: italic; }
    select:invalid { color: var(--placeholder); }
    select:valid { color: #111; }

    button {
      width: 100%; background: var(--primary); color: white; border: none;
      padding: 1rem; font-size: 1.1rem; font-weight: 600; border-radius: .5rem;
      cursor: pointer; transition: background .2s;
    }
    button:hover { background: var(--primary-dark); }
    button:disabled { background: #93c5fd; cursor: not-allowed; }

    /* Tabs */
    #tabHeader {
      display: flex;
      margin-bottom: 1.5rem;
      border-bottom: 2px solid var(--border);
    }
    .tab-btn {
      flex: 1;
      padding: 0.75rem 0;
      background: none;
      border: none;
      font-weight: 600;
      cursor: pointer;
      color: var(--gray);
      font-size: 1.1rem;
      border-bottom: 3px solid transparent;
      transition: color 0.2s, border-bottom 0.2s;
      border-radius: 0;
      width: auto;
    }
    .tab-btn.active {
      color: var(--primary);
      border-bottom: 3px solid var(--primary);
    }

    .tab-content { padding: 0; }

    /* Result card */
    .result {
      margin-top: 2rem; padding: 1.5rem; background: white; border-radius: .75rem;
      box-shadow: 0 4px 12px rgba(0,0,0,.05); position: relative;
    }
    .result h3 { margin-bottom: .75rem; color: var(--primary); }
    .result pre {
      white-space: pre-wrap; font-family: inherit; line-height: 1.6; margin-bottom: 1rem;
    }

    /* Engagement box */
    .engagement-box {
      display: none;
      margin-bottom: 1rem;
      padding: 0.85rem 0.9rem;
      border-radius: 0.75rem;
      background: #eff6ff;
      border: 1px solid #bfdbfe;
    }
    .engagement-main {
      display: flex;
      align-items: baseline;
      gap: 0.35rem;
      margin-bottom: 0.25rem;
    }
    .engagement-title {
      font-size: 0.9rem;
      font-weight: 600;
      color: #1d4ed8;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    .engagement-value {
      font-size: 1.5rem;
      font-weight: 700;
    }
    .engagement-max {
      font-size: 0.9rem;
      color: #4b5563;
    }
    .engagement-subtext {
      font-size: 0.8rem;
      color: #4b5563;
      margin-bottom: 0.5rem;
    }
    .boost-btn {
      width: 100%;
      background: #16a34a;
      font-size: 0.95rem;
      padding: 0.6rem 0.9rem;
      border-radius: 0.6rem;
      font-weight: 600;
    }
    .boost-btn.used {
      background: #9ca3af;
      cursor: default;
    }

    #copyBtn {
      position: absolute; top: 1rem; right: 1rem; background: var(--success);
      color: white; padding: .5rem 1rem; border: none; border-radius: .5rem;
      font-size: .9rem; cursor: pointer; transition: background .2s;
    }
    #copyBtn:hover { background: var(--success-dark); }
    #copyBtn.copied { background: #059669; }

    /* Emoji picker */
    #emojiPickerBtn {
      background: var(--warning); margin: 1rem 0; width: auto; padding: .5rem 1rem; font-size: .9rem;
    }
    .emoji-picker-container {
      position: relative;
      text-align: left;
      display: flex;
      justify-content: center;
    }
    #emojiPicker {
      display: none;
      position: absolute;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: .75rem;
      padding: 1rem;
      max-width: 300px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.15);
      z-index: 100;
      text-align: center;
      max-height: 350px;
      flex-direction: column;
      right: 0;
      top: 100%;
      transform: translateY(5px);
    }
    #emojiGrid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: .5rem;
      font-size: 1.5rem;
      margin: .75rem 0;
      overflow-y: auto;
      padding-right: 5px;
    }
    #emojiGrid button {
      background: none; border: none; font-size: 1.5rem; cursor: pointer; padding: 0;
    }
    #closePicker {
      margin-top: .5rem; background: #6b7280; color: white; padding: .5rem 1rem;
      border-radius: .5rem; font-size: .8rem; width: auto;
    }

    /* Pro templates */
    #proTemplates {
      margin-top: 2rem; padding: 1.5rem; background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: .75rem;
    }
    .templateBtn {
      text-align: left;
      padding: .75rem;
      background: white;
      border: 1px solid #d1d5db;
      border-radius: .5rem;
      font-size: .9rem;
      margin-bottom: .5rem;
      cursor: pointer;
      color: #111 !important;
      line-height: 1.4;
      display: block;
    }
    .templateBtn:hover {
      background: #f9fafb;
      color: #111 !important;
    }

    #templateContainer {
      display: grid;
      gap: .5rem;
      font-size: .9rem;
      margin-top: 1rem;
    }
    #templatePage2 { display: none; }

    #templatePaging {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-top: 1rem;
    }
    #templatePaging button {
      width: auto;
      padding: .5rem 1.2rem;
      background: #9ca3af;
      font-weight: 500;
      font-size: .9rem;
    }
    #templatePaging button.active {
      background: var(--primary);
      font-weight: 700;
    }
    #templatePaging button:hover {
      background: var(--primary-dark);
    }

    /* Paywall */
    .paywall {
      margin-top: 2rem; padding: 2rem; background: #fefce8; border-radius: .75rem;
      text-align: center; border: 2px solid #fde68a;
    }
    .paywall h3 { margin-bottom: .5rem; font-size: 1.5rem; }
    .paywall p { color: #92400e; margin-bottom: 1rem; }
    .paywall button {
      background: #16a34a; padding: .75rem 1.5rem; font-size: 1rem;
      width: auto; display: inline-block;
    }
    .paywall button:hover { background: #15803d; }

    .analysis-card {
      background: white;
      border: 1px solid var(--border);
      border-radius: .75rem;
      padding: 1.5rem;
      margin-top: 1.5rem;
      box-shadow: 0 4px 12px rgba(0,0,0,.05);
    }
    .analysis-score {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--primary);
      text-align: center;
      margin-bottom: .5rem;
    }
    .analysis-detail {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px dashed var(--border);
    }
    .analysis-detail p {
      margin-bottom: .5rem;
      line-height: 1.4;
    }

    .hidden { display: none; }
    .loading { text-align: center; margin: 1rem 0; color: var(--gray); font-style: italic; }

    footer {
      margin-top: 3rem; text-align: center; color: #6b7280; font-size: 0.875rem;
    }
    footer a { color: inherit; margin: 0 1rem; text-decoration: underline; }

    @media (max-width: 480px) {
      h1 { font-size: 1.75rem; }
      .container { padding: 0 1rem; }
      #copyBtn { position: static; margin-top: 1rem; width: 100%; }
      #emojiGrid { grid-template-columns: repeat(5, 1fr); }
      #emojiPicker {
        right: auto;
        left: 50%;
        transform: translateX(-50%) translateY(5px);
      }
    }
  
    /* Toast notification */
    #toast {
      position: fixed;
      bottom: 1.5rem;
      right: 1.5rem;
      background: #111827;
      color: white;
      padding: 0.75rem 1rem;
      border-radius: 0.75rem;
      font-size: 0.9rem;
      box-shadow: 0 10px 25px rgba(0,0,0,0.18);
      opacity: 0;
      pointer-events: none;
      transform: translateY(10px);
      transition: opacity 0.2s ease, transform 0.2s ease;
      z-index: 99999;
    }
    #toast.show {
      opacity: 1;
      pointer-events: auto;
      transform: translateY(0);
    }
    #toast.toast-success { background: #047857; }
    #toast.toast-error { background: #b91c1c; }
    #toast.toast-info { background: #111827; }

    /* Pro badge */
    #proBadge {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      background: linear-gradient(135deg, #4f46e5, #7c3aed);
      color: white;
      border-radius: 999px;
      padding: 0.2rem 0.6rem;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-left: 0.5rem;
      vertical-align: middle;
    }
    #proBadge.hidden {
      display: none;
    }

    /* Free usage bar */
    #freeUsageBar {
      margin: 0.75rem 0 1.25rem;
      font-size: 0.85rem;
      color: #4b5563;
    }
    #freeUsageBar.hidden {
      display: none;
    }
    .free-usage-track {
      width: 100%;
      background: #e5e7eb;
      border-radius: 999px;
      height: 0.6rem;
      margin-top: 0.35rem;
      overflow: hidden;
    }
    .free-usage-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #3b82f6, #10b981);
      transition: width 0.25s ease;
    }

  </style>
</head>
<body>

  <!-- Email gate -->
  <div id="emailModal">
    <div class="modal-content">
      <h2>Welcome!</h2>
      <p>Enter your email to get <strong>10 free generations</strong>.</p>
      <input type="email" id="emailInput" placeholder="you@example.com" required />
      <button id="emailSubmit">Start Generating</button>
    </div>
  </div>

  <!-- Main app -->
  <div class="container" id="mainApp" style="display: none;">
    <h1>AI Caption + Hashtag Generator <span id="proBadge" class="hidden">PRO</span></h1>
    <p class="subtitle">Get 5 viral captions + 30 hashtags in 3 seconds.</p>
    <div id="freeUsageBar" class="hidden">
      <div><span id="freeUsageText">10 free generations remaining.</span></div>
      <div class="free-usage-track">
        <div class="free-usage-fill" id="freeUsageFill"></div>
      </div>
    </div>


    <div class="proof">
      <strong>Stop guessing and start optimizing. The only AI Caption Generator with a built-in Engagement & Boost Score.</strong>
    </div>

    <div id="dailyTipBox">
      <strong>ğŸ’¡ Today's Tip:</strong>
      <span id="dailyTipText">Loading a viral content tip...</span>
    </div>
<h3 style="margin-top: 25px;">Affiliate Program</h3>
<button id="becomeAffiliateBtn" class="action-button">Become an Affiliate</button>
<button id="getReferralLinkBtn" class="action-button" style="margin-left:10px;">Get Referral Link</button>

<div id="affiliateLinkContainer" style="margin-top:10px; display:none;">
    <label>Your Referral Link:</label>
    <input id="affiliateLink" type="text" readonly style="width:100%; padding:8px; margin-top:5px;">
    <button id="copyReferralBtn" class="action-button" style="margin-top:8px;">Copy Link</button>
</div>


    <div id="tabContainer">
      <div id="tabHeader">
        <button id="generateTabBtn" class="tab-btn active" data-target="generateContent">Generate Content</button>
        <button id="analyzeTabBtn" class="tab-btn" data-target="analyzeContent">Analyze Competitor (Pro)</button>
      </div>

      <!-- GENERATE TAB -->
      <div id="generateContent" class="tab-content">
        <form id="captionForm">
          <label for="idea">Post Idea</label>
          <input type="text" id="idea" placeholder="e.g. Just launched my coffee shop" required />

          <label for="platform">Platform</label>
          <select id="platform" required>
            <option value="" disabled selected data-placeholder>Choose platform</option>
            <option value="Instagram">Instagram</option>
            <option value="Twitter">Twitter</option>
            <option value="LinkedIn">LinkedIn</option>
            <option value="TikTok">TikTok</option>
          </select>

          <label for="tone">Tone</label>
          <select id="tone" required>
            <option value="" disabled selected data-placeholder>Choose tone</option>
            <option value="Professional">Professional</option>
            <option value="Fun & Playful">Fun & Playful</option>
            <option value="Inspirational">Inspirational</option>
            <option value="Bold & Confident">Bold & Confident</option>
            <option value="Casual & Friendly">Casual & Friendly</option>
          </select>

          <button type="submit" id="generateBtn">Generate Captions</button>
        </form>

        <div class="emoji-picker-container">
          <button type="button" id="emojiPickerBtn">Add Emojis</button>
          <div id="emojiPicker">
            <p style="margin-bottom: .75rem; font-weight: 600;">Pick Emojis</p>
            <div id="emojiGrid"></div>
            <button id="closePicker">Close</button>
          </div>
        </div>

        <div id="loading" class="loading hidden">Generating magic...</div>

        <div id="result" class="result hidden">
          <h3>Your AI Captions</h3>

          <!-- Engagement score + Boost -->
          <div id="engagementBox" class="engagement-box">
            <div class="engagement-main">
              <span class="engagement-title">Engagement Score</span>
              <span id="engagementScoreValue" class="engagement-value">--</span>
              <span class="engagement-max">/100</span>
            </div>
            <p id="engagementSubtext" class="engagement-subtext">
              Higher scores usually mean more saves, comments, and shares.
            </p>
            <button id="boostBtn" type="button" class="boost-btn">Boost My Score</button>
          </div>

          <pre id="output"></pre>
          <button type="button" id="copyBtn">Copy All</button>
        </div>

        <!-- Pro Templates -->
        <div id="proTemplates">
          <h3>The Viral Swipe File: Proven 6-Figure Post Structures</h3>
          <p style="margin: 1rem 0 .75rem; font-size: .95rem; color: #065f46; line-height: 1.5;">
            <strong>Steal the exact captions used by 6-figure creators.</strong>
            These arenâ€™t random â€” theyâ€™re <em>proven</em> to get 3x more likes, comments, and saves.
            Just click, edit, generate. <strong>Instant viral edge.</strong>
          </p>

          <div id="templateContainer" class="hidden">
            <div id="templatePage1">
              <button class="templateBtn" data-text="Just hit [X] followers! Grateful for every one of you Heart Sparkles">
                Just hit [X] followers! Grateful for every one of you â¤ï¸ âœ¨
              </button>
              <button class="templateBtn" data-text="Behind the scenes of [your idea] Camera Film">
                Behind the scenes of [your idea] ğŸ“¸ ğŸ¬
              </button>
              <button class="templateBtn" data-text="Tag a friend who needs this! Hand Point Down">
                Tag a friend who needs this! ğŸ‘‡
              </button>
              <button class="templateBtn" data-text="New drop alert! Link in bio Shopping Bag Fire">
                New drop alert! Link in bio ğŸ›ï¸ ğŸ”¥
              </button>
              <button class="templateBtn" data-text="Your daily dose of [topic] Coffee Mug Light Bulb">
                Your daily dose of [topic] â˜• ğŸ’¡
              </button>
              <button class="templateBtn" data-text="Reply with YES or NO: [question]? Question Mark Thinking Face">
                Reply with YES or NO: [question]? â“ ğŸ¤”
              </button>
              <button class="templateBtn" data-text="Save this for later â€” youâ€™ll thank me! Bookmark Sparkles">
                Save this for later â€” youâ€™ll thank me! ğŸ”– âœ¨
              </button>
              <button class="templateBtn" data-text="Free [resource] in bio! Donâ€™t miss it Gift Rocket">
                Free [resource] in bio! Donâ€™t miss it ğŸ ğŸš€
              </button>
              <button class="templateBtn" data-text="Swipe up to see the full story! Hand Point Up Film">
                Swipe up to see the full story! ğŸ‘† ğŸ¬
              </button>
              <button class="templateBtn" data-text="'Changed my [niche] game!' â€“ @username Star Speech Bubble">
                "Changed my [niche] game!" â€“ @username â­ ğŸ’¬
              </button>
            </div>

            <div id="templatePage2">
              <button class="templateBtn" data-text="You think [Product] is too expensive? Here's the ROI breakdown. Money Bag Chart Increasing">
                You think [Product] is too expensive? Here's the ROI breakdown. ğŸ’¸ ğŸ“ˆ
              </button>
              <button class="templateBtn" data-text="Stop wasting time on [Frustrating Task]. Our 3-step solution: [Solution]. Crying Face Check Mark">
                Stop wasting time on [Frustrating Task]. Our 3-step solution: [Solution]. ğŸ˜« âœ…
              </button>
              <button class="templateBtn" data-text="6 months ago I was [Stuck]... now I'm [Success]. The difference: [1 Thing]. Thinking Face Light Bulb">
                6 months ago I was [Stuck]... now I'm [Success]. The difference: [1 Thing]. ğŸ¤¯ ğŸ’¡
              </button>
              <button class="templateBtn" data-text="How I made [High Result] in [Short Time]: Step 1: [Action]. Save for steps 2 & 3. Toolbox Target">
                How I made [High Result] in [Short Time]: Step 1: [Action]. Save for steps 2 & 3. ğŸ› ï¸ ğŸ¯
              </button>
              <button class="templateBtn" data-text="Unpopular opinion: [Common Belief] is completely wrong. Here's why. Speech Bubble Cross Mark">
                Unpopular opinion: [Common Belief] is completely wrong. Here's why. ğŸ—£ï¸ âŒ
              </button>
              <button class="templateBtn" data-text="Get the exact checklist I use to [Goal]! Click the link that says Link Bookmark">
                Get the exact checklist I use to [Goal]! Click the link that says "Free Guide." ğŸ”— ğŸ”–
              </button>
              <button class="templateBtn" data-text="Myth: You need [X] to succeed. Reality: You only need [Y]. Which shocked you? Smiling Face 100 Score">
                Myth: You need [X] to succeed. Reality: You only need [Y]. Which shocked you? ğŸ˜® ğŸ’¯
              </button>
              <button class="templateBtn" data-text="Client Spotlight: [Client Name] went from [A] to [B] in 30 days. Their secret was [Tool]. User Rocket">
                Client Spotlight: [Client Name] went from [A] to [B] in 30 days. Their secret was [Tool]. ğŸ‘¤ ğŸš€
              </button>
              <button class="templateBtn" data-text="My most impactful habit for [Goal]? Doing [Task] at [Time]. Steal it. Alarm Clock Flexed Biceps">
                My most impactful habit for [Goal]? Doing [Task] at [Time]. Steal it. â° ğŸ’ª
              </button>
              <button class="templateBtn" data-text="[Option A] vs. [Option B]: Which is better for [Specific Use Case]? Swipe to see the pros/cons. Balance Scale Magnifying Glass">
                [Option A] vs. [Option B]: Which is better for [Specific Use Case]? Swipe to see the pros/cons. âš–ï¸ ğŸ§
              </button>
            </div>

            <div id="templatePaging">
              <button id="page1Btn" class="active">Page 1</button>
              <button id="page2Btn">Page 2</button>
            </div>
          </div>

          <div id="templateTeaser">
            <p style="font-size: .9rem; color: #92400e; font-style: italic; margin-top: 1rem;">
              <strong>Unlock 20 Viral Swipe File Structures</strong> â€” only available in <strong>Pro</strong>.
            </p>
            <button id="unlockTemplatesBtn" style="
              background: #f59e0b; color: white; border: none; padding: .6rem 1.2rem;
              border-radius: .5rem; font-size: .9rem; font-weight: 600; cursor: pointer;
              margin-top: .5rem;
            ">Upgrade to Pro</button>
          </div>
        </div>

        <div id="paywall" class="paywall hidden">
          <h3>Upgrade to Pro!</h3>
          <p>You've used your 10 free generations. <strong>Unlimited + 20 Viral Swipe File Structures</strong> for <strong>$7/month</strong>.</p>
          <button id="subscribeBtn">Subscribe Now</button>
        </div>
      </div>

      <!-- ANALYZE TAB -->
      <div id="analyzeContent" class="tab-content hidden">
        <div id="analysisDescription" style="
          background: #f0f9ff;
          border: 1px solid #bae6fd;
          padding: 1.2rem;
          border-radius: .75rem;
          margin-bottom: 1.5rem;
          font-size: .95rem;
          line-height: 1.5;
          color: #0369a1;
        ">
          <h4 style="margin-bottom: .5rem; color: #075985; font-size: 1.1rem;">
            Reverse-Engineer Viral Success ğŸ”¬
          </h4>
          Paste any competitor's post URL (Instagram, Twitter, etc.) and our AI will deconstruct their strategy.
          Get an instant <strong>Content Score</strong> and a breakdown of their hook, CTA, and hashtag usage.
        </div>

        <div id="analysisPaywall" class="paywall hidden" style="margin-top: 1rem;">
          <h3>Unlock Analysis!</h3>
          <p>Content Scoring is an exclusive <strong>Pro</strong> feature. Unlimited Access for <strong>$7/month</strong>.</p>
          <button id="subscribeAnalyzeBtn">Upgrade to Pro</button>
        </div>

        <form id="analyzeForm" class="hidden">
          <label for="competitorUrl">Competitor Post URL</label>
          <input type="url" id="competitorUrl" placeholder="e.g. https://instagram.com/p/B..." required />
          <button type="submit" id="analyzeBtn">Analyze Post Structure</button>
        </form>

        <div id="analysisResult" class="analysis-card hidden">
          <p style="text-align: center; font-size: 1.2rem; font-weight: 600; margin-bottom: 0;">Content Score</p>
          <div id="analysisScore" class="analysis-score">--</div>
          <div id="analysisDetails" class="analysis-detail"></div>
          <button id="analyzeAgainBtn">Analyze Another Post</button>
        </div>
      </div>
    </div>

    <footer>
      <a href="/terms.html">Terms</a>
      <a href="/privacy.html">Privacy</a>
      <span>Â© 2025 Caption AI</span>
    </footer>
  </div>

  <script>
// --- Referral Code Capture ---
const urlParams = new URLSearchParams(window.location.search);
const referralCode = urlParams.get("ref") || "";
localStorage.setItem("referralCode", referralCode);

// ---

  document.addEventListener('DOMContentLoaded', () => {
    const API_URL = 'https://caption-ai-ze13.onrender.com';
    const MAX_FREE_USES = 10;

    // --- Global state ---
    let userEmail = localStorage.getItem('userEmail');
    let isPro = false;
    let isVip = false;
    let freeUses = parseInt(localStorage.getItem('freeUses') || '0', 10);
    let currentTab = localStorage.getItem('lastTab') || 'generateContent';

    let debounceTimer;
    let isGenerating = false;
    let hasBoostedCurrentOutput = false;
    let lastResultText = '';
    let lastScore = null;
    let lastIdea = '';
    let lastPlatform = '';
    let lastTone = '';

    
    // --- Auto-detect Pro status from backend if email known ---
    async function hydrateProFromServer() {
      try {
        if (!userEmail) return;
        const res = await fetch(`${API_URL}/check-subscription?email=${encodeURIComponent(userEmail)}`);
        if (!res.ok) return;
        const data = await res.json();
        if (data && data.isPro) {
            isPro = true;
            localStorage.setItem('isPro', 'true');
            if (data.vip) {
              isVip = true;
              localStorage.setItem('isVip','true');
            } else {
              isVip = false;
              localStorage.removeItem('isVip');
            }
          } else if (data && data.isPro === false) {
            isPro = false;
            localStorage.setItem('isPro', 'false');
            isVip = false;
            localStorage.removeItem('isVip');
          } else if (data && data.isPro) {
            isPro = true;
            localStorage.setItem('isPro', 'true');
            if (data.vip) {
              isVip = true;
              localStorage.setItem('isVip','true');
            } else {
              isVip = false;
              localStorage.removeItem('isVip');
            }
          } else if (data && data.isPro === false) {
            isPro = false;
            localStorage.setItem('isPro', 'false');
            isVip = false;
            localStorage.removeItem('isVip');
          }
        refreshProUI();
        updateGenerateButtonState();
      } catch (e) {
        console.error('hydrateProFromServer error', e);
      }
    }
// --- Elements ---
    const modal        = document.getElementById('emailModal');
    const mainApp      = document.getElementById('mainApp');
    const emailInput   = document.getElementById('emailInput');
    const emailSubmit  = document.getElementById('emailSubmit');

    const ideaInput    = document.getElementById('idea');
    const platformSel  = document.getElementById('platform');
    const toneSel      = document.getElementById('tone');

    const generateBtn  = document.getElementById('generateBtn');
    const resultBox    = document.getElementById('result');
    const outputEl     = document.getElementById('output');
    const loadingEl    = document.getElementById('loading');
    const paywallEl    = document.getElementById('paywall');

    const engagementBox   = document.getElementById('engagementBox');
    const engagementValue = document.getElementById('engagementScoreValue');
    const engagementSub   = document.getElementById('engagementSubtext');
    const boostBtn        = document.getElementById('boostBtn');

    const generateTabBtn = document.getElementById('generateTabBtn');
    const analyzeTabBtn  = document.getElementById('analyzeTabBtn');
    const generateContent = document.getElementById('generateContent');
    const analyzeContent  = document.getElementById('analyzeContent');
    const analysisPaywall = document.getElementById('analysisPaywall');
    const analyzeForm     = document.getElementById('analyzeForm');
    const competitorUrlInput = document.getElementById('competitorUrl');
    const analyzeAgainBtn = document.getElementById('analyzeAgainBtn');
    const analysisResult  = document.getElementById('analysisResult');

    const subscribeBtn         = document.getElementById('subscribeBtn');
    const subscribeAnalyzeBtn  = document.getElementById('subscribeAnalyzeBtn');
    const copyBtn              = document.getElementById('copyBtn');

    const emojiPickerBtn = document.getElementById('emojiPickerBtn');
    const picker         = document.getElementById('emojiPicker');
    const emojiGrid      = document.getElementById('emojiGrid');
    const closePicker    = document.getElementById('closePicker');

    const templateContainer = document.getElementById('templateContainer');
    const templateTeaser    = document.getElementById('templateTeaser');
    const page1             = document.getElementById('templatePage1');
    const page2             = document.getElementById('templatePage2');
    const page1Btn          = document.getElementById('page1Btn');
    const page2Btn          = document.getElementById('page2Btn');
    const unlockTemplatesBtn = document.getElementById('unlockTemplatesBtn');

    const tipElement = document.getElementById('dailyTipText');

    
    // --- Toast helper ---
    const toastEl = document.getElementById('toast');
    function showToast(message, type = 'info') {
      if (!toastEl) return;
      toastEl.textContent = message;
      toastEl.classList.remove('toast-success', 'toast-error', 'toast-info', 'show');
      toastEl.classList.add(`toast-${type}`);
      // small reflow
      void toastEl.offsetWidth;
      toastEl.classList.add('show');
      setTimeout(() => {
        toastEl.classList.remove('show');
      }, 3500);
    }

    // --- Free usage progress helper ---
    const freeUsageBar = document.getElementById('freeUsageBar');
    const freeUsageText = document.getElementById('freeUsageText');
    const freeUsageFill = document.getElementById('freeUsageFill');

    function updateFreeUsageBar() {
      if (!freeUsageBar || !freeUsageFill || !freeUsageText) return;
      if (isPro) {
        freeUsageBar.classList.add('hidden');
        return;
      }
      const used = Math.min(freeUses, MAX_FREE_USES);
      const remaining = Math.max(MAX_FREE_USES - used, 0);
      const pct = (used / MAX_FREE_USES) * 100;
      freeUsageBar.classList.remove('hidden');
      freeUsageFill.style.width = `${pct}%`;
      freeUsageText.textContent = `${remaining} free generation${remaining === 1 ? '' : 's'} remaining.`;
    }

    // --- Central Pro UI refresh ---
    const proBadge = document.getElementById('proBadge');

    function refreshProUI() {
      try {
        // Pro badge
        if (proBadge) {
          if (isPro) { proBadge.classList.remove('hidden'); proBadge.innerHTML = isVip ? "PRO <span style='color: gold; font-weight: 700;'>(VIP)</span>" : "PRO"; }
          else proBadge.classList.add('hidden');
        }

        // Free usage bar
        updateFreeUsageBar();

        // Templates visibility
        if (templateContainer && templateTeaser) {
          if (isPro) {
            templateContainer.classList.remove('hidden');
            templateContainer.style.display = 'grid';
            templateTeaser.style.display = 'none';
          } else {
            templateContainer.classList.add('hidden');
            templateContainer.style.display = 'none';
            templateTeaser.style.display = 'block';
          }
        }

        // Analyze paywall
        if (analysisPaywall && analyzeContent) {
          if (isPro) {
            analysisPaywall.classList.add('hidden');
          }
        }
      } catch (e) {
        console.error('refreshProUI error', e);
      }
    }
// --- Emoji map (for templates & fallback) ---
    const emojiMap = {
      'Camera': 'ğŸ“¸', 'Heart': 'â¤ï¸', 'Sparkles': 'âœ¨', 'Coffee': 'â˜•', 'Shopping Bag': 'ğŸ›ï¸',
      'Rocket': 'ğŸš€', 'Fire': 'ğŸ”¥', 'Trophy': 'ğŸ†', 'Briefcase': 'ğŸ’¼', 'Handshake': 'ğŸ¤',
      'Laptop': 'ğŸ’»', 'Sunrise': 'ğŸŒ…', 'Moon': 'ğŸŒ™', 'Pizza': 'ğŸ•', 'Leaf': 'ğŸƒ',
      'Flexed Biceps': 'ğŸ’ª', 'Airplane': 'âœˆï¸', 'Book': 'ğŸ“š', 'Dog': 'ğŸ¶', 'Cat': 'ğŸ±',
      'Birthday Cake': 'ğŸ‚', 'Party Popper': 'ğŸ‰', 'Star': 'â­', 'Film': 'ğŸ¬',
      'Musical Notes': 'ğŸ¶', 'Dancer': 'ğŸ’ƒ', 'Play Button': 'â–¶ï¸', 'New': 'ğŸ†•', 'Sale': 'ğŸ·ï¸',
      'Check Mark': 'âœ…', 'Cross Mark': 'âŒ', 'Hand Point Down': 'ğŸ‘‡', 'Coffee Mug': 'â˜•', 'Hand Wave': 'ğŸ‘‹',
      'Light Bulb': 'ğŸ’¡', 'Thinking Face': 'ğŸ¤”', '100 Score': 'ğŸ’¯', 'Money Bag': 'ğŸ’¸',
      'Chart Increasing': 'ğŸ“ˆ', 'Target': 'ğŸ¯', 'Alarm Clock': 'â°', 'Question Mark': 'â“',
      'Speech Bubble': 'ğŸ’¬', 'Crown': 'ğŸ‘‘', 'Diamond': 'ğŸ’', 'Robot': 'ğŸ¤–',
      'Globe': 'ğŸŒ', 'Mountain': 'â›°ï¸', 'Pin': 'ğŸ“Œ', 'Megaphone': 'ğŸ“£',
      'Writing Hand': 'âœï¸', 'Open Book': 'ğŸ“–', 'Smiling Face': 'ğŸ˜Š', 'Crying Face': 'ğŸ˜«',
      'Clapping Hands': 'ğŸ‘', 'Winking Face': 'ğŸ˜‰', 'Red Apple': 'ğŸ', 'Grapes': 'ğŸ‡',
      'Donut': 'ğŸ©', 'Taco': 'ğŸŒ®', 'Beer Mug': 'ğŸº', 'Martini Glass': 'ğŸ¸',
      'Car': 'ğŸš—', 'Bicycle': 'ğŸš²', 'Train': 'ğŸš†', 'Boat': 'â›µ',
      'Fingers Crossed': 'ğŸ¤', 'Poo': 'ğŸ’©', 'Ghost': 'ğŸ‘»', 'Alien': 'ğŸ‘½',
      'Lock': 'ğŸ”’', 'Key': 'ğŸ”‘', 'Toolbox': 'ğŸ› ï¸', 'Graduation Cap': 'ğŸ“',
      'Bookmark': 'ğŸ”–', 'Gift': 'ğŸ', 'Hand Point Up': 'ğŸ‘†',
      'Link': 'ğŸ”—', 'Balance Scale': 'âš–ï¸', 'Magnifying Glass': 'ğŸ§', 'User': 'ğŸ‘¤'
    };

    // --- Daily tips ---
    const dailyTips = [
      "Hook the reader in the first sentence. Your AI captions are useless if no one stops scrolling!",
      "Always include a clear CTA at the end: Ask a question, tell them to save the post, or tag a friend.",
      "Use 2â€“3 broad hashtags + 10+ niche-specific hashtags for maximum reach.",
      "Test different tones for the same idea. â€˜Boldâ€™ might beat â€˜Casualâ€™ by 50%.",
      "Use the Analyze tab on competitor posts to reverse-engineer their hooks.",
      "Reply to comments in the first hour to signal value to the algorithm.",
      "Vertical video is king. Use captions to drive watch time and saves.",
      "Keep paragraphs to 1â€“2 lines for maximum readability.",
      "Make your idea benefit-focused: â€˜Save 2 hours a weekâ€™ beats â€˜My new softwareâ€™.",
      "On LinkedIn, lean Professional tone + minimal emojis + clear business outcomes.",
      "Great captions = strong hook â†’ story/value â†’ clear CTA.",
      "Numbered lists (â€˜3 ways toâ€¦â€™) are highly scannable and shareable.",
      "Emoji at the start of the first line can help stop the scroll.",
      "On Twitter/X, make the first line punchy and thread if needed.",
      "Generate multiple options and combine the strongest hook, middle, and CTA."
    ];

    function getTodayTip() {
      const today = new Date();
      const start = new Date(today.getFullYear(), 0, 0);
      const diff = today - start;
      const oneDay = 1000 * 60 * 60 * 24;
      const dayOfYear = Math.floor(diff / oneDay);
      const tipIndex = dayOfYear % dailyTips.length;
      return dailyTips[tipIndex];
    }

    // --- Utility: hash & pseudo-random (for scoring jitter) ---
    function hashString(str) {
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        const chr = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + chr;
        hash |= 0;
      }
      return Math.abs(hash);
    }
    function seededRandom(seed, min = 0, max = 1) {
      const x = Math.sin(seed) * 10000;
      const frac = x - Math.floor(x);
      return min + frac * (max - min);
    }

    // --- Engagement scoring (Option C: nuanced & less predictable) ---
        // --- Engagement scoring (Option A: calmer + platform-aware) ---
    // --- Engagement scoring (Rebalanced across all platforms) ---
    
    // --- Engagement scoring (Rebalanced across all platforms) ---
    function computeEngagementScore(text, idea, platform, tone) {
        if (!text || typeof text !== "string") return 30;

        const platformKey = (platform || "").toLowerCase();
        const tLower = (tone || "").toLowerCase();
        const ideaStr = (idea || "").trim();

        const isGenericIdea =
            ideaStr.length > 0 &&
            ideaStr.length <= 40 &&
            !/[?!]/.test(ideaStr) &&
            !/[#@]/.test(ideaStr) &&
            !/[ğŸ”¥âœ¨ğŸ’¥ğŸš€â­ğŸ’¯ğŸ˜±ğŸ˜ğŸ¤¯]/.test(ideaStr);

        const lines = text.split("\n");
        const captionLines = lines.filter((l) => /^\s*\d+\./.test(l));
        const allHashtags = text.match(/#[\p{L}\p{N}_]+/gu) || [];
        const totalChars = text.length;
        const totalWords = text.split(/\s+/).filter(Boolean).length;

        // Start from a neutral mid-range
        let score = 45;

        // Generic idea penalties (any platform)
        if (isGenericIdea) score -= 18;

        // Word count effects
        if (totalWords < 30) score -= 10;        // too light
        if (totalWords < 15) score -= 8;         // really thin
        if (totalWords > 200) score += 4;        // longer, more substance

        // Structure (multiple numbered captions)
        if (captionLines.length >= 5) score += 8;
        else if (captionLines.length >= 3) score += 5;
        else if (captionLines.length >= 1) score += 2;

        // Hashtags band
        if (allHashtags.length >= 12 && allHashtags.length <= 30) score += 8;
        else if (allHashtags.length >= 6 && allHashtags.length < 12) score += 4;

        // Platform-specific adjustments
        if (platformKey === "twitter") {
            score -= 6;                            // overall lower band
            if (totalChars > 240) score -= 6;      // too long for a tweet
        }
        else if (platformKey === "instagram") {
            if (allHashtags.length >= 15) score += 5;
            if (totalChars < 150) score -= 5;
        }
        else if (platformKey === "tiktok") {
            if (/[ğŸ”¥âœ¨ğŸ’¥ğŸš€]/.test(text)) score += 4;
            if (totalWords < 25) score -= 8;
        }
        else if (platformKey === "linkedin") {
            score -= 10;                           // bring baseline down
            if (totalWords < 40) score -= 10;      // punish short/light posts
            if (isGenericIdea) score -= 12;
            if (tLower.includes("professional") && totalWords >= 60)
                score += 4;                        // reward real professional depth
        }

        // Clamp
        if (score < 10) score = 10;
        if (score > 90) score = 90;

        return Math.round(score);
    }


    function updateEngagementUI(score, boosted = false) {
      if (!engagementBox || !engagementValue) return;
      engagementBox.style.display = 'block';
      engagementValue.textContent = score;

      if (boosted) {
        engagementSub.textContent = "Boost applied. This version should perform better for saves, comments, and shares.";
      } else {
        engagementSub.textContent = "Higher scores usually mean more saves, comments, and shares.";
      }
    }

        function updateGenerateButtonState() {
      if (!generateBtn) return;
      if (isPro) {
        generateBtn.disabled = false;
        if (paywallEl) paywallEl.classList.add('hidden');
        updateFreeUsageBar();
        return;
      }
      if (freeUses >= MAX_FREE_USES) {
        generateBtn.disabled = true;
        if (currentTab === 'generateContent' && paywallEl) {
          paywallEl.classList.remove('hidden');
        }
      } else {
        generateBtn.disabled = false;
        if (paywallEl) paywallEl.classList.add('hidden');
      }
      updateFreeUsageBar();
    }


    function showTab(tabName) {
      currentTab = tabName;
      localStorage.setItem('lastTab', tabName);

      if (analysisResult) analysisResult.classList.add('hidden');
      if (loadingEl) loadingEl.classList.add('hidden');
      if (resultBox) resultBox.classList.add('hidden');

      if (tabName === 'generateContent') {
        generateContent.classList.remove('hidden');
        analyzeContent.classList.add('hidden');
        generateTabBtn.classList.add('active');
        analyzeTabBtn.classList.remove('active');
        if (analysisPaywall) analysisPaywall.classList.add('hidden');
        updateGenerateButtonState();
      } else {
        generateContent.classList.add('hidden');
        analyzeContent.classList.remove('hidden');
        generateTabBtn.classList.remove('active');
        analyzeTabBtn.classList.add('active');
        if (paywallEl) paywallEl.classList.add('hidden');

        if (!isPro) {
          if (analysisPaywall) analysisPaywall.classList.remove('hidden');
          if (analyzeForm) analyzeForm.classList.add('hidden');
        } else {
          if (analysisPaywall) analysisPaywall.classList.add('hidden');
          if (analyzeForm) analyzeForm.classList.remove('hidden');
        }
      }
    }

    function showPage(pageNumber) {
      if (!page1 || !page2 || !page1Btn || !page2Btn) return;
      if (pageNumber === 1) {
        page1.style.display = 'grid';
        page2.style.display = 'none';
        page1Btn.classList.add('active');
        page2Btn.classList.remove('active');
      } else {
        page1.style.display = 'none';
        page2.style.display = 'grid';
        page1Btn.classList.remove('active');
        page2Btn.classList.add('active');
      }
    }

    function processTemplateText(text) {
      const replacements = {
        'Camera Film': emojiMap['Camera'] + ' ' + emojiMap['Film'],
        'Coffee Mug Light Bulb': emojiMap['Coffee Mug'] + ' ' + emojiMap['Light Bulb'],
        'Question Mark Thinking Face': emojiMap['Question Mark'] + ' ' + emojiMap['Thinking Face'],
        'Bookmark Sparkles': emojiMap['Bookmark'] + ' ' + emojiMap['Sparkles'],
        'Gift Rocket': emojiMap['Gift'] + ' ' + emojiMap['Rocket'],
        'Hand Point Up Film': emojiMap['Hand Point Up'] + ' ' + emojiMap['Film'],
        'Star Speech Bubble': emojiMap['Star'] + ' ' + emojiMap['Speech Bubble'],
        'Money Bag Chart Increasing': emojiMap['Money Bag'] + ' ' + emojiMap['Chart Increasing'],
        'Crying Face Check Mark': emojiMap['Crying Face'] + ' ' + emojiMap['Check Mark'],
        'Thinking Face Light Bulb': emojiMap['Thinking Face'] + ' ' + emojiMap['Light Bulb'],
        'Toolbox Target': emojiMap['Toolbox'] + ' ' + emojiMap['Target'],
        'Speech Bubble Cross Mark': emojiMap['Speech Bubble'] + ' ' + emojiMap['Cross Mark'],
        'Link Bookmark': emojiMap['Link'] + ' ' + emojiMap['Bookmark'],
        'Smiling Face 100 Score': emojiMap['Smiling Face'] + ' ' + emojiMap['100 Score'],
        'User Rocket': emojiMap['User'] + ' ' + emojiMap['Rocket'],
        'Alarm Clock Flexed Biceps': emojiMap['Alarm Clock'] + ' ' + emojiMap['Flexed Biceps'],
        'Balance Scale Magnifying Glass': emojiMap['Balance Scale'] + ' ' + emojiMap['Magnifying Glass'],
        'Heart': emojiMap['Heart'],
        'Sparkles': emojiMap['Sparkles'],
        'Hand Point Down': emojiMap['Hand Point Down'],
        'Shopping Bag': emojiMap['Shopping Bag'],
        'Fire': emojiMap['Fire'],
        'Light Bulb': emojiMap['Light Bulb'],
        'Film': emojiMap['Film'],
        'Camera': emojiMap['Camera'],
        'Gift snake': emojiMap['Gift']
      };
      for (const key in replacements) {
        text = text.replace(new RegExp(key, 'g'), replacements[key]);
      }
      return text;
    }

    // --- Analyze tab helpers ---
    function detectPlatform(url) {
      const lower = url.toLowerCase();
      if (lower.includes('instagram.com')) return 'Instagram';
      if (lower.includes('twitter.com') || lower.includes('x.com')) return 'Twitter';
      if (lower.includes('linkedin.com')) return 'LinkedIn';
      if (lower.includes('tiktok.com')) return 'TikTok';
      return 'Instagram';
    }

    function generateDeterministicScore(url) {
      const seed = hashString((url || '').toLowerCase().trim());
      const score = (seed % 35) + 65; // 65â€“99
      const quality = score > 90 ? 'High' : score > 80 ? 'Medium' : 'Low';

      let hook, readability, hashtags, cta;
      if (quality === 'High') {
        hook = 'High urgency, clear value proposition. ğŸ”¥';
        readability = 'Excellent use of line breaks. âœ…';
        hashtags = 'Highly relevant, 90% niche-specific. ğŸ¯';
        cta = 'Clear call-to-action to save and comment. ğŸ’¬';
      } else if (quality === 'Medium') {
        hook = 'Decent hook, could be more specific and engaging. ğŸ‘';
        readability = 'Good structure, but a few dense blocks. âš ï¸';
        hashtags = 'Mix of niche and broad tags (50/50). ğŸ’¡';
        cta = 'General CTA, needs more direction. â“';
      } else {
        hook = 'Vague hook, lacks clear value proposition. ğŸ‘';
        readability = 'Dense wall of text, poor line breaks. âŒ';
        hashtags = 'Too generic, mostly broad tags. ğŸ’¡';
        cta = 'No clear CTA, relying on passive engagement. â“';
      }
      return { score, hook, readability, hashtags, cta };
    }

    // --- Try generate captions ---
    async function tryGenerate(forceFull = false) {
      if (isGenerating || !userEmail || !ideaInput || !platformSel || !toneSel) return;

      const idea = ideaInput.value.trim();
      const platform = platformSel.value;
      const tone = toneSel.value;

      if (!idea || !platform || !tone) {
        if (resultBox) resultBox.classList.add('hidden');
        if (paywallEl) paywallEl.classList.add('hidden');
        return;
      }

      if (!isPro && freeUses >= MAX_FREE_USES) {
        if (paywallEl) paywallEl.classList.remove('hidden');
        if (resultBox) resultBox.classList.add('hidden');
        return;
      }

      isGenerating = true;
      hasBoostedCurrentOutput = false;
      lastResultText = '';
      lastScore = null;
      lastIdea = idea;
      lastPlatform = platform;
      lastTone = tone;

      if (engagementBox) engagementBox.style.display = 'none';
      if (boostBtn) {
        boostBtn.disabled = false;
        boostBtn.classList.remove('used');
        boostBtn.textContent = 'Boost My Score';
      }

      if (loadingEl) loadingEl.classList.remove('hidden');
      if (resultBox) resultBox.classList.add('hidden');
      if (paywallEl) paywallEl.classList.add('hidden');
      if (generateBtn) {
        generateBtn.disabled = true;
        generateBtn.textContent = 'Generating...';
      }

      try {
        const res = await fetch(`${API_URL}/generate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ idea, platform, tone, email: userEmail })
        });

        const data = await res.json();

        if (res.status === 402) {
          if (paywallEl) paywallEl.classList.remove('hidden');
          if (resultBox) resultBox.classList.add('hidden');
        } else if (res.ok && data.result) {
          lastResultText = data.result;
          if (outputEl) outputEl.textContent = data.result;
          if (resultBox) resultBox.classList.remove('hidden');
          if (paywallEl) paywallEl.classList.add('hidden');

          if (copyBtn) {
            copyBtn.classList.remove('copied');
            copyBtn.textContent = 'Copy All';
          }

          // Engagement score
          const score = computeEngagementScore(data.result, idea, platform, tone);
          lastScore = score;
          updateEngagementUI(score, false);

          if (!isPro) {
            freeUses++;
            localStorage.setItem('freeUses', String(freeUses));
            updateFreeUsageBar();
          }
        }
      } catch (err) {
        console.error('Generate error:', err);
        if (forceFull) {
          const fallback = `## Captions
1. "Just launched my coffee shop! ${emojiMap['Coffee']}${emojiMap['Sparkles']}"
2. "Fresh brews, cozy vibes ${emojiMap['Coffee']}${emojiMap['Heart']}"
3. "Your new favorite morning spot!"
4. "Handcrafted with love ${emojiMap['Leaf']}"
5. "Come say hi! ${emojiMap['Hand Wave']}"

## Hashtags
#CoffeeShop #NewBusiness #SmallBiz #CoffeeLovers #LocalCafe #SupportLocal #MorningVibes #CoffeeTime #CafeLife #Entrepreneur #ShopSmall #CoffeeAddict #LatteArt #BrewedFresh #CozyCorner #CoffeeCommunity #SmallBusinessOwner #CoffeeCulture #DailyGrind #CafeVibes #CoffeeBreak #Handcrafted #WomenInBusiness #CoffeeLover #BaristaLife #CoffeeGram #InstaCoffee #CoffeeOfTheDay #CoffeeShopVibes #NewCafe`;
          lastResultText = fallback;
          if (outputEl) outputEl.textContent = fallback;
          if (resultBox) resultBox.classList.remove('hidden');

          const score = computeEngagementScore(fallback, idea, platform, tone);
          lastScore = score;
          updateEngagementUI(score, false);

          if (!isPro) {
            freeUses++;
            localStorage.setItem('freeUses', String(freeUses));
            updateFreeUsageBar();
          }
        }
      } finally {
        if (loadingEl) loadingEl.classList.add('hidden');
        if (generateBtn) {
          generateBtn.disabled = false;
          generateBtn.textContent = 'Generate Captions';
        }
        isGenerating = false;
        updateGenerateButtonState();
      }
    }

    // --- Boost logic (one-time per generation, never decreases score) ---
        async function tryBoost() {
        if (hasBoostedCurrentOutput) return;
        if (!lastResultText || !lastIdea || !lastPlatform || !lastTone) return;
    
        if (!isPro && freeUses >= MAX_FREE_USES) {
            if (paywallEl) paywallEl.classList.remove("hidden");
            return;
        }
    
        boostBtn.disabled = true;
        boostBtn.textContent = "Boosting...";
    
        try {
            const res = await fetch(`${API_URL}/optimize`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    idea: lastIdea,
                    platform: lastPlatform,
                    tone: lastTone,
                    email: userEmail,
                    captions: lastResultText,
                    previousScore: lastScore
                })
            });
    
            const data = await res.json();
    
            if (res.status === 402) {
                if (paywallEl) paywallEl.classList.remove("hidden");
                boostBtn.disabled = false;
                boostBtn.textContent = "Boost My Score";
                return;
            }
    
            if (res.ok && data.result) {
                lastResultText = data.result;
                outputEl.textContent = data.result;
    
                let boostedScore = computeEngagementScore(
                    data.result,
                    lastIdea,
                    lastPlatform,
                    lastTone
                );
    
                let original = lastScore || 0;
    
                // Option A: medium but meaningful bump
                let minBoost = 10;
                if (original < 40) minBoost = 15;
                if (original < 30) minBoost = 18;
    
                let maxBoost = minBoost + 10; // e.g. +18 to +28
    
                const seed = hashString(data.result.slice(0, 150) + "|boostA");
                const bump = Math.round(seededRandom(seed, minBoost, maxBoost));
                boostedScore = original + bump;
    
                const caps = {
                    twitter: 85,
                    linkedin: 88,
                    instagram: 92,
                    tiktok: 95
                };
                const cap = caps[lastPlatform.toLowerCase()] || 90;
                boostedScore = Math.min(boostedScore, cap);
    
                lastScore = boostedScore;
                updateEngagementUI(boostedScore, true);
            }
    
            if (!isPro) {
                freeUses++;
                localStorage.setItem("freeUses", String(freeUses));
                updateFreeUsageBar();
            }
        } catch (err) {
            console.error("Boost error:", err);
        } finally {
            hasBoostedCurrentOutput = true;
            boostBtn.disabled = true;
            boostBtn.classList.add("used");
            boostBtn.textContent = "Boost Applied";
            updateGenerateButtonState();
        }
    }

    // --- Analyze form submit ---
    if (analyzeForm && competitorUrlInput) {
      analyzeForm.addEventListener('submit', (e) => {
        e.preventDefault();
        if (!isPro) return;

        if (loadingEl) loadingEl.classList.remove('hidden');
        if (analysisResult) analysisResult.classList.add('hidden');

        const url = competitorUrlInput.value.trim();
        const platform = detectPlatform(url);

        setTimeout(() => {
          if (loadingEl) loadingEl.classList.add('hidden');

          const analysisData = generateDeterministicScore(url);
          const scoreEl = document.getElementById('analysisScore');
          const detailEl = document.getElementById('analysisDetails');
          if (scoreEl && detailEl) {
            scoreEl.textContent = analysisData.score;
            detailEl.innerHTML = `
              <p><strong>Platform Detected:</strong> ${platform}</p>
              <p><strong>Hook Score:</strong> ${analysisData.hook}</p>
              <p><strong>Readability:</strong> ${analysisData.readability}</p>
              <p><strong>Hashtags:</strong> ${analysisData.hashtags}</p>
              <p><strong>Core CTA:</strong> ${analysisData.cta}</p>
            `;
          }
          if (analysisResult) analysisResult.classList.remove('hidden');
        }, 1500);
      });
    }

    if (analyzeAgainBtn && competitorUrlInput && analysisResult) {
      analyzeAgainBtn.addEventListener('click', () => {
        competitorUrlInput.value = '';
        analysisResult.classList.add('hidden');
        competitorUrlInput.focus();
        const analysisDetails = document.getElementById('analysisDetails');
        if (analysisDetails) analysisDetails.innerHTML = '';
      });
    }

    // --- Copy button ---
    if (copyBtn && outputEl) {
      copyBtn.addEventListener('click', () => {
        navigator.clipboard.writeText(outputEl.textContent || '').then(() => {
          copyBtn.textContent = 'Copied!';
          copyBtn.classList.add('copied');
          setTimeout(() => {
            copyBtn.textContent = 'Copy All';
            copyBtn.classList.remove('copied');
          }, 2000);
        });
      });
    }

    // --- Emoji picker ---
    if (emojiGrid && ideaInput) {
      const commonEmojis = Object.keys(emojiMap).filter(k => !['Coffee Mug', 'Hand Wave'].includes(k));
      emojiGrid.innerHTML = '';
      commonEmojis.forEach(name => {
        const btn = document.createElement('button');
        btn.textContent = emojiMap[name];
        btn.title = name;
        btn.addEventListener('click', () => {
          ideaInput.value += ' ' + emojiMap[name];
          ideaInput.focus();
        });
        emojiGrid.appendChild(btn);
      });
    }

    if (emojiPickerBtn && picker) {
      emojiPickerBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        picker.style.display = picker.style.display === 'flex' ? 'none' : 'flex';
      });
    }
    if (closePicker && picker) {
      closePicker.addEventListener('click', () => picker.style.display = 'none');
    }
    document.addEventListener('click', (e) => {
      if (picker && emojiPickerBtn && !picker.contains(e.target) && e.target !== emojiPickerBtn) {
        picker.style.display = 'none';
      }
    });

    // --- Input auto-generate debounce ---
    const inputs = ['idea', 'platform', 'tone'];
    inputs.forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        el.addEventListener('input', () => {
          clearTimeout(debounceTimer);
          debounceTimer = setTimeout(() => tryGenerate(false), 900);
        });
      }
    });

    // --- Form submit (manual generate) ---
    const captionForm = document.getElementById('captionForm');
    if (captionForm) {
      captionForm.addEventListener('submit', (e) => {
        e.preventDefault();
        clearTimeout(debounceTimer);
        tryGenerate(true);
      });
    }

    // --- Tabs ---
    if (generateTabBtn) generateTabBtn.addEventListener('click', () => showTab('generateContent'));
    if (analyzeTabBtn) analyzeTabBtn.addEventListener('click', () => showTab('analyzeContent'));

    // --- Boost button ---
    if (boostBtn) {
      boostBtn.addEventListener('click', (e) => {
        e.preventDefault();
        tryBoost();
      });
    }

    // --- Templates: show/hide & pagination ---
    if (isPro) {
      if (templateContainer) {
        templateContainer.classList.remove('hidden');
        templateContainer.style.display = 'grid';
      }
      if (templateTeaser) templateTeaser.style.display = 'none';
      showPage(1);
    } else {
      if (templateContainer) {
        templateContainer.classList.add('hidden');
        templateContainer.style.display = 'none';
      }
      if (templateTeaser) templateTeaser.style.display = 'block';
    }

    if (page1Btn) page1Btn.addEventListener('click', () => showPage(1));
    if (page2Btn) page2Btn.addEventListener('click', () => showPage(2));

    document.querySelectorAll('.templateBtn').forEach(btn => {
      const raw = btn.getAttribute('data-text') || '';
      const renderedText = processTemplateText(raw);
      btn.addEventListener('click', () => {
        if (ideaInput) ideaInput.value = renderedText;
        if (ideaInput) ideaInput.focus();
        showTab('generateContent');
      });
    });

    if (unlockTemplatesBtn && paywallEl) {
      unlockTemplatesBtn.addEventListener('click', () => {
        paywallEl.classList.remove('hidden');
        paywallEl.scrollIntoView({ behavior: 'smooth' });
      });
    }

    // --- Stripe subscribe buttons ---
    if (subscribeAnalyzeBtn && subscribeBtn) {
      subscribeAnalyzeBtn.addEventListener('click', () => {
        subscribeBtn.click();
      });
    }

    if (subscribeBtn) {
      subscribeBtn.addEventListener('click', async () => {
        try {
          const res = await fetch(`${API_URL}/create-checkout-session`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: userEmail, referralCode: localStorage.getItem('referralCode') || '' })
          });
          const data = await res.json();
          if (data && data.url) {
            window.location.href = data.url;
          } else {
            alert('Checkout failed. Please try again.');
          }
        } catch (err) {
          alert('Checkout failed. Please try again.');
        }
      });
    }

    // --- Daily tip ---
    if (tipElement) tipElement.textContent = getTodayTip();

    // --- Handle Stripe success ?success=true ---
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('success') === 'true') {
      localStorage.setItem('isPro', 'true');
      isPro = true;
      window.history.replaceState({}, document.title, window.location.pathname);
      alert('Welcome to Pro! Unlimited generations, Boost, Templates, and Analyzer unlocked.');
    
  // Refresh template state immediately
  try {
    if (typeof templateContainer !== 'undefined' && templateContainer) {
      templateContainer.classList.remove('hidden');
      templateContainer.style.display = 'grid';
    }
    if (typeof templateTeaser !== 'undefined' && templateTeaser) {
      templateTeaser.style.display = 'none';
    }
    if (typeof showPage !== 'undefined') showPage(1);
  } catch(e) { console.error(e); }
}

    // --- Email gate bootstrap ---
    if (!userEmail) {
      emailSubmit.addEventListener('click', () => {
        const email = (emailInput.value || '').trim();
        if (email && /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
          localStorage.setItem('userEmail', email);
          localStorage.setItem('freeUses', '0');
          modal.style.display = 'none';
          mainApp.style.display = 'block';
          userEmail = email;
          hydrateProFromServer();
          updateGenerateButtonState();
          showTab(currentTab);
        } else {
          emailInput.style.borderColor = '#ef4444';
          emailInput.focus();
        }
      });
    } else {
      modal.style.display = 'none';
      mainApp.style.display = 'block';
      hydrateProFromServer();
    }

    // Initial UI sync
    refreshProUI();
    updateGenerateButtonState();
    showTab(currentTab);
  });
  
</script>

<div id="toast" class="toast hidden"></div>

<script>
async function hydrateSubscriptionState(email) {
  try {
    const resp = await fetch(`${API_URL}/check-subscription?email=${encodeURIComponent(email)}`);
    const data = await resp.json();
    const isPro = !!data.isPro;
    const isVip = !!data.vip;
    localStorage.setItem('isPro', isPro ? 'true' : 'false');
    localStorage.setItem('isVip', isVip ? 'true' : 'false');
    window.__isPro = isPro;
    window.__isVip = isVip;
    return {isPro, isVip};
  } catch(e) {
    console.error('hydrate error', e);
    return {isPro:false, isVip:false};
  }
}
document.addEventListener('DOMContentLoaded', async ()=>{
  const email = localStorage.getItem('userEmail');
  if(email){
    await hydrateSubscriptionState(email);
  }
});

// === AFFILIATE PROGRAM LOGIC ===
async function becomeAffiliate() {
    const email = localStorage.getItem('userEmail');
    if (!email) { alert("Email missing."); return; }
    try {
        const res = await fetch(`${API_URL}/create-connect-account`, {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({ email })
        });
        const data = await res.json();
        if (data.error) { alert(data.error); return; }
        localStorage.setItem("connectAccountId", data.connectAccountId);
        window.location.href = data.onboardingUrl;
    } catch (e) { console.error(e); alert("Failed to setup affiliate."); }
}

async function getReferralLink() {
    const affiliateId = localStorage.getItem("connectAccountId");
    if (!affiliateId) { alert("No affiliate account. Become affiliate first."); return; }
    try {
        const res = await fetch(`${API_URL}/referral-link?referralCode=${affiliateId}`);
        const data = await res.json();
        if (data.error) { alert(data.error); return; }
        document.getElementById("affiliateLink").value = data.referralUrl;
        document.getElementById("affiliateLinkContainer").style.display = "block";
    } catch (e) { console.error(e); alert("Error retrieving referral link."); }
}

document.addEventListener('DOMContentLoaded', ()=>{
    const b=document.getElementById("becomeAffiliateBtn");
    const g=document.getElementById("getReferralLinkBtn");
    const c=document.getElementById("copyReferralBtn");
    if(b) b.addEventListener("click", becomeAffiliate);
    if(g) g.addEventListener("click", getReferralLink);
    if(c) c.addEventListener("click", ()=> {
        const inp=document.getElementById("affiliateLink");
        inp.select();
        document.execCommand("copy");
        alert("Copied!");
    });
});

</script>

</body>
</html>
