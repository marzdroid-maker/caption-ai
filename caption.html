<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI Caption + Hashtag Generator</title>
  <style>
    :root {
      --primary: #3b82f6;
      --primary-dark: #2563eb;
      --gray: #6b7280;
      --light: #f3f4f6;
      --border: #e5e7eb;
      --placeholder: #9ca3af;
      --success: #10b981;
      --success-dark: #059669;
      --error: #ef4444;
      --warning: #f59e0b;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      color: #111;
      min-height: 100vh;
      padding: 2rem 1rem;
    }
    .container { max-width: 600px; margin: 0 auto; }
    h1 { font-size: 2.25rem; font-weight: 700; text-align: center; margin-bottom: .5rem; }
    p.subtitle { text-align: center; color: var(--gray); margin-bottom: 1.5rem; font-size: 1.1rem; }

    /* Social Proof */
    .proof {
      background: #ecfdf5;
      border: 1px solid #a7f3d0;
      padding: 1rem;
      border-radius: .75rem;
      text-align: center;
      margin-bottom: 1.5rem;
      font-size: .95rem;
      color: #065f46;
    }
    .proof strong { font-weight: 600; }

    /* Email Modal */
    #emailModal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.7); display: flex; align-items: center;
      justify-content: center; z-index: 9999;
    }
    .modal-content {
      background: white; padding: 2rem; border-radius: 1rem;
      width: 90%; max-width: 400px; text-align: center;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }
    .modal-content h2 { margin-bottom: 1rem; font-size: 1.5rem; }
    .modal-content p { margin-bottom: 1.5rem; color: #555; }
    .modal-content input {
      width: 100%; padding: .75rem; border: 2px solid #e5e7eb;
      border-radius: .5rem; font-size: 1rem; margin-bottom: 1rem;
    }
    .modal-content button {
      background: var(--primary); color: white; border: none;
      padding: .75rem 1.5rem; border-radius: .5rem; font-weight: 600;
      cursor: pointer; width: 100%;
    }

    /* Form */
    label { display: block; margin-bottom: .5rem; font-weight: 600; color: #111; }
    input, select {
      width: 100%; padding: .75rem 1rem; border: 2px solid var(--border);
      border-radius: .5rem; font-size: 1rem; margin-bottom: 1rem;
      transition: border .2s;
    }
    input:focus, select:focus { outline: none; border-color: var(--primary); }
    input::placeholder { color: var(--placeholder); font-style: italic; }

    /* Dropdown placeholder */
    select option[disabled] { display: none; }
    select option[data-placeholder] { color: var(--placeholder); font-style: italic; }
    select:invalid { color: var(--placeholder); }
    select:valid { color: #111; }

    button {
      width: 100%; background: var(--primary); color: white; border: none;
      padding: 1rem; font-size: 1.1rem; font-weight: 600; border-radius: .5rem;
      cursor: pointer; transition: background .2s;
    }
    button:hover { background: var(--primary-dark); }
    button:disabled { background: #93c5fd; cursor: not-allowed; }

    /* Emoji Picker Button */
    #emojiPickerBtn {
      background: var(--warning); margin: 1rem 0; width: auto; padding: .5rem 1rem; font-size: .9rem;
    }

    /* Emoji Picker Popup - MODIFIED FOR POSITIONING */
    #emojiPicker {
      display: none; 
      position: absolute; 
      background: white; 
      border: 1px solid #e5e7eb;
      border-radius: .75rem; 
      padding: 1rem; 
      max-width: 300px; 
      box-shadow: 0 10px 25px rgba(0,0,0,0.15);
      z-index: 100; 
      text-align: center;
      max-height: 350px; 
      flex-direction: column;
      /* Default position set to top-right corner of the button's parent container */
      right: 0; 
      top: 100%; 
      transform: translateY(5px);
    }

    #emojiGrid {
      display: grid; grid-template-columns: repeat(6, 1fr); gap: .5rem; font-size: 1.5rem;
      margin: .75rem 0;
      overflow-y: auto; 
      padding-right: 5px; 
    }
    #emojiGrid button {
      background: none; border: none; font-size: 1.5rem; cursor: pointer; padding: 0;
    }
    #closePicker {
      margin-top: .5rem; background: #6b7280; color: white; padding: .5rem 1rem;
      border-radius: .5rem; font-size: .8rem; width: auto;
    }

    /* Re-styled parent container for positioning the picker relative to the button */
    .emoji-picker-container {
        position: relative; 
        text-align: left; /* Aligns the button to the left/center */
        display: flex;
        justify-content: center;
    }
    
    .result {
      margin-top: 2rem; padding: 1.5rem; background: white; border-radius: .75rem;
      box-shadow: 0 4px 12px rgba(0,0,0,.05); position: relative;
    }
    .result h3 { margin-bottom: .75rem; color: var(--primary); }
    .result pre {
      white-space: pre-wrap; font-family: inherit; line-height: 1.6; margin-bottom: 1rem;
    }
    #copyBtn {
      position: absolute; top: 1rem; right: 1rem; background: var(--success);
      color: white; padding: .5rem 1rem; border: none; border-radius: .5rem;
      font-size: .9rem; cursor: pointer; transition: background .2s;
    }
    #copyBtn:hover { background: var(--success-dark); }
    #copyBtn.copied { background: #059669; }

    /* History section removed */

    /* Pro Templates */
    #proTemplates {
      margin-top: 2rem; padding: 1.5rem; background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: .75rem;
    }
    .templateBtn {
      text-align: left; padding: .75rem; background: white; border: 1px solid #d1d5db;
      border-radius: .5rem; font-size: .9rem; margin-bottom: .5rem; cursor: pointer;
    }
    .templateBtn:hover { background: #f9fafb; }

    .paywall {
      margin-top: 2rem; padding: 2rem; background: #fefce8; border-radius: .75rem;
      text-align: center; border: 2px solid #fde68a;
    }
    .paywall h3 { margin-bottom: .5rem; font-size: 1.5rem; }
    .paywall p { color: #92400e; margin-bottom: 1rem; }
    .paywall button {
      background: #16a34a; padding: .75rem 1.5rem; font-size: 1rem;
      width: auto; display: inline-block;
    }
    .paywall button:hover { background: #15803d; }

    .hidden { display: none; }
    .loading { text-align: center; margin: 1rem 0; color: var(--gray); font-style: italic; }

    footer {
      margin-top: 3rem; text-align: center; color: #6b7280; font-size: 0.875rem;
    }
    footer a { color: inherit; margin: 0 1rem; text-decoration: underline; }

    @media (max-width: 480px) {
      h1 { font-size: 1.75rem; }
      .container { padding: 0 1rem; }
      #copyBtn { position: static; margin-top: 1rem; width: 100%; }
      #emojiGrid { grid-template-columns: repeat(5, 1fr); }
      #emojiPicker { 
        right: auto;
        left: 50%;
        transform: translateX(-50%) translateY(5px);
      }
    }
  </style>
</head>
<body>

  <div id="emailModal">
    <div class="modal-content">
      <h2>Welcome!</h2>
      <p>Enter your email to get <strong>3 free generations</strong>.</p>
      <input type="email" id="emailInput" placeholder="you@example.com" required />
      <button id="emailSubmit">Start Generating</button>
    </div>
  </div>

  <div class="container" id="mainApp" style="display: none;">
    <h1>AI Caption + Hashtag Generator</h1>
    <p class="subtitle">Get 5 viral captions + 30 hashtags in 3 seconds.</p>

    <div class="proof">
      <strong>Trusted by 50+ creators, solopreneurs, and small businesses</strong>
    </div>

    <form id="captionForm">
      <label for="idea">Post Idea</label>
      <input type="text" id="idea" placeholder="e.g. Just launched my coffee shop" required />

      <label for="platform">Platform</label>
      <select id="platform" required>
        <option value="" disabled selected data-placeholder>Choose platform</option>
        <option value="Instagram">Instagram</option>
        <option value="Twitter">Twitter</option>
        <option value="LinkedIn">LinkedIn</option>
        <option value="TikTok">TikTok</option>
      </select>

      <label for="tone">Tone</label>
      <select id="tone" required>
        <option value="" disabled selected data-placeholder>Choose tone</option>
        <option value="Professional">Professional</option>
        <option value="Fun & Playful">Fun & Playful</option>
        <option value="Inspirational">Inspirational</option>
        <option value="Bold & Confident">Bold & Confident</option>
        <option value="Casual & Friendly">Casual & Friendly</option>
      </select>

      <div class="emoji-picker-container"> 
        <button type="button" id="emojiPickerBtn">Add Emojis</button>
        <div id="emojiPicker">
          <p style="margin-bottom: .75rem; font-weight: 600;">Pick Emojis</p>
          <div id="emojiGrid"></div>
          <button id="closePicker">Close</button>
        </div>
      </div>

      <button type="submit" id="generateBtn">Generate Captions</button>
    </form>

    <div id="loading" class="loading hidden">Generating magic...</div>

    <div id="result" class="result hidden">
      <h3>Your AI Captions</h3>
      <pre id="output"></pre>
      <button type="button" id="copyBtn">Copy All</button>
    </div>

    <div id="proTemplates" class="hidden">
      <h3>Pro Templates (Click to Use)</h3>
      <div style="display: grid; gap: .5rem; font-size: .9rem;">
        <button class="templateBtn">"Just hit 10K followers! Grateful for every one of you Heart"</button>
        <button class="templateBtn">"Behind the scenes of [your idea] Camera Film"</button>
        <button class="templateBtn">"Tag a friend who needs this! Hand Point Down"</button>
        <button class="templateBtn">"New drop alert! Link in bio Shopping Bag"</button>
        <button class="templateBtn">"Your daily dose of [topic] Coffee Mug"</button>
      </div>
    </div>

    <div id="paywall" class="paywall hidden">
      <h3>Upgrade to Pro!</h3>
      <p>Unlimited generations + Pro Templates for <strong>$7/month</strong>.</p>
      <button id="subscribeBtn">Subscribe Now</button>
    </div>

    <footer>
      <a href="/terms.html">Terms</a>
      <a href="/privacy.html">Privacy</a>
      <span>Â© 2025 Caption AI</span>
    </footer>
  </div>

  <script>
    const API_URL = 'https://caption-ai-ze13.onrender.com';
    const modal = document.getElementById('emailModal');
    const mainApp = document.getElementById('mainApp');
    const emailInput = document.getElementById('emailInput');
    const emailSubmit = document.getElementById('emailSubmit');

    let userEmail = localStorage.getItem('userEmail');

    // === EMOJI MAPPING ===
    const emojiMap = {
      'Camera': 'ðŸ“¸', 'Heart': 'â¤ï¸', 'Sparkles': 'âœ¨', 'Coffee': 'â˜•', 'Shopping Bag': 'ðŸ›ï¸',
      'Rocket': 'ðŸš€', 'Fire': 'ðŸ”¥', 'Trophy': 'ðŸ†', 'Briefcase': 'ðŸ’¼', 'Handshake': 'ðŸ¤',
      'Laptop': 'ðŸ’»', 'Sunrise': 'ðŸŒ…', 'Moon': 'ðŸŒ™', 'Pizza': 'ðŸ•', 'Leaf': 'ðŸƒ',
      'Flexed Biceps': 'ðŸ’ª', 'Airplane': 'âœˆï¸', 'Book': 'ðŸ“š', 'Dog': 'ðŸ¶', 'Cat': 'ðŸ±',
      'Birthday Cake': 'ðŸŽ‚', 'Party Popper': 'ðŸŽ‰', 'Star': 'â­', 'Film': 'ðŸŽ¬',
      'Musical Notes': 'ðŸŽ¶', 'Dancer': 'ðŸ’ƒ', 'Play Button': 'â–¶ï¸', 'New': 'ðŸ†•', 'Sale': 'ðŸ·ï¸',
      'Check Mark': 'âœ…', 'Cross Mark': 'âŒ', 'Hand Point Down': 'ðŸ‘‡', 'Coffee Mug': 'â˜•', 'Hand Wave': 'ðŸ‘‹',
      'Light Bulb': 'ðŸ’¡', 'Thinking Face': 'ðŸ¤”', '100 Score': 'ðŸ’¯', 'Money Bag': 'ðŸ’°',
      'Chart Increasing': 'ðŸ“ˆ', 'Target': 'ðŸŽ¯', 'Alarm Clock': 'â°', 'Question Mark': 'â“',
      'Speech Bubble': 'ðŸ’¬', 'Crown': 'ðŸ‘‘', 'Diamond': 'ðŸ’Ž', 'Robot': 'ðŸ¤–',
      'Globe': 'ðŸŒ', 'Mountain': 'â›°ï¸', 'Pin': 'ðŸ“Œ', 'Megaphone': 'ðŸ“£',
      'Writing Hand': 'âœï¸', 'Open Book': 'ðŸ“–', 'Smiling Face': 'ðŸ˜Š', 'Crying Face': 'ðŸ˜¢',
      'Clapping Hands': 'ðŸ‘', 'Winking Face': 'ðŸ˜‰', 'Red Apple': 'ðŸŽ', 'Grapes': 'ðŸ‡',
      'Donut': 'ðŸ©', 'Taco': 'ðŸŒ®', 'Beer Mug': 'ðŸº', 'Martini Glass': 'ðŸ¸',
      'Car': 'ðŸš—', 'Bicycle': 'ðŸš²', 'Train': 'ðŸš†', 'Boat': 'â›µ',
      'Fingers Crossed': 'ðŸ¤ž', 'Poo': 'ðŸ’©', 'Ghost': 'ðŸ‘»', 'Alien': 'ðŸ‘½',
      'Lock': 'ðŸ”’', 'Key': 'ðŸ”‘', 'Toolbox': 'ðŸ§°', 'Graduation Cap': 'ðŸŽ“'
    };
    
    const commonEmojis = Object.keys(emojiMap).filter(name => name !== 'Coffee Mug' && name !== 'Hand Wave' && name !== 'Camera Film' && name !== 'Hand Point Down');

    // === EMAIL MODAL ===
    if (!userEmail) {
      modal.style.display = 'flex'; 
      mainApp.style.display = 'none'; 
      emailSubmit.addEventListener('click', () => {
        const email = emailInput.value.trim();
        if (email && /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
          localStorage.setItem('userEmail', email);
          modal.style.display = 'none';
          mainApp.style.display = 'block';
          userEmail = email;
          initApp();
        } else {
          emailInput.style.borderColor = '#ef4444';
          emailInput.focus();
        }
      });
    } else {
      modal.style.display = 'none';
      mainApp.style.display = 'block';
      initApp();
    }

    function initApp() {
      const form = document.getElementById('captionForm');
      const generateBtn = document.getElementById('generateBtn');
      const loading = document.getElementById('loading');
      const result = document.getElementById('result');
      const output = document.getElementById('output');
      const paywall = document.getElementById('paywall');
      const subscribeBtn = document.getElementById('subscribeBtn');
      const copyBtn = document.getElementById('copyBtn');
      const picker = document.getElementById('emojiPicker');

      let debounceTimer;
      let isGenerating = false;

      // === REAL EMOJI PICKER ===
      const emojiBtn = document.getElementById('emojiPickerBtn');
      const grid = document.getElementById('emojiGrid');
      const closePicker = document.getElementById('closePicker');

      grid.innerHTML = ''; 

      commonEmojis.forEach(name => {
        const emoji = emojiMap[name]; 
        const btn = document.createElement('button');
        btn.textContent = emoji; 
        btn.style.background = 'none';
        btn.style.border = 'none';
        btn.style.fontSize = '1.5rem';
        btn.style.cursor = 'pointer';
        btn.style.padding = '0';
        btn.title = name; 
        btn.addEventListener('click', () => {
          const idea = document.getElementById('idea');
          idea.value = idea.value.trim() + ' ' + emoji;
          idea.focus();
        });
        grid.appendChild(btn);
      });

      emojiBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        picker.style.display = 'flex'; 
      });

      closePicker.addEventListener('click', () => {
        picker.style.display = 'none';
      });

      document.addEventListener('click', (e) => {
        if (!picker.contains(e.target) && e.target !== emojiBtn) {
          picker.style.display = 'none';
        }
      });

      // Mobile: Use native emoji keyboard
      if (/Mobi|Android/i.test(navigator.userAgent)) {
        emojiBtn.addEventListener('click', (e) => {
          e.preventDefault();
          const idea = document.getElementById('idea');
          idea.focus();
          alert('Tap the emoji key on your keyboard!');
        });
      }

      // === LIVE GENERATION ===
      const inputs = ['idea', 'platform', 'tone'];
      inputs.forEach(id => {
        document.getElementById(id).addEventListener('input', () => {
          clearTimeout(debounceTimer);
          debounceTimer = setTimeout(tryGenerate, 800);
        });
      });

      form.addEventListener('submit', (e) => {
        e.preventDefault();
        clearTimeout(debounceTimer);
        tryGenerate(true);
      });

      async function tryGenerate(forceFull = false) {
        if (isGenerating || !userEmail) return;

        const idea = document.getElementById('idea').value.trim();
        const platform = document.getElementById('platform').value;
        const tone = document.getElementById('tone').value;

        if (!idea || !platform || !tone) {
          result.classList.add('hidden');
          paywall.classList.add('hidden');
          return;
        }

        isGenerating = true;
        loading.classList.remove('hidden');
        result.classList.add('hidden');
        paywall.classList.add('hidden');
        generateBtn.disabled = true;
        generateBtn.textContent = 'Generating...';

        try {
          const res = await fetch(`${API_URL}/generate`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ idea, platform, tone, email: userEmail })
          });

          const data = await res.json();

          if (res.status === 402) {
            paywall.classList.remove('hidden');
            result.classList.add('hidden');
          } else if (res.ok) {
            output.textContent = data.result;
            result.classList.remove('hidden');
            paywall.classList.add('hidden');
            copyBtn.classList.remove('copied');
            copyBtn.textContent = 'Copy All';
            // Removed saveToHistory() call
          }
        } catch (err) {
          if (forceFull) {
            const fallback = `## Captions\n1. "Just launched my coffee shop! ${emojiMap['Coffee']}${emojiMap['Sparkles']}"\n2. "Fresh brews, cozy vibes ${emojiMap['Coffee']}${emojiMap['Heart']}"\n3. "Your new favorite morning spot!"\n4. "Handcrafted with love ${emojiMap['Leaf']}"\n5. "Come say hi! ${emojiMap['Hand Wave']}"\n\n## Hashtags\n#CoffeeShop #NewBusiness #SmallBiz #CoffeeLovers #LocalCafe #SupportLocal #MorningVibes #CoffeeTime #CafeLife #Entrepreneur #ShopSmall #CoffeeAddict #LatteArt #BrewedFresh #CozyCorner #CoffeeCommunity #SmallBusinessOwner #CoffeeCulture #DailyGrind #CafeVibes #CoffeeBreak #Handcrafted #WomenInBusiness #CoffeeLover #BaristaLife #CoffeeGram #InstaCoffee #CoffeeOfTheDay #CoffeeShopVibes #NewCafe`;
            output.textContent = fallback;
            result.classList.remove('hidden');
            // Removed saveToHistory() call
          }
        } finally {
          loading.classList.add('hidden');
          generateBtn.disabled = false;
          generateBtn.textContent = 'Generate Captions';
          isGenerating = false;
        }
      }

      // === COPY ALL ===
      copyBtn.addEventListener('click', () => {
        navigator.clipboard.writeText(output.textContent).then(() => {
          copyBtn.textContent = 'Copied!';
          copyBtn.classList.add('copied');
          setTimeout(() => {
            copyBtn.textContent = 'Copy All';
            copyBtn.classList.remove('copied');
          }, 2000);
        });
      });

      // === SAVE & HISTORY - ALL REMOVED ===
      
      // === PRO TEMPLATES ===
      document.querySelectorAll('.templateBtn').forEach(btn => {
        const originalText = btn.textContent;
        
        let displayText = originalText
          .replace('Heart', emojiMap['Heart'])
          .replace('Camera Film', emojiMap['Camera'] + emojiMap['Film'])
          .replace('Hand Point Down', emojiMap['Hand Point Down'])
          .replace('Shopping Bag', emojiMap['Shopping Bag'])
          .replace('Coffee Mug', emojiMap['Coffee']);

        btn.innerHTML = displayText; 

        btn.addEventListener('click', () => {
          document.getElementById('idea').value = displayText;
          document.getElementById('idea').focus();
        });
      });

      // === SUBSCRIBE ===
      subscribeBtn.addEventListener('click', async () => {
        try {
          const res = await fetch(`${API_URL}/create-checkout-session`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: userEmail })
          });
          const { url } = await res.json();
          window.location.href = url;
        } catch (err) {
          alert('Checkout failed. Please try again.');
        }
      });
    }
  </script>
</body>
</html>